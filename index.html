<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>KIN 100 Review — Shoulder & Arm (Flashcards + MCQ)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* =========================
       Dark‑blue ocean theme
       ========================= */
    :root{
      --bg:#041b2d; --fg:#e6f3ff; --muted:#a8c5da; --surface:#071e31; --border:#0c304a;
      --accent:#38bdf8; --accent-2:#22d3ee; --ok:#22c55e; --err:#ef4444;
      --focus:2px solid #38bdf8; --radius:16px; --shadow:0 10px 28px rgba(10, 84, 126, .25);

      /* Buttons: high contrast */
      --btn-main:#0ea5e9; --btn-text:#00131c;
      --btn-ghost:#0c2a42; --btn-ghost-text:#d8f3ff;
      --btn-good:#1f9d55; --btn-bad:#b91c1c;

      --font:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family:var(--font); line-height:1.5;
    }

    /* Ocean background (subtle) */
    .ocean{position:fixed; inset:0; z-index:0; pointer-events:none;
      background:linear-gradient(180deg,#06263e 0%, #082e4a 60%, #0b2842 100%);
      animation:bgShift 40s ease-in-out infinite;
    }
    @keyframes bgShift{
      0%,100%{filter:saturate(1) brightness(1)}
      50%{filter:saturate(1.05) brightness(1.05)}
    }
    .ocean .wave{
      position:absolute; left:0; right:0; bottom:-2px; height:120px;
      background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120"><path d="M0,70 C200,0 400,140 600,70 S1000,0 1200,70 V120 H0 Z" fill="%23ffffff22"/></svg>') repeat-x;
      background-size:1200px 120px; animation:waveX 28s linear infinite; opacity:.18;
    }
    .ocean .wave.wave2{height:140px; bottom:-10px; opacity:.12; animation-duration:36s}
    @keyframes waveX{from{background-position-x:0}to{background-position-x:1200px}}

    /* A few faint bubbles */
    .ocean .bubble{
      position:absolute; bottom:-8vh; border-radius:50%;
      background:rgba(255,255,255,.14); filter:blur(.4px);
      left:var(--x,50%); width:var(--s,8px); height:var(--s,8px);
      animation:rise var(--t,14s) linear infinite; opacity:.9;
    }
    @keyframes rise{to{transform:translateY(-120vh); opacity:0}}
    body.reduced-motion .ocean .wave,
    body.reduced-motion .ocean .bubble,
    body.reduced-motion .ocean{animation:none}

    header{position:sticky;top:0;z-index:3;
      background:linear-gradient(90deg, rgba(5,23,38,.85), rgba(7,30,49,.75));
      border-bottom:1px solid var(--border); padding:14px 16px; backdrop-filter:saturate(1.1) blur(2px);
    }
    header .title{font-weight:800;font-size:1.1rem}
    header .subtitle{color:var(--muted);font-size:.95rem}

    .container{max-width:980px;margin:16px auto;padding:0 16px; position:relative; z-index:1}
    .bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin:12px 0 18px}

    .tabs[role="tablist"]{display:flex;gap:6px;padding:6px;background:var(--surface);border:1px solid var(--border);border-radius:999px; box-shadow:var(--shadow)}
    .tabs button{border:0;background:none;padding:10px 14px;border-radius:999px;cursor:pointer;color:var(--muted);font-weight:700}
    .tabs button[aria-selected="true"]{background:var(--accent);color:#00131c; box-shadow:0 8px 18px rgba(14,165,233,.35)}

    .session{display:flex;flex-wrap:wrap;gap:8px;align-items:center}

    .panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}

    /* ===== Flashcards ===== */
    .flash-wrap{display:grid;gap:14px}
    .card{ position:relative; padding:18px; border-radius:20px; border:1px solid var(--border);
           background:var(--surface); box-shadow:var(--shadow); overflow:hidden }
    .plate{
      --card-accent:#f7c948; background:#fff; color:#111;
      border:6px solid var(--card-accent); border-radius:18px; position:relative; min-height:210px;
    }
    .plate .text{
      position:absolute; left:18px; right:18px; top:22px; bottom:64px;
      display:flex; align-items:center; justify-content:center; text-align:center; padding:4px;
      font-size:1.12rem; line-height:1.45; transition:opacity .28s ease;
    }
    .text-front{opacity:1} .text-back{opacity:0}
    .card.showBack .text-front{opacity:0} .card.showBack .text-back{opacity:1}
    .hint{position:absolute; left:0; right:0; bottom:66px; text-align:center; color:#8a8a8a; font-size:.95rem}
    .labelbar{
      position:absolute; left:0; right:0; bottom:0; height:58px;
      border-top:1px solid rgba(0,0,0,.06); background:#fff; border-radius:0 0 12px 12px;
      display:flex; align-items:center; justify-content:center; font-weight:800; font-size:1.02rem; color:#111;
    }
    .tagdot{display:inline-block; width:.66em; height:.66em; border-radius:999px; margin:0 .25em -.08em 0; background:var(--card-accent)}

    /* Flip shell (text cross‑fades; shell rotates) */
    .flipFx{ position:absolute; inset:18px; border-radius:18px; pointer-events:none; transform-style:preserve-3d; }
    .flipFx::before{
      content:""; position:absolute; inset:0; background:#fff; border:6px solid var(--card-accent); border-radius:18px;
      transform-origin:center; transform:rotateY(0); opacity:0;
    }
    .card.flip-anim .flipFx::before{ animation:flipShell .5s ease both }
    @keyframes flipShell{0%{transform:rotateY(0);opacity:.15}45%{opacity:.45}100%{transform:rotateY(180deg);opacity:0}}

    /* Buttons — strong contrast */
    .flash-actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .btn{border:0;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:800;
         background:var(--btn-main); color:var(--btn-text); letter-spacing:.2px;
         box-shadow:0 8px 18px rgba(2,132,199,.38); transition:transform .05s ease, box-shadow .15s ease}
    .btn:hover{transform:translateY(-1px); box-shadow:0 12px 22px rgba(2,132,199,.45)}
    .btn:active{transform:translateY(0); box-shadow:0 6px 12px rgba(2,132,199,.3)}
    .btn.ghost{background:var(--btn-ghost); color:var(--btn-ghost-text); box-shadow:0 6px 14px rgba(12,74,110,.25)}
    .btn.good{background:var(--btn-good); color:#fff; box-shadow:0 8px 18px rgba(22,163,74,.35)}
    .btn.bad{background:var(--btn-bad); color:#fff; box-shadow:0 8px 18px rgba(220,38,38,.35)}
    .btn.primary{background:var(--accent); color:#00131c}
    .session .btn{padding:8px 12px}

    .stats{display:flex;gap:12px;justify-content:center;color:var(--muted);font-size:.95rem}
    .barline{height:10px;background:#093b58;border-radius:999px;overflow:hidden}
    .barline>span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent-2))}

    /* MCQ */
    .q-wrap{display:grid;gap:14px}
    .choice{
      display:flex;gap:10px;align-items:flex-start;border:1px solid var(--border);border-radius:12px;padding:10px 12px;cursor:pointer;background:#fff; color:#111;
    }
    .choice[data-state="correct"]{border-color:var(--ok);box-shadow:0 0 0 2px rgba(34,197,94,.25) inset}
    .choice[data-state="wrong"]{border-color:var(--err);box-shadow:0 0 0 2px rgba(239,68,68,.2) inset}
    .rationale{border-left:4px solid var(--accent);padding:10px 12px;background:#f0fbff;border-radius:10px;color:#06263e}

    /* Toast + confetti + shuffle minis */
    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);
           background:#07304a;color:#e6f3ff;padding:8px 12px;border-radius:999px;font-size:.9rem;opacity:0;transition:opacity .25s ease;z-index:9999}
    .toast.show{opacity:1}
    .confetti{position:fixed;pointer-events:none;inset:0;overflow:hidden;z-index:1000}
    .bit{position:absolute;font-size:18px;animation:fall 900ms ease-out forwards}
    @keyframes fall{from{transform:translateY(0) rotate(0deg);opacity:1}to{transform:translateY(120vh) rotate(540deg);opacity:0}}
    body.reduced-motion .bit{animation:none;opacity:0}

    .shuffle-overlay{position:absolute; inset:0; pointer-events:none; display:none; z-index:5;}
    .shuffle-overlay.show{ display:block; }
    .mini-card{
      position:absolute; width:64px; height:42px; border-radius:8px; background:#fff;
      border:1px solid var(--border); box-shadow:var(--shadow); opacity:0;
      left:50%; top:50%; transform:translate(-200%,-50%) rotate(0deg);
      animation: riffle 650ms ease-in-out forwards;
    }
    @keyframes riffle {
      0%   { transform:translate(-200%,-50%) rotate(var(--rot,0deg)); opacity:0 }
      50%  { transform:translate(-50%,-50%) rotate(calc(var(--rot,0deg) + 8deg)); opacity:1 }
      100% { transform:translate(110%,-50%) rotate(calc(var(--rot,0deg) + 18deg)); opacity:0 }
    }

    .hidden{display:none !important}
    :focus-visible{outline:var(--focus);outline-offset:2px}

    /* =============== Modals with BLUR background =============== */
    .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(6, 34, 54, .35);
           z-index:2000; backdrop-filter: blur(8px) saturate(1.05);}
    .modal.show{display:grid}
    .modal .box{
      width:min(560px,92vw); background:var(--surface); color:var(--fg); border:1px solid var(--border);
      border-radius:16px; box-shadow:0 18px 44px rgba(3,105,161,.35); padding:18px 16px 14px;
    }
    .modal h2{margin:6px 0 10px}
    .modal .row{display:flex;flex-wrap:wrap;gap:10px;margin:10px 0}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);
          cursor:pointer;background:#0c2a42;color:#e6f3ff;font-weight:700}
    .chip input{width:18px;height:18px}

    /* Blur the whole page when modal is open */
    body.modal-open header,
    body.modal-open #main,
    body.modal-open footer{ filter: blur(6px) saturate(.9); transition: filter .2s ease }
    body.modal-open{ overflow:hidden }
  </style>
</head>
<body>
  <!-- Subtle ocean background -->
  <div class="ocean" aria-hidden="true">
    <div class="wave"></div><div class="wave wave2"></div>
    <span class="bubble" style="--x:18%;--s:8px;--t:14s"></span>
    <span class="bubble" style="--x:42%;--s:10px;--t:16s"></span>
    <span class="bubble" style="--x:66%;--s:7px;--t:13s"></span>
    <span class="bubble" style="--x:82%;--s:9px;--t:15s"></span>
  </div>

  <a href="#main" class="skip">Skip to content</a>
  <header>
    <div class="container">
      <div class="title">KIN 100 Review — Shoulder &amp; Arm</div>
      <div class="subtitle">Flashcards &amp; MCQ • text‑only v1</div>
    </div>
  </header>

  <div class="container" id="main">
    <div class="bar">
      <div class="tabs" role="tablist" aria-label="Mode">
        <button id="tab-flash" role="tab" aria-selected="true" aria-controls="flashcardsPanel">Flashcards</button>
        <button id="tab-mcq" role="tab" aria-selected="false" aria-controls="mcqPanel">MCQ</button>
      </div>

      <!-- No filters here anymore -->
      <div class="session">
        <label><input type="checkbox" id="rmToggle"> Reduced motion</label>
        <button class="btn ghost" id="changeTopics">Change topics</button>
        <label><input type="checkbox" id="soundToggle" checked> Sound</label>
      </div>
    </div>

    <!-- Flashcards -->
    <section id="flashcardsPanel" class="panel flash-wrap" role="tabpanel" aria-labelledby="tab-flash">
      <div class="bar" style="justify-content:center; gap:14px">
        <button class="btn ghost" id="flashShuffle">Shuffle</button>
        <button class="btn ghost" id="flashReset">Reset</button>
      </div>

      <div class="card" id="flashCard" aria-live="polite" aria-atomic="true">
        <div class="flipFx" id="flipFx" aria-hidden="true"></div>
        <div class="plate" id="plate">
          <div class="text text-front" id="flashFront">Building deck…</div>
          <div class="text text-back" id="flashBack"></div>
          <div class="hint" id="hint">Press Space or click card to flip</div>
          <div class="labelbar"><span class="tagdot"></span><span id="labelTxt">KIN 100</span></div>
        </div>
        <div class="shuffle-overlay" id="shuffleOverlay" aria-hidden="true"></div>
      </div>

      <div class="flash-actions" aria-label="Flashcard actions">
        <button class="btn" id="flashFlip" title="Space to flip">Flip</button>
        <button class="btn bad" id="flashAgain" title="A key">Again</button>
        <button class="btn good" id="flashGot" title="G key">Got it</button>
      </div>

      <div class="stats">
        <div>Deck: <span id="deckCount">0</span></div>
        <div>Remaining: <span id="deckRemaining">0</span></div>
        <div>Streak: <span id="streak">0</span> 🔥</div>
      </div>
      <div class="barline" aria-hidden="true"><span id="progressFill"></span></div>
    </section>

    <!-- MCQ -->
    <section id="mcqPanel" class="panel q-wrap hidden" role="tabpanel" aria-labelledby="tab-mcq">
      <div class="bar" style="justify-content:space-between">
        <div>
          <label>Mode:
            <select id="mcqMode">
              <option value="practice">Practice (endless)</option>
              <option value="quiz">Quiz</option>
            </select>
          </label>
          <label id="quizLenWrap" class=""><span style="margin-left:8px"># Q:</span>
            <input type="number" id="quizLen" min="5" max="30" step="1" value="10" style="width:72px">
          </label>
        </div>
        <div>
          <button class="btn primary" id="mcqStart">Start</button>
          <button class="btn ghost" id="mcqStop">Stop</button>
        </div>
      </div>

      <div id="mcqStatus" class="stats" aria-live="polite"></div>

      <div id="mcqQ" class="panel">
        <div id="mcqStem" style="font-size:1.1rem; font-weight:700; margin-bottom:8px">Press Start</div>
        <div id="mcqChoices" class="choices" role="group" aria-label="Choices"></div>
        <div id="mcqRationale" class="rationale hidden"></div>
        <div class="bar" style="justify-content:space-between; margin-top:6px">
          <div><span class="score" id="mcqScore">0/0</span></div>
          <div><button class="btn" id="mcqNext" title="N key">Next</button></div>
        </div>
      </div>
    </section>
  </div>

  <!-- On‑launch modal (two steps) -->
  <div class="modal" id="startModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="box">
      <h2 id="modalTitle">What would you like to study?</h2>

      <div id="step1">
        <strong>Step 1 — Region(s)</strong>
        <div class="row">
          <label class="chip"><input type="checkbox" data-choice="region" value="shoulder" checked>Shoulder</label>
          <label class="chip"><input type="checkbox" data-choice="region" value="arm" checked>Arm</label>
        </div>
        <div class="actions" style="display:flex;gap:10px;justify-content:flex-end;margin-top:14px">
          <button class="btn primary" id="toStep2">Next</button>
        </div>
      </div>

      <div id="step2" class="hidden">
        <strong>Step 2 — Topic(s)</strong>
        <div class="row">
          <label class="chip"><input type="checkbox" data-choice="domain" value="bones" checked>Bones</label>
          <label class="chip"><input type="checkbox" data-choice="domain" value="muscles" checked>Muscles</label>
          <label class="chip"><input type="checkbox" data-choice="domain" value="innervation" checked>Nerves</label>
          <label class="chip"><input type="checkbox" data-choice="domain" value="blood" checked>Blood supply</label>
        </div>
        <div class="actions" style="display:flex;gap:10px;justify-content:flex-end;margin-top:14px">
          <button class="btn" id="backTo1">Back</button>
          <button class="btn primary" id="startStudy">Start</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite" aria-atomic="true"></div>
  <div class="confetti" id="confetti" aria-hidden="true"></div>

  <script>
    const BUILD = 'v1.6-ocean-darkblue-no-filterbar';
    window.addEventListener('error', e => {
      const t = document.getElementById('toast');
      if (t) { t.textContent = '⚠️ JS error: ' + e.message; t.classList.add('show'); }
      console.error('Build', BUILD, e.message, e);
    });

    /* ===== Data ===== */
    const BANK = [
      {type:"flash",tags:["shoulder","muscles","innervation"],front:"Deltoid — innervation?",back:"Axillary nerve (C5–C6)."},
      {type:"flash",tags:["shoulder","muscles"],front:"Deltoid (middle fibers) — primary action?",back:"Shoulder abduction (~15–90°)."},
      {type:"flash",tags:["shoulder","muscles","innervation"],front:"Teres minor — action + innervation?",back:"External (lateral) rotation; axillary nerve."},
      {type:"flash",tags:["shoulder","muscles","innervation"],front:"Supraspinatus — role + innervation?",back:"Initiates abduction (0–15°); suprascapular nerve."},
      {type:"flash",tags:["shoulder","muscles","innervation"],front:"Infraspinatus — action + innervation?",back:"External rotation; suprascapular nerve."},
      {type:"flash",tags:["shoulder","muscles","innervation"],front:"Subscapularis — action + innervation?",back:"Internal (medial) rotation; upper & lower subscapular nerves."},
      {type:"flash",tags:["shoulder","muscles"],front:"Rotator cuff muscles (SITS)?",back:"Supraspinatus, Infraspinatus, Teres minor, Subscapularis."},
      {type:"flash",tags:["arm","muscles","innervation"],front:"Biceps brachii — major actions + nerve?",back:"Forearm supination; elbow flexion (best when supinated); musculocutaneous nerve (C5–C7)."},
      {type:"flash",tags:["arm","muscles","innervation"],front:"Brachialis — action + nerve?",back:"Primary elbow flexor; musculocutaneous nerve (C5–C6)."},
      {type:"flash",tags:["arm","muscles","innervation"],front:"Coracobrachialis — action + nerve?",back:"Flexes & adducts shoulder; pierced by musculocutaneous nerve."},
      {type:"flash",tags:["arm","muscles","innervation"],front:"Triceps brachii — action + nerve?",back:"Elbow extension; long head assists shoulder extension/adduction; radial nerve (C6–C8)."},
      {type:"flash",tags:["shoulder","muscles","innervation"],front:"Serratus anterior — nerve + key function?",back:"Long thoracic nerve (C5–C7); protracts & upwardly rotates scapula; stabilizes against thorax."},
      {type:"flash",tags:["shoulder","muscles","innervation"],front:"Latissimus dorsi — nerve?",back:"Thoracodorsal nerve (C6–C8)."},
      {type:"flash",tags:["shoulder","muscles","innervation"],front:"Pectoralis major — nerves?",back:"Medial & lateral pectoral nerves; adducts & internally rotates shoulder."},
      {type:"flash",tags:["shoulder","muscles","innervation"],front:"Pectoralis minor — attachments + nerve?",back:"Ribs 3–5 → coracoid; stabilizes scapula; medial pectoral nerve."},
      {type:"flash",tags:["arm","bones"],front:"Deltoid tuberosity — what & where?",back:"Lateral humerus; insertion for deltoid."},
      {type:"flash",tags:["arm","bones","innervation"],front:"Surgical neck of humerus — clinical relevance?",back:"Risk to axillary nerve & posterior circumflex humeral artery."},
      {type:"flash",tags:["arm","bones","innervation"],front:"Midshaft humerus fracture — key nerve risk?",back:"Radial nerve in radial groove → wrist drop."},
      {type:"flash",tags:["shoulder","bones","blood"],front:"Quadrangular space — contents?",back:"Axillary nerve & posterior circumflex humeral artery."},
      {type:"flash",tags:["arm","bones","blood"],front:"Triangular interval — contents?",back:"Radial nerve & profunda brachii (deep brachial) artery."},
      {type:"flash",tags:["arm","bones"],front:"Intertubercular (bicipital) groove — notable content?",back:"Tendon of long head of biceps brachii."},
      {type:"flash",tags:["shoulder","bones"],front:"Long head of biceps — origin?",back:"Supraglenoid tubercle of scapula."},
      {type:"flash",tags:["shoulder","bones"],front:"Short head of biceps — origin?",back:"Coracoid process of scapula."},
      {type:"flash",tags:["shoulder","bones"],front:"Long head of triceps — origin?",back:"Infraglenoid tubercle of scapula."},
      {type:"flash",tags:["arm","innervation"],front:"Musculocutaneous nerve — terminal sensory branch?",back:"Lateral cutaneous nerve of forearm."},
      {type:"flash",tags:["shoulder","innervation"],front:"Axillary nerve — sensory patch?",back:"“Regimental badge” area over lateral deltoid."},
      {type:"flash",tags:["arm","blood"],front:"Main artery of the posterior compartment of the arm?",back:"Profunda brachii (deep brachial) artery via radial collateral branches."},

      /* MCQ */
      {type:"mcq",tags:["shoulder","innervation"],stem:"Which nerve innervates the deltoid muscle?",options:["Radial","Axillary","Musculocutaneous","Median"],answerIndex:1,rationale:"Deltoid (and teres minor) receive axillary nerve (C5–C6)."},
      {type:"mcq",tags:["shoulder","muscles"],stem:"Which muscle initiates glenohumeral abduction (0–15°)?",options:["Supraspinatus","Deltoid","Infraspinatus","Subscapularis"],answerIndex:0,rationale:"Supraspinatus initiates the first degrees of abduction."},
      {type:"mcq",tags:["arm","innervation"],stem:"The anterior compartment of the arm is primarily innervated by which nerve?",options:["Radial","Ulnar","Musculocutaneous","Axillary"],answerIndex:2,rationale:"Biceps brachii, brachialis, coracobrachialis are musculocutaneous."},
      {type:"mcq",tags:["arm","innervation","bones"],stem:"A fracture of the surgical neck of the humerus endangers which nerve?",options:["Radial","Median","Axillary","Ulnar"],answerIndex:2,rationale:"Axillary nerve + PCHA wrap the surgical neck."},
      {type:"mcq",tags:["arm","innervation","bones"],stem:"A midshaft humeral fracture classically injures which nerve?",options:["Ulnar","Radial","Musculocutaneous","Axillary"],answerIndex:1,rationale:"Radial nerve in radial groove → wrist/finger extensor weakness."},
      {type:"mcq",tags:["arm","muscles","bones"],stem:"Which muscle inserts on the deltoid tuberosity?",options:["Deltoid","Teres major","Latissimus dorsi","Pectoralis major"],answerIndex:0,rationale:"Deltoid inserts on the deltoid tuberosity."},
      {type:"mcq",tags:["shoulder","bones","blood"],stem:"Which structure passes through the quadrangular space with the posterior circumflex humeral artery?",options:["Radial nerve","Axillary nerve","Musculocutaneous nerve","Ulnar nerve"],answerIndex:1,rationale:"Quadrangular space: axillary nerve + PCHA."},
      {type:"mcq",tags:["shoulder","innervation","muscles"],stem:"Injury to the long thoracic nerve primarily weakens which muscle?",options:["Rhomboid major","Serratus anterior","Trapezius","Latissimus dorsi"],answerIndex:1,rationale:"Long thoracic → serratus anterior; winged scapula."},
      {type:"mcq",tags:["shoulder","muscles"],stem:"Which is an external (lateral) rotator of the shoulder?",options:["Subscapularis","Teres major","Infraspinatus","Pectoralis major"],answerIndex:2,rationale:"Infraspinatus (and teres minor) laterally rotate."},
      {type:"mcq",tags:["shoulder","bones","muscles"],stem:"The tendon traveling in the intertubercular (bicipital) groove belongs to:",options:["Biceps long head","Biceps short head","Triceps long head","Brachialis"],answerIndex:0,rationale:"Long head of biceps tendon runs in the groove."},
      {type:"mcq",tags:["arm","innervation"],stem:"Innervation of triceps brachii?",options:["Radial","Axillary","Musculocutaneous","Median"],answerIndex:0,rationale:"All heads by radial nerve."},
      {type:"mcq",tags:["arm","bones","blood"],stem:"Artery accompanying the radial nerve through the triangular interval:",options:["Posterior circumflex humeral","Profunda brachii (deep brachial)","Anterior circumflex humeral","Radial recurrent"],answerIndex:1,rationale:"Triangular interval: radial nerve + profunda brachii artery."},
      {type:"mcq",tags:["shoulder","muscles"],stem:"Latissimus dorsi does all EXCEPT:",options:["Adduction","Internal rotation","Abduction","Extension"],answerIndex:2,rationale:"Lat adducts, extends, medially rotates; not abduction."},
      {type:"mcq",tags:["shoulder","innervation"],stem:"Cutaneous sensation over the 'regimental badge' area is from:",options:["Radial","Axillary","Suprascapular","Lateral pectoral"],answerIndex:1,rationale:"Superior lateral cutaneous nerve of arm (axillary)."},
      {type:"mcq",tags:["shoulder","bones","innervation"],stem:"Axillary nerve arises from which cord?",options:["Lateral","Medial","Posterior","Superior trunk"],answerIndex:2,rationale:"Axillary and radial from posterior cord."},
      {type:"mcq",tags:["shoulder","bones","muscles"],stem:"Origin on supraglenoid tubercle:",options:["Triceps long head","Biceps long head","Biceps short head","Teres minor"],answerIndex:1,rationale:"Biceps long head from supraglenoid; triceps long head from infraglenoid."}
    ];

    /* ===== Helpers & state ===== */
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const REGIONS = ['shoulder','arm'];
    const DOMAINS = ['muscles','bones','innervation','blood'];
    let activeFilters = new Set([...REGIONS, ...DOMAINS]);

    const ACCENTS = { shoulder:'#f7c948', arm:'#f8a3c9' };

    const rnd = n => Math.floor(Math.random()*n);
    const shuffle = arr => { const a=[...arr]; for(let i=a.length-1;i>0;i--){const j=rnd(i+1); [a[i],a[j]]=[a[j],a[i]];} return a; };
    const intersects = (a,b) => a.some(x => b.includes(x));
    const matchesFilters = (item) => {
      const itemTags = item.tags||[];
      const selRegions = REGIONS.filter(t => activeFilters.has(t));
      const selDomains = DOMAINS.filter(t => activeFilters.has(t));
      const itemRegions = itemTags.filter(t=>REGIONS.includes(t));
      const itemDomains = itemTags.filter(t=>DOMAINS.includes(t));
      const regionOK = itemRegions.length===0 || intersects(itemRegions, selRegions);
      const domainOK = itemDomains.length===0 || intersects(itemDomains, selDomains);
      return regionOK && domainOK;
    };

    function say(msg){
      const t = $('#toast');
      t.textContent = msg;
      t.classList.add('show');
      clearTimeout(say._t);
      say._t = setTimeout(()=>t.classList.remove('show'), 1500);
    }
    function confettiBurst(){
      if(document.body.classList.contains('reduced-motion')) return;
      const ems = ['🎉','💪','🦴','⭐','🌊'];
      const c = $('#confetti');
      for(let i=0;i<16;i++){
        const b = document.createElement('span');
        b.className='bit';
        b.textContent = ems[rnd(ems.length)];
        b.style.left = (5 + Math.random()*90) + 'vw';
        b.style.top = '-10vh';
        b.style.animationDelay = (Math.random()*0.2) + 's';
        c.appendChild(b);
        setTimeout(()=>b.remove(), 1000);
      }
    }

    /* ===== Simple audio (shuffle) ===== */
    let soundOn = true;
    let actx = null;
    function getCtx(){ if(!actx) actx = new (window.AudioContext||window.webkitAudioContext)(); return actx; }
    function playShuffleSound(){
      if(!soundOn) return;
      const ctx = getCtx(); const now = ctx.currentTime;
      const dur = .35, frames = Math.floor(ctx.sampleRate*dur);
      const buf = ctx.createBuffer(1, frames, ctx.sampleRate);
      const data = buf.getChannelData(0);
      for(let i=0;i<frames;i++){ data[i] = (Math.random()*2-1)*0.6; }
      const src = ctx.createBufferSource(); src.buffer = buf;
      const bp = ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=900; bp.Q.value=0.7;
      const g = ctx.createGain(); g.gain.setValueAtTime(0, now);
      g.gain.linearRampToValueAtTime(0.9, now + 0.05);
      g.gain.exponentialRampToValueAtTime(0.001, now + dur);
      src.connect(bp).connect(g).connect(ctx.destination); src.start(now);
    }

    /* ===== Shuffle animation ===== */
    function createMiniCard(delayMs, rotDeg){
      const el = document.createElement('div'); el.className='mini-card';
      el.style.setProperty('--rot', rotDeg + 'deg'); el.style.animationDelay = delayMs + 'ms';
      return el;
    }
    function animateShuffle(duration=700){
      return new Promise(resolve=>{
        const overlay = $('#shuffleOverlay'); overlay.innerHTML = ''; overlay.classList.add('show');
        for(let i=0;i<10;i++){ const d=40*i; const r=-6+Math.random()*12; overlay.appendChild(createMiniCard(d,r)); }
        setTimeout(()=>{ overlay.classList.remove('show'); overlay.innerHTML=''; resolve(); }, duration);
      });
    }

    /* ===== Controls (no filter bar) ===== */
    $('#rmToggle').addEventListener('change', (e)=> document.body.classList.toggle('reduced-motion', e.target.checked));
    $('#soundToggle').addEventListener('change', (e)=> soundOn = e.target.checked);
    $('#changeTopics').addEventListener('click', ()=> openModal(1));

    /* ===== Tabs ===== */
    const tabs = {
      flash: {btn: $('#tab-flash'), panel: $('#flashcardsPanel')},
      mcq:   {btn: $('#tab-mcq'),   panel: $('#mcqPanel')}
    };
    Object.values(tabs).forEach(o=>{
      o.btn.addEventListener('click', ()=>{
        Object.values(tabs).forEach(p=>{p.btn.setAttribute('aria-selected','false'); p.panel.classList.add('hidden'); p.panel.setAttribute('hidden','');});
        o.btn.setAttribute('aria-selected','true');
        o.panel.classList.remove('hidden'); o.panel.removeAttribute('hidden');
      });
    });

    /* ===== Flashcards ===== */
    let flashDeck=[]; let deckIndex=0; let showBack=false; let streak=0;

    function currentFlash(){ return flashDeck[deckIndex] || null; }
    function setAccentFor(item){
      const tags=item.tags||[];
      const color=tags.includes('shoulder')?ACCENTS.shoulder:(tags.includes('arm')?ACCENTS.arm:'#0ea5e9');
      $('#plate').style.setProperty('--card-accent', color);
      $('.tagdot').style.background=color;
    }
    function setLabel(item){
      const tags=(item.tags||[]).filter(t=>REGIONS.includes(t) || DOMAINS.includes(t));
      $('#labelTxt').textContent = tags.join(' • ') || 'KIN 100';
    }
    function updateFlashUI(announce){
      const front=$('#flashFront'), back=$('#flashBack'), card=$('#flashCard');
      $('#streak').textContent=String(streak);
      $('#deckCount').textContent=flashDeck.length;
      const remain=flashDeck.length?(flashDeck.length-deckIndex):0;
      $('#deckRemaining').textContent=String(remain);
      const pct=flashDeck.length?Math.round((deckIndex/flashDeck.length)*100):0;
      $('#progressFill').style.width=pct+'%';

      if(!flashDeck.length){
        front.innerHTML="No flashcards match your topics.<br><small>Use <strong>Change topics</strong> to adjust.</small>";
        back.textContent=""; setLabel({tags:[]}); card.classList.remove('showBack'); return;
      }
      const item=currentFlash();
      front.innerHTML=item.front; back.textContent=item.back;
      setAccentFor(item); setLabel(item);
      card.classList.toggle('showBack', showBack);
      if(announce) say("Deck ready · "+flashDeck.length+" cards");
    }
    function buildDeck(){
      const pool=BANK.filter(it=>it.type==='flash' && matchesFilters(it));
      flashDeck=shuffle(pool); deckIndex=0; showBack=false; streak=0;
    }
    function refreshFlashDeck(announce){ buildDeck(); updateFlashUI(announce); }
    function nextFlash(){
      deckIndex++; showBack=false;
      if(deckIndex>=flashDeck.length){
        $('#flashFront').innerHTML="🎯 Deck complete — smooth work.";
        $('#flashBack').textContent=""; $('#flashCard').classList.remove('showBack'); confettiBurst(); return;
      }
      updateFlashUI(false);
    }
    function againFlash(){
      const item=currentFlash(); if(!item) return;
      const insertAt=Math.min(flashDeck.length, deckIndex+3+Math.floor(Math.random()*3));
      flashDeck.splice(insertAt,0,item); deckIndex++; streak=0; say("One more rep."); updateFlashUI(false);
    }
    function gotFlash(){
      const item=currentFlash(); if(!item) return;
      flashDeck.splice(deckIndex,1); streak++; if(streak>0 && streak%5===0) confettiBurst();
      say("Nice rep."); updateFlashUI(false);
      if(deckIndex>=flashDeck.length){
        $('#flashFront').innerHTML="🎯 Deck complete — clean set."; $('#flashBack').textContent=""; $('#flashCard').classList.remove('showBack');
      }
    }
    function flipWithFx(){
      const card=$('#flashCard'); card.classList.add('flip-anim');
      showBack=!showBack; updateFlashUI(false); setTimeout(()=>card.classList.remove('flip-anim'),520);
    }

    $('#flashCard').addEventListener('click', flipWithFx);
    $('#flashFlip').addEventListener('click', flipWithFx);
    $('#flashShuffle').addEventListener('click', async ()=>{ playShuffleSound(); await animateShuffle(700); refreshFlashDeck(true); });
    $('#flashReset').addEventListener('click', async ()=>{ playShuffleSound(); await animateShuffle(700); refreshFlashDeck(true); });
    $('#flashAgain').addEventListener('click', againFlash);
    $('#flashGot').addEventListener('click', gotFlash);
    document.addEventListener('keydown', (e)=>{
      const flashActive=$('#tab-flash').getAttribute('aria-selected')==='true';
      if(!flashActive) return;
      if(e.key===' '){ e.preventDefault(); flipWithFx(); }
      if(e.key.toLowerCase()==='a'){ $('#flashAgain').click(); }
      if(e.key.toLowerCase()==='g'){ $('#flashGot').click(); }
      if(e.key==='ArrowRight'){ nextFlash(); }
    });

    /* ===== MCQ ===== */
    let mcqSession=null;
    const qStem=$('#mcqStem'), qChoices=$('#mcqChoices'), qRat=$('#mcqRationale'), qScore=$('#mcqScore'), qStatus=$('#mcqStatus');

    function mcqStart(){
      const mode=$('#mcqMode').value;
      const pool=BANK.filter(it=>it.type==='mcq' && matchesFilters(it));
      if(!pool.length){ qStem.textContent="No MCQs match your topics. Use Change topics."; qChoices.innerHTML=''; qRat.classList.add('hidden'); return; }
      let list=shuffle(pool);
      if(mode==='quiz'){
        const n=Math.max(5, Math.min(parseInt($('#quizLen').value||10,10), 30));
        if(list.length>n) list=list.slice(0,n);
      }
      mcqSession={ mode, list, idx:0, score:0, total:0, answered:false };
      say("Quiz loaded · "+list.length+" Q"); renderMCQ();
    }
    function mcqStop(){ mcqSession=null; qStem.textContent="Press Start"; qChoices.innerHTML=''; qRat.classList.add('hidden'); qScore.textContent="0/0"; qStatus.textContent=""; }
    function renderMCQ(){
      if(!mcqSession) return;
      const {list, idx, score, total}=mcqSession;
      if(idx>=list.length){
        qStem.innerHTML="🎉 Session complete."; qChoices.innerHTML=''; qRat.classList.add('hidden'); qScore.textContent=`${score}/${total}`;
        qStatus.textContent="Nice pace — run another set."; confettiBurst(); return;
      }
      const item=list[idx]; mcqSession.answered=false;
      qStem.textContent=item.stem; qChoices.innerHTML='';
      const shuffled=shuffle(item.options.map((opt,i)=>({opt,i})));
      qRat.textContent=item.rationale||""; qRat.classList.add('hidden');

      shuffled.forEach((o,k)=>{
        const id=`opt-${idx}-${k}`;
        const wrap=document.createElement('label');
        wrap.className='choice'; wrap.setAttribute('data-state','idle');
        wrap.innerHTML=`<input type="radio" name="mcq" id="${id}" value="${o.i}"><div><strong>${k+1}.</strong> <span>${o.opt}</span></div>`;
        wrap.addEventListener('click', ()=>{
          if(mcqSession.answered) return;
          const chosen=parseInt(wrap.querySelector('input').value,10);
          mcqSession.answered=true; const correct=chosen===item.answerIndex;
          mcqSession.total++; if(correct){ mcqSession.score++; wrap.dataset.state='correct'; say("Correct."); } else { wrap.dataset.state='wrong'; say("Not quite."); }
          $$('#mcqChoices .choice').forEach(ch=>{
            const val=parseInt(ch.querySelector('input').value,10);
            if(val===item.answerIndex){ ch.dataset.state='correct'; }
            ch.querySelector('input').disabled=true;
          });
          qRat.classList.remove('hidden');
          qScore.textContent=`${mcqSession.score}/${mcqSession.total}`;
        });
        qChoices.appendChild(wrap);
      });
      qStatus.textContent=`Q ${idx+1} of ${list.length}`;
    }
    $('#mcqNext').addEventListener('click', ()=>{ if(!mcqSession) return; mcqSession.idx++; renderMCQ(); });
    $('#mcqStart').addEventListener('click', mcqStart);
    $('#mcqStop').addEventListener('click', mcqStop);
    $('#mcqMode').addEventListener('change', (e)=> $('#quizLenWrap').style.visibility = e.target.value==='quiz' ? 'visible' : 'hidden');

    /* ===== Modal logic (two steps) ===== */
    const modal=$('#startModal'); const step1=$('#step1'), step2=$('#step2');
    function openModal(step=1){ modal.classList.add('show'); document.body.classList.add('modal-open'); (step===1 ? (step1.classList.remove('hidden'), step2.classList.add('hidden')) : (step2.classList.remove('hidden'), step1.classList.add('hidden'))); }
    function closeModal(){ modal.classList.remove('show'); document.body.classList.remove('modal-open'); }

    $('#toStep2').addEventListener('click', ()=>{
      const regions = Array.from(modal.querySelectorAll('input[data-choice="region"]:checked')).map(x=>x.value);
      if(regions.length===0){ say('Pick at least one region.'); return; }
      step1.classList.add('hidden'); step2.classList.remove('hidden');
    });
    $('#backTo1').addEventListener('click', ()=>{ step2.classList.add('hidden'); step1.classList.remove('hidden'); });

    function applySelectionsFromModal(){
      const regions = Array.from(modal.querySelectorAll('input[data-choice="region"]:checked')).map(x=>x.value);
      const domains = Array.from(modal.querySelectorAll('input[data-choice="domain"]:checked')).map(x=>x.value);
      if(regions.length===0 || domains.length===0){ say('Select at least one region and one topic.'); return false; }
      activeFilters = new Set([...regions, ...domains]);
      refreshFlashDeck(true); mcqStop();
      return true;
    }
    $('#startStudy').addEventListener('click', ()=>{ if(applySelectionsFromModal()) closeModal(); });

    /* ===== Init ===== */
    try{
      openModal(1);
      $('#quizLenWrap').style.visibility = $('#mcqMode').value==='quiz' ? 'visible' : 'hidden';
      refreshFlashDeck(true);
    }catch(err){
      window.dispatchEvent(new ErrorEvent('error',{message:err.message}));
    }
  </script>

  <footer style="text-align:center;color:var(--muted);padding:24px 16px; position:relative; z-index:1">
    Single‑file app · Modify the <strong>BANK</strong> array to add/edit items.  
    Ocean visuals are subtle and respect “Reduced motion.”  
    <div style="margin-top:6px;opacity:.7">Build: <code>v1.6-ocean-darkblue-no-filterbar</code></div>
  </footer>
</body>
</html>
