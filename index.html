<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Anatomy Flash Cards</title>
<style>
  :root{
    --bg0:#050913;
    --bg1:#071225;
    --fg:#eaf3ff;
    --muted:#9bb6d3;
    --accent:#6ecbff;
    --accent2:#8a7dff;
    --surface:rgba(12,18,34,.78);
    --border:rgba(150,210,255,.18);
    --shadow:0 18px 50px rgba(0,0,0,.45);
    --radius:22px;
    --focus:2px solid rgba(110,203,255,.9);
    --maxw:860px;
    --cardw:min(92vw,560px);
    --cardh:min(60vh,540px);
    --font:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:var(--font);
    color:var(--fg);
    background:
      radial-gradient(1200px 800px at 20% 10%, rgba(110,203,255,.16), transparent 60%),
      radial-gradient(900px 700px at 80% 40%, rgba(138,125,255,.14), transparent 62%),
      radial-gradient(700px 700px at 55% 85%, rgba(110,203,255,.10), transparent 60%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
    overflow-x:hidden;
  }

  /* subtle stars */
  .stars{
    position:fixed; inset:0; pointer-events:none; z-index:0;
    background-image:
      radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,.35), transparent 2px),
      radial-gradient(1px 1px at 35% 70%, rgba(255,255,255,.25), transparent 2px),
      radial-gradient(1px 1px at 60% 30%, rgba(255,255,255,.25), transparent 2px),
      radial-gradient(1px 1px at 80% 80%, rgba(255,255,255,.18), transparent 2px),
      radial-gradient(1px 1px at 90% 40%, rgba(255,255,255,.18), transparent 2px),
      radial-gradient(1px 1px at 25% 45%, rgba(255,255,255,.20), transparent 2px);
    opacity:.9;
    filter: blur(.1px);
  }

  .wrap{
    position:relative; z-index:1;
    max-width:var(--maxw);
    margin:0 auto;
    padding:26px 16px 44px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:16px;
  }

  h1{
    margin:8px 0 0;
    font-size:clamp(28px, 4vw, 44px);
    letter-spacing:.2px;
    font-weight:900;
    text-align:center;
  }

  /* Top-left mode switch */
  .modeSwitch{
    position:fixed;
    top:14px; left:14px;
    z-index:80;
    display:flex;
    gap:8px;
    padding:8px;
    border-radius:16px;
    background:rgba(8,18,32,.65);
    border:1px solid rgba(255,255,255,.10);
    backdrop-filter: blur(10px) saturate(1.05);
    box-shadow:0 12px 30px rgba(0,0,0,.28);
  }
  .modeBtn{
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.08);
    color:var(--fg);
    border-radius:14px;
    padding:9px 12px;
    font-weight:950;
    cursor:pointer;
    box-shadow:none;
    transition:filter .15s ease, transform .06s ease;
    white-space:nowrap;
  }
  .modeBtn:hover{filter:brightness(1.04); transform:translateY(-1px)}
  .modeBtn:active{transform:translateY(0)}
  .modeBtn.active{
    border-color:rgba(110,203,255,.45);
    background:rgba(110,203,255,.22);
  }
  .modeBtn:focus-visible{outline:var(--focus); outline-offset:3px}

  .progressRow{
    width:min(92vw, 760px);
    display:flex;
    flex-direction:column;
    gap:10px;
    align-items:center;
    margin-top:4px;
  }
  .bar{
    width:100%;
    height:12px;
    border-radius:999px;
    background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.10);
    overflow:hidden;
  }
  .bar > span{
    display:block;
    height:100%;
    width:0%;
    background:linear-gradient(90deg, rgba(110,203,255,.95), rgba(138,125,255,.95));
    border-radius:999px;
    transition:width .25s ease;
  }
  .counter{
    font-size:clamp(18px, 2.5vw, 30px);
    font-weight:800;
    color:rgba(110,203,255,.95);
  }

  .topControls{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:center;
    margin-top:2px;
  }
  button{
    border:0;
    cursor:pointer;
    border-radius:14px;
    padding:10px 14px;
    font-weight:950;
    color:#041018;
    background:rgba(110,203,255,.95);
    box-shadow:0 10px 22px rgba(0,0,0,.25);
    transition:transform .06s ease, filter .15s ease;
  }
  button:hover{transform:translateY(-1px); filter:brightness(1.03)}
  button:active{transform:translateY(0)}
  button.secondary{
    background:rgba(255,255,255,.10);
    color:var(--fg);
    border:1px solid rgba(255,255,255,.14);
    box-shadow:none;
  }
  button:focus-visible{outline:var(--focus); outline-offset:3px}

  .cardStage{
    width:var(--cardw);
    height:var(--cardh);
    perspective: 1200px;
  }
  .card{
    position:relative;
    width:100%;
    height:100%;
    border-radius:var(--radius);
    transform-style:preserve-3d;
    transition: transform .6s cubic-bezier(.2,.8,.2,1);
    box-shadow: var(--shadow);
    cursor:pointer;
  }
  .card.isFlipped{ transform: rotateY(180deg); cursor:default; }

  .face{
    position:absolute;
    inset:0;
    backface-visibility:hidden;
    border-radius:var(--radius);
    overflow:hidden;
  }

  .frame{
    position:absolute;
    inset:0;
    border-radius:var(--radius);
    pointer-events:none;
    border:2px solid rgba(140,220,255,.45);
    box-shadow:
      0 0 0 6px rgba(110,203,255,.10) inset,
      0 0 24px rgba(110,203,255,.28),
      0 0 46px rgba(138,125,255,.18);
  }

  .front{
    background:rgba(10,18,32,.55);
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .front img{
    width:100%;
    height:100%;
    object-fit:cover;
    transform:scale(1.02);
    filter:contrast(1.05) saturate(1.05);
  }
  .front .overlay{
    position:absolute;
    inset:0;
    background:linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.52));
  }
  .front .hint{
    position:absolute;
    bottom:16px;
    left:0; right:0;
    text-align:center;
    font-weight:950;
    color:rgba(234,243,255,.92);
    text-shadow:0 6px 22px rgba(0,0,0,.55);
    padding:0 12px;
  }

  .back{
    transform: rotateY(180deg);
    background: var(--surface);
    border:1px solid rgba(255,255,255,.12);
    display:flex;
    flex-direction:column;
    padding:18px;
    gap:12px;
  }
  .meta{
    color:rgba(155,182,211,.9);
    font-weight:950;
    font-size:.98rem;
  }
  .q{
    font-size:clamp(18px, 2.2vw, 24px);
    font-weight:980;
    line-height:1.25;
    margin-top:2px;
  }

  .hidden{display:none !important;}

  /* MCQ */
  .choicesWrap{
    position:relative;
    display:grid;
    gap:10px;
    margin-top:6px;
  }
  .choiceBtn{
    width:100%;
    text-align:left;
    padding:12px 12px;
    border-radius:14px;
    background:rgba(255,255,255,.08);
    color:rgba(234,243,255,.96);
    border:1px solid rgba(255,255,255,.14);
    box-shadow:none;
    font-weight:950;
    display:flex;
    gap:10px;
    align-items:flex-start;
    cursor:pointer;
  }
  .choiceBtn:hover{filter:brightness(1.04)}
  .choiceBtn[disabled]{opacity:.72; cursor:not-allowed}
  .badge{
    min-width:28px;
    height:28px;
    border-radius:10px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-weight:980;
    background:rgba(110,203,255,.18);
    border:1px solid rgba(110,203,255,.30);
    color:rgba(234,243,255,.96);
    margin-top:1px;
  }
  .choiceText{line-height:1.25}
  .choiceBtn.correct{
    border-color:rgba(34,197,94,.55);
    background:rgba(34,197,94,.14);
  }
  .choiceBtn.wrong{
    border-color:rgba(239,68,68,.55);
    background:rgba(239,68,68,.12);
  }
  .choiceBtn.correct .badge{background:rgba(34,197,94,.18); border-color:rgba(34,197,94,.35)}
  .choiceBtn.wrong .badge{background:rgba(239,68,68,.16); border-color:rgba(239,68,68,.35)}

  /* Short answer */
  .saWrap{
    position:relative;
    margin-top:6px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .inputWrap{
    position:relative;
  }
  input[type="text"]{
    width:100%;
    padding:14px 14px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(255,255,255,.06);
    color:var(--fg);
    font-size:16px;
    outline:none;
  }
  input[type="text"]::placeholder{color:rgba(155,182,211,.78)}
  input[type="text"]:focus{
    box-shadow:0 0 0 3px rgba(110,203,255,.18);
    border-color:rgba(110,203,255,.45);
  }
  input[disabled]{opacity:.6; cursor:not-allowed}

  .saBtns{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:center;
  }

  /* Reveal */
  .reveal{
    display:none;
    border-left:3px solid rgba(110,203,255,.75);
    background:rgba(110,203,255,.08);
    padding:10px 12px;
    border-radius:12px;
    color:rgba(234,243,255,.95);
    font-weight:950;
    line-height:1.35;
    margin-top:4px;
  }
  .reveal.show{display:block}

  .bottomRow{
    width:var(--cardw);
    display:flex;
    justify-content:center;
    gap:10px;
    flex-wrap:wrap;
  }

  .statusLine{
    color:rgba(155,182,211,.9);
    font-size:.95rem;
    text-align:center;
    max-width:78ch;
    line-height:1.4;
  }

  .toast{
    position:fixed;
    bottom:18px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(8,18,32,.92);
    border:1px solid rgba(255,255,255,.10);
    color:rgba(234,243,255,.95);
    padding:10px 14px;
    border-radius:999px;
    font-weight:980;
    opacity:0;
    transition:opacity .2s ease;
    z-index:90;
  }
  .toast.show{opacity:1}

  /* Confetti localized layers */
  .confettiLayer{
    position:absolute;
    inset:-10px -10px -10px -10px;
    pointer-events:none;
    overflow:visible;
  }
  .confettiBit{
    position:absolute;
    width:8px;
    height:12px;
    border-radius:2px;
    opacity:0;
    transform:translateY(0) rotate(0deg);
    animation:confettiPop 900ms ease-out forwards;
    box-shadow:0 4px 14px rgba(0,0,0,.2);
  }
  @keyframes confettiPop{
    0%{opacity:1; transform:translateY(0) rotate(0deg)}
    100%{opacity:0; transform:translateY(100px) rotate(540deg)}
  }

  /* Modal */
  .modal{
    position:fixed; inset:0;
    display:none;
    place-items:center;
    background:rgba(0,0,0,.40);
    z-index:1000;
    backdrop-filter: blur(10px) saturate(1.05);
  }
  .modal.show{display:grid}
  .modal .box{
    width:min(760px, 92vw);
    background:rgba(12,18,34,.92);
    border:1px solid rgba(255,255,255,.12);
    border-radius:18px;
    box-shadow:0 18px 44px rgba(0,0,0,.45);
    padding:18px 16px 14px;
  }
  .modal h2{
    margin:6px 0 10px;
    font-size:1.25rem;
  }
  .row{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin:10px 0;
  }
  .chip{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:9px 12px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.06);
    color:rgba(234,243,255,.95);
    font-weight:980;
    cursor:pointer;
    user-select:none;
  }
  .chip input{width:18px; height:18px}
  .modal .actions{
    display:flex;
    gap:10px;
    justify-content:flex-end;
    margin-top:14px;
    flex-wrap:wrap;
  }
  .modal .sub{
    color:rgba(155,182,211,.9);
    font-weight:950;
    margin:8px 0 0;
  }

  @media (prefers-reduced-motion: reduce){
    .card{transition:none}
    .bar > span{transition:none}
    .confettiBit{animation:none; opacity:0}
  }
</style>
</head>

<body>
<div class="stars" aria-hidden="true"></div>

<!-- Mode buttons (top-left) -->
<div class="modeSwitch" aria-label="Answer mode">
  <button class="modeBtn active" id="modeMcq" type="button">Multiple choice</button>
  <button class="modeBtn" id="modeSa" type="button">Short answer</button>
</div>

<div class="wrap" id="appRoot">
  <h1>Anatomy Flash Cards</h1>

  <div class="progressRow" aria-label="Progress">
    <div class="bar" aria-hidden="true"><span id="barFill"></span></div>
    <div class="counter" id="counter">0 / 0</div>
    <div class="topControls">
      <button class="secondary" id="changeBtn" type="button">Change labs/topics</button>
      <button class="secondary" id="shuffleBtn" type="button">Shuffle</button>
      <button class="secondary" id="resetBtn" type="button">Reset</button>
    </div>
  </div>

  <div class="cardStage" aria-label="Flashcard">
    <div class="card" id="card" role="button" tabindex="0" aria-label="Flashcard. Click to flip.">
      <!-- FRONT: image (card back) -->
      <div class="face front">
        <img id="cardImg" alt="Flashcard back image" />
        <div class="overlay" aria-hidden="true"></div>
        <div class="hint" id="frontHint">Click to flip</div>
        <div class="frame" aria-hidden="true"></div>
      </div>

      <!-- BACK: question + either MCQ or short-answer -->
      <div class="face back">
        <div class="meta" id="metaLine">Pick labs/topics to begin</div>
        <div class="q" id="question">—</div>

        <!-- MCQ section -->
        <div id="mcqSection">
          <div class="choicesWrap" id="choicesWrap" aria-label="Choices">
            <div class="confettiLayer" id="confettiMcq" aria-hidden="true"></div>
            <!-- choices injected here -->
          </div>
        </div>

        <!-- Short-answer section -->
        <div id="saSection" class="hidden">
          <div class="saWrap" aria-label="Short answer">
            <div class="inputWrap">
              <div class="confettiLayer" id="confettiSa" aria-hidden="true"></div>
              <input id="saInput" type="text" autocomplete="off" spellcheck="false" placeholder="Type ONE word…" disabled />
            </div>
            <div class="saBtns">
              <button id="saCheck" type="button">Check</button>
            </div>
            <div style="color:rgba(155,182,211,.9); font-weight:900; text-align:center; font-size:.95rem;">
              Short answer accepts exactly one word.
            </div>
          </div>
        </div>

        <div class="reveal" id="revealBox" aria-live="polite"></div>

        <div class="frame" aria-hidden="true"></div>
      </div>
    </div>
  </div>

  <div class="bottomRow">
    <button class="secondary" id="revealBtn" type="button">Reveal</button>
    <button id="nextBtn" type="button">Next</button>
  </div>

  <div class="statusLine" id="statusLine"></div>
</div>

<div class="toast" id="toast" role="status" aria-live="polite" aria-atomic="true"></div>

<!-- Modal -->
<div class="modal" id="pickerModal" role="dialog" aria-modal="true" aria-labelledby="pickerTitle">
  <div class="box">
    <h2 id="pickerTitle">Choose what to study</h2>

    <div id="stepLabs">
      <div class="sub">Step 1 — Labs (pick one or more)</div>
      <div class="row" id="labChips"></div>
      <div class="actions">
        <button class="secondary" id="labsSelectAll" type="button">Select all</button>
        <button id="toTopics" type="button">Next</button>
      </div>
    </div>

    <div id="stepTopics" style="display:none">
      <div class="sub">Step 2 — Topics (pick one or more)</div>
      <div class="row" id="topicChips"></div>
      <div class="actions">
        <button class="secondary" id="backToLabs" type="button">Back</button>
        <button class="secondary" id="topicsSelectAll" type="button">Select all</button>
        <button id="startBtn" type="button">Start</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   CONFIG: images
   ========================= */
const IMAGE_DIR = "./Anatomy/images/";
const MANIFEST_URL = IMAGE_DIR + "manifest.json";

/* =========================
   CARD BANK
   =========================
   - mcq options/answerIndex for Multiple Choice mode
   - shortAnswer must be EXACTLY ONE WORD for Short Answer mode
*/
const CARD_BANK = [
  // Sample cards adjusted so shortAnswer is one word (per your rule)
  {
    lab: 1,
    topics:["muscles","innervation"],
    stem:"Deltoid — innervation?",
    options:["Radial nerve","Axillary nerve","Musculocutaneous nerve","Median nerve"],
    answerIndex:1,
    shortAnswer:"Axillary",
    explanation:"Deltoid is innervated by the axillary nerve (C5–C6)."
  },
  {
    lab: 1,
    topics:["muscles"],
    stem:"Which muscle initiates shoulder abduction (0–15°)?",
    options:["Deltoid","Supraspinatus","Infraspinatus","Subscapularis"],
    answerIndex:1,
    shortAnswer:"Supraspinatus",
    explanation:"Supraspinatus initiates the first degrees of abduction."
  },
  {
    lab: 2,
    topics:["bones","innervation"],
    stem:"A midshaft humeral fracture classically injures which nerve?",
    options:["Ulnar","Radial","Axillary","Median"],
    answerIndex:1,
    shortAnswer:"Radial",
    explanation:"Radial nerve runs in the radial groove; injury can cause wrist drop."
  },
  {
    lab: 2,
    topics:["blood"],
    stem:"Artery accompanying the radial nerve through the triangular interval:",
    options:["Posterior circumflex humeral","Profunda brachii (deep brachial)","Anterior circumflex humeral","Radial recurrent"],
    answerIndex:1,
    shortAnswer:"Profunda",
    explanation:"Triangular interval contains the radial nerve and profunda brachii (deep brachial) artery."
  }
  // Add labs 3–11 similarly...
];

/* =========================
   Helpers
   ========================= */
const $ = s => document.querySelector(s);
function say(msg){
  const t=$("#toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(say._t);
  say._t = setTimeout(()=>t.classList.remove("show"), 1400);
}
function shuffle(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function unique(arr){ return [...new Set(arr)]; }

// normalization for short-answer matching (case/punct-insensitive)
function norm(s){
  return String(s||"")
    .toLowerCase()
    .replace(/[\u2013\u2014]/g,"-")
    .replace(/[^\p{L}\p{N}\s-]/gu,"")
    .replace(/\s+/g," ")
    .trim();
}
function isOneWord(s){
  const parts = norm(s).split(" ").filter(Boolean);
  return parts.length === 1;
}

/* =========================
   Answer mode
   ========================= */
let answerMode = "mcq"; // "mcq" or "sa"
function setMode(mode){
  if(mode !== "mcq" && mode !== "sa") return;
  answerMode = mode;

  $("#modeMcq").classList.toggle("active", mode==="mcq");
  $("#modeSa").classList.toggle("active", mode==="sa");

  // Toggle UI panels
  $("#mcqSection").classList.toggle("hidden", mode!=="mcq");
  $("#saSection").classList.toggle("hidden", mode!=="sa");

  // Rebuild deck for this mode (so invalid cards are excluded cleanly)
  if(hasStarted){
    deck = buildDeck();
    idx = 0;
    flipped = false;
    answered = false;
    lastChoiceIndex = null;
    $("#revealBox").classList.remove("show");
    $("#revealBox").textContent = "";
    renderCard();
    say(mode==="mcq" ? "Multiple choice mode" : "Short answer mode");
    updateStatusLine();
  }else{
    renderCard();
  }
}

/* =========================
   Image manifest loading
   ========================= */
let images = [];
let lastImage = null;

async function loadManifest(){
  try{
    const res = await fetch(MANIFEST_URL, { cache:"no-store" });
    if(!res.ok) throw new Error("Manifest not found");
    const data = await res.json();
    const list = Array.isArray(data) ? data : (data.images || []);
    images = list.filter(Boolean);
    if(!images.length){
      $("#statusLine").textContent =
        "Manifest loaded but contains no images. Add filenames to Anatomy/images/manifest.json.";
    }
  }catch(e){
    images = [];
    $("#statusLine").textContent =
      "Could not load Anatomy/images/manifest.json yet. Add it to enable random card-back images.";
  }
}
function pickRandomImage(){
  if(!images.length) return null;
  if(images.length === 1) return images[0];
  let pick = images[Math.floor(Math.random()*images.length)];
  let tries=0;
  while(pick === lastImage && tries < 6){
    pick = images[Math.floor(Math.random()*images.length)];
    tries++;
  }
  lastImage = pick;
  return pick;
}
function setCardBackImage(){
  const imgEl = $("#cardImg");
  const hint = $("#frontHint");

  const filename = pickRandomImage();
  if(!filename){
    imgEl.removeAttribute("src");
    imgEl.style.display="none";
    $("#card .front").style.background =
      "radial-gradient(800px 600px at 30% 25%, rgba(110,203,255,.22), transparent 55%)," +
      "radial-gradient(700px 600px at 70% 70%, rgba(138,125,255,.18), transparent 60%)," +
      "linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02))";
    hint.textContent = "Add manifest.json to enable random images";
    return;
  }

  imgEl.style.display="block";
  hint.textContent = "Click to flip";
  const url = IMAGE_DIR + encodeURIComponent(filename);
  imgEl.src = url;
  imgEl.onerror = () => {
    imgEl.style.display="none";
    hint.textContent = "Image not found — check manifest filenames";
  };
}

/* =========================
   Labs/topics selection
   ========================= */
const ALL_LABS = Array.from({length:11}, (_,i)=>i+1);
let selectedLabs = new Set([1]);
let selectedTopics = new Set();

function topicsInLabs(labsSet){
  const labs = [...labsSet];
  const topics = CARD_BANK
    .filter(c => labs.includes(c.lab))
    .flatMap(c => c.topics || []);
  return unique(topics).sort((a,b)=>a.localeCompare(b));
}

function cardValidForMode(c){
  if(answerMode === "mcq"){
    return Array.isArray(c.options) && c.options.length >= 2 && Number.isInteger(c.answerIndex);
  }
  // short answer: must exist and be exactly one word
  return typeof c.shortAnswer === "string" && isOneWord(c.shortAnswer);
}

function buildDeck(){
  const labs = [...selectedLabs];
  const topics = [...selectedTopics];

  const pool = CARD_BANK.filter(c => {
    const inLab = labs.includes(c.lab);
    const inTopic = topics.length ? (c.topics || []).some(t => selectedTopics.has(t)) : true;
    return inLab && inTopic && cardValidForMode(c);
  });

  return shuffle(pool);
}

/* =========================
   UI state
   ========================= */
let deck = [];
let idx = 0;
let flipped = false;
let answered = false;
let lastChoiceIndex = null;
let hasStarted = false;

function currentCard(){ return deck[idx] || null; }

function updateProgress(){
  $("#counter").textContent = deck.length ? `${idx+1} / ${deck.length}` : `0 / 0`;
  $("#barFill").style.width = deck.length ? `${Math.round(((idx+1)/deck.length)*100)}%` : "0%";
}

function clearConfetti(){
  $("#confettiMcq").innerHTML = "";
  $("#confettiSa").innerHTML = "";
}

function confettiBurst(layerEl){
  if(window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches) return;

  layerEl.innerHTML = "";
  const colors = ["#6ecbff","#8a7dff","#22c55e","#f59e0b","#ef4444","#ffffff"];
  const W = layerEl.clientWidth || 520;
  const H = layerEl.clientHeight || 220;

  const n = 26;
  for(let i=0;i<n;i++){
    const bit = document.createElement("span");
    bit.className = "confettiBit";
    bit.style.left = (Math.random()*W) + "px";
    bit.style.top  = (Math.random()*H*0.25) + "px";
    bit.style.background = colors[Math.floor(Math.random()*colors.length)];
    bit.style.animationDelay = (Math.random()*0.08) + "s";
    layerEl.appendChild(bit);
  }
  setTimeout(()=>layerEl.innerHTML="", 1000);
}

/* =========================
   Render back content
   ========================= */
function renderChoices(cardObj){
  const wrap = $("#choicesWrap");
  [...wrap.querySelectorAll(".choiceBtn")].forEach(x=>x.remove());

  const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
  (cardObj.options || []).forEach((opt, i) => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "choiceBtn";
    btn.setAttribute("data-index", String(i));
    btn.innerHTML = `<span class="badge">${letters[i] || (i+1)}</span><span class="choiceText">${opt}</span>`;
    btn.addEventListener("click", () => chooseAnswer(i));
    wrap.appendChild(btn);
  });
}

function lockChoices(lock=true){
  const btns = [...$("#choicesWrap").querySelectorAll(".choiceBtn")];
  btns.forEach(b => b.disabled = lock);
}

function markChoices(cardObj, chosenIndex, revealOnly=false){
  const btns = [...$("#choicesWrap").querySelectorAll(".choiceBtn")];
  btns.forEach((b, i) => {
    b.classList.remove("correct","wrong");
    if(i === cardObj.answerIndex) b.classList.add("correct");
    if(!revealOnly && chosenIndex === i && chosenIndex !== cardObj.answerIndex) b.classList.add("wrong");
  });
}

function setQuestionUI(){
  const c = currentCard();
  $("#revealBox").classList.remove("show");
  $("#revealBox").textContent = "";
  clearConfetti();

  if(!c){
    $("#metaLine").textContent = "No cards match your selection";
    $("#question").textContent = "Change labs/topics (or switch mode) to begin.";

    [...$("#choicesWrap").querySelectorAll(".choiceBtn")].forEach(x=>x.remove());
    $("#saInput").value = "";
    $("#saInput").disabled = true;
    return;
  }

  $("#metaLine").textContent = `Lab ${c.lab} • ${(c.topics||[]).join(" • ")}`;
  $("#question").textContent = c.stem;

  answered = false;
  lastChoiceIndex = null;

  if(answerMode === "mcq"){
    renderChoices(c);
    lockChoices(!flipped);
    $("#saInput").value = "";
    $("#saInput").disabled = true;
  }else{
    [...$("#choicesWrap").querySelectorAll(".choiceBtn")].forEach(x=>x.remove());
    $("#saInput").value = "";
    $("#saInput").placeholder = "Type ONE word…";
    $("#saInput").disabled = !flipped;
  }
}

function renderCard(){
  updateProgress();
  setCardBackImage();
  setQuestionUI();
  $("#card").classList.toggle("isFlipped", flipped);

  if(answerMode === "sa" && flipped && currentCard()){
    setTimeout(()=>$("#saInput").focus(), 220);
  }
}

function updateStatusLine(){
  if(!hasStarted){
    $("#statusLine").textContent = "Pick labs/topics to start.";
    return;
  }
  const labsTxt = [...selectedLabs].sort((a,b)=>a-b).join(", ");
  const topicsTxt = [...selectedTopics].sort((a,b)=>a.localeCompare(b)).join(", ");
  const modeTxt = (answerMode==="mcq") ? "Multiple choice" : "Short answer (one word)";
  if(deck.length){
    $("#statusLine").textContent = `Mode: ${modeTxt}. Studying labs: ${labsTxt}. Topics: ${topicsTxt}.`;
  }else{
    $("#statusLine").textContent =
      `Mode: ${modeTxt}. No cards match your selection in this mode. (For Short Answer, keys must be one word.)`;
  }
}

/* =========================
   Answer logic
   ========================= */
function ensureFlipped(){
  if(!deck.length){ say("Pick labs/topics first."); return false; }
  if(!flipped){ say("Flip the card first."); return false; }
  return true;
}

/* MCQ */
function chooseAnswer(choiceIndex){
  const c = currentCard();
  if(!c) return;
  if(answerMode !== "mcq") return;
  if(!ensureFlipped()) return;
  if(answered) return;

  answered = true;
  lastChoiceIndex = choiceIndex;

  const correct = choiceIndex === c.answerIndex;

  if(correct){
    say("Correct.");
    markChoices(c, choiceIndex, false);
    confettiBurst($("#confettiMcq"));
  }else{
    say("Not quite.");
    markChoices(c, choiceIndex, false);
  }
  lockChoices(true);
}

/* Short answer */
function checkShortAnswer(){
  const c = currentCard();
  if(!c) return;
  if(answerMode !== "sa") return;
  if(!ensureFlipped()) return;

  const raw = $("#saInput").value || "";
  const cleaned = norm(raw);

  if(!cleaned){
    say("Type an answer.");
    return;
  }
  const parts = cleaned.split(" ").filter(Boolean);
  if(parts.length !== 1){
    say("One word only.");
    return;
  }

  const key = norm(c.shortAnswer);
  if(cleaned === key){
    say("Correct.");
    $("#saInput").disabled = true;
    confettiBurst($("#confettiSa"));
  }else{
    say("Not quite.");
  }
}

function revealAnswer(){
  const c = currentCard();
  if(!c) return;
  if(!ensureFlipped()) return;

  if(answerMode === "mcq"){
    markChoices(c, lastChoiceIndex, true);
    lockChoices(true);
    const expl = c.explanation ? `<div style="margin-top:6px; opacity:.95">${c.explanation}</div>` : "";
    $("#revealBox").innerHTML = `<strong>Correct answer:</strong> ${c.options[c.answerIndex] || "—"}${expl}`;
    $("#revealBox").classList.add("show");
    return;
  }

  // short answer
  const expl = c.explanation ? `<div style="margin-top:6px; opacity:.95">${c.explanation}</div>` : "";
  $("#revealBox").innerHTML = `<strong>Correct answer:</strong> ${c.shortAnswer || "—"}${expl}`;
  $("#revealBox").classList.add("show");
  $("#saInput").disabled = true;
}

function nextCard(){
  if(!deck.length) return;
  idx = (idx + 1) % deck.length;
  flipped = false;
  answered = false;
  lastChoiceIndex = null;
  $("#saInput").disabled = true;
  $("#saInput").value = "";
  $("#revealBox").classList.remove("show");
  $("#revealBox").textContent = "";
  renderCard();
  say("Next");
}

/* =========================
   Modal (labs/topics picker)
   ========================= */
const modal = $("#pickerModal");

function openModal(step="labs"){
  modal.classList.add("show");
  $("#stepLabs").style.display = (step==="labs") ? "block" : "none";
  $("#stepTopics").style.display = (step==="topics") ? "block" : "none";
}
function closeModal(){ modal.classList.remove("show"); }

function renderLabChips(){
  const host = $("#labChips");
  host.innerHTML = "";
  ALL_LABS.forEach(n=>{
    const label = document.createElement("label");
    label.className = "chip";
    label.innerHTML = `<input type="checkbox" value="${n}">Lab ${n}`;
    label.querySelector("input").checked = selectedLabs.has(n);
    host.appendChild(label);
  });
}

function renderTopicChips(){
  const host = $("#topicChips");
  host.innerHTML = "";

  const topics = topicsInLabs(selectedLabs);
  if(!topics.length){
    const p=document.createElement("div");
    p.style.color="rgba(155,182,211,.9)";
    p.style.fontWeight="950";
    p.textContent = "No topics found for those labs (check your CARD_BANK topics).";
    host.appendChild(p);
    return;
  }

  if(selectedTopics.size === 0){
    topics.forEach(t=>selectedTopics.add(t));
  }

  topics.forEach(t=>{
    const label = document.createElement("label");
    label.className = "chip";
    label.innerHTML = `<input type="checkbox" value="${t}">${t}`;
    label.querySelector("input").checked = selectedTopics.has(t);
    host.appendChild(label);
  });
}

function applyLabsFromModal(){
  const cbs = [...$("#labChips").querySelectorAll("input[type=checkbox]:checked")];
  const labs = cbs.map(cb=>parseInt(cb.value,10)).filter(n=>Number.isFinite(n));
  if(!labs.length){ say("Pick at least one lab."); return false; }
  selectedLabs = new Set(labs);
  selectedTopics = new Set();
  return true;
}

function applyTopicsFromModal(){
  const cbs = [...$("#topicChips").querySelectorAll("input[type=checkbox]:checked")];
  const topics = cbs.map(cb=>cb.value).filter(Boolean);
  if(!topics.length){ say("Pick at least one topic (or Select all)."); return false; }
  selectedTopics = new Set(topics);
  return true;
}

function startWithSelections(){
  hasStarted = true;
  deck = buildDeck();
  idx = 0;
  flipped = false;
  answered = false;
  lastChoiceIndex = null;

  renderCard();
  updateStatusLine();

  if(deck.length){
    say(`Loaded ${deck.length} cards.`);
  }else{
    say("No matching cards.");
  }
}

/* =========================
   Events
   ========================= */
$("#modeMcq").addEventListener("click", ()=>setMode("mcq"));
$("#modeSa").addEventListener("click", ()=>setMode("sa"));

$("#changeBtn").addEventListener("click", ()=>{ renderLabChips(); openModal("labs"); });

$("#shuffleBtn").addEventListener("click", ()=>{
  if(!hasStarted){ say("Pick labs/topics first."); return; }
  if(!deck.length){ say("No cards in this mode."); return; }
  deck = shuffle(deck);
  idx = 0;
  flipped = false;
  answered = false;
  lastChoiceIndex = null;
  $("#saInput").disabled = true;
  $("#saInput").value = "";
  $("#revealBox").classList.remove("show");
  $("#revealBox").textContent = "";
  renderCard();
  say("Shuffled");
});

$("#resetBtn").addEventListener("click", ()=>{
  if(!hasStarted){ say("Pick labs/topics first."); return; }
  idx = 0;
  flipped = false;
  answered = false;
  lastChoiceIndex = null;
  $("#saInput").disabled = true;
  $("#saInput").value = "";
  $("#revealBox").classList.remove("show");
  $("#revealBox").textContent = "";
  renderCard();
  say("Reset");
});

$("#card").addEventListener("click", ()=>{
  if(!hasStarted){ say("Pick labs/topics first."); return; }
  if(!deck.length){ say("No cards in this mode."); return; }
  if(flipped) return; // prevent accidental flip-back
  flipped = true;
  renderCard();
  if(answerMode === "mcq") lockChoices(false);
  if(answerMode === "sa"){ $("#saInput").disabled = false; setTimeout(()=>$("#saInput").focus(), 220); }
});

$("#card").addEventListener("keydown", (e)=>{
  if(e.key === " "){
    e.preventDefault();
    if(!hasStarted){ say("Pick labs/topics first."); return; }
    if(!deck.length){ say("No cards in this mode."); return; }
    flipped = !flipped;
    answered = false;
    lastChoiceIndex = null;
    $("#saInput").disabled = !flipped || answerMode!=="sa";
    $("#saInput").value = "";
    $("#revealBox").classList.remove("show");
    $("#revealBox").textContent = "";
    renderCard();
    if(answerMode === "mcq") lockChoices(!flipped);
  }

  // MCQ quick keys: 1-6
  const n = parseInt(e.key,10);
  if(Number.isFinite(n) && n >= 1 && n <= 6){
    if(flipped && answerMode==="mcq"){
      const c=currentCard(); if(!c) return;
      if(n-1 < (c.options||[]).length) chooseAnswer(n-1);
    }
  }

  // Enter checks short answer when flipped
  if(e.key === "Enter" && flipped && answerMode==="sa"){
    e.preventDefault();
    checkShortAnswer();
  }

  // R reveal, -> next
  if(e.key.toLowerCase() === "r"){ e.preventDefault(); revealAnswer(); }
  if(e.key === "ArrowRight"){ e.preventDefault(); nextCard(); }
});

$("#saCheck").addEventListener("click", checkShortAnswer);
$("#saInput").addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){
    e.preventDefault();
    checkShortAnswer();
  }
});

$("#revealBtn").addEventListener("click", revealAnswer);
$("#nextBtn").addEventListener("click", nextCard);

/* Modal buttons */
$("#labsSelectAll").addEventListener("click", ()=>{
  const allSelected = ALL_LABS.every(n=>$("#labChips input[value='"+n+"']").checked);
  ALL_LABS.forEach(n=>{ $("#labChips input[value='"+n+"']").checked = !allSelected; });
});

$("#toTopics").addEventListener("click", ()=>{
  if(!applyLabsFromModal()) return;
  renderTopicChips();
  openModal("topics");
});

$("#backToLabs").addEventListener("click", ()=>openModal("labs"));

$("#topicsSelectAll").addEventListener("click", ()=>{
  const inputs = [...$("#topicChips").querySelectorAll("input[type=checkbox]")];
  const allSelected = inputs.length && inputs.every(x=>x.checked);
  inputs.forEach(x=>x.checked = !allSelected);
});

$("#startBtn").addEventListener("click", ()=>{
  if(!applyTopicsFromModal()) return;
  closeModal();
  startWithSelections();
});

/* =========================
   Init
   ========================= */
(async function init(){
  $("#statusLine").textContent = "Loading images…";
  await loadManifest();
  renderLabChips();
  openModal("labs");
  setMode("mcq"); // default mode
  deck = [];
  idx = 0;
  flipped = false;
  renderCard();
  updateStatusLine();
})();
</script>
</body>
</html>
