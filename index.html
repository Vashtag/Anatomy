<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>KIN 100 Review â€” Shoulder & Arm (Flashcards + MCQ)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#fafafa;
      --fg:#161616;
      --muted:#6b6b6b;
      --surface:#ffffff;
      --border:#e6e6e6;
      --accent:#7d5cff; /* playful but calm */
      --accent-2:#ffd166; /* warm pop */
      --ok:#2e7d32;
      --err:#b00020;
      --focus: 2px solid #7d5cff;
      --radius:14px;
      --shadow: 0 8px 24px rgba(0,0,0,.08);
      --btn-shadow: 0 4px 12px rgba(125,92,255,.25);
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    body.high-contrast{
      --bg:#000;
      --fg:#fff;
      --muted:#eaeaea;
      --surface:#000;
      --border:#fff;
      --accent:#00e5ff;
      --accent-2:#ffea00;
      --ok:#00e676;
      --err:#ff5252;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--fg); font-family:var(--font); line-height:1.5;
    }
    .skip{position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden;}
    .skip:focus{left:16px; top:16px; width:auto; height:auto; background:var(--accent); color:#fff; padding:8px 12px; border-radius:8px}
    header{
      position:sticky; top:0; z-index:3;
      background:linear-gradient(90deg,var(--surface), #f6f3ff);
      border-bottom:1px solid var(--border);
      padding:14px 16px;
    }
    header .title{font-weight:700; font-size:1.1rem}
    header .subtitle{color:var(--muted); font-size:.95rem}
    .container{max-width:980px; margin:16px auto; padding:0 16px}
    .bar{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; margin:12px 0 18px;
    }
    .tabs[role="tablist"]{display:flex; gap:6px; padding:6px; background:var(--surface); border:1px solid var(--border); border-radius:999px}
    .tabs button{
      border:0; background:none; padding:10px 14px; border-radius:999px; cursor:pointer; color:var(--muted); font-weight:600;
    }
    .tabs button[aria-selected="true"]{background:var(--accent); color:#fff; box-shadow:var(--btn-shadow)}
    .filters, .toggles, .session{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
    }
    fieldset{border:1px dashed var(--border); border-radius:12px; padding:8px 10px}
    legend{padding:0 6px; color:var(--muted); font-size:.9rem}
    label{display:inline-flex; gap:8px; align-items:center; font-size:.95rem}
    input[type="checkbox"], input[type="radio"]{width:18px; height:18px}
    .panel{
      background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow);
    }
    /* Flashcards */
    .flash-wrap{display:grid; gap:14px}
    .card{
      position:relative;
      min-height:180px; display:grid; place-items:center; text-align:center;
      padding:24px; border:1px solid var(--border); border-radius:18px; background:#fff; box-shadow:var(--shadow);
      transition: transform .4s ease;
    }
    body.reduced-motion .card{transition:none}
    .card .face{font-size:1.15rem}
    .card .face small{display:block; color:var(--muted)}
    .flash-actions{display:flex; gap:8px; justify-content:center; flex-wrap:wrap}
    .btn{
      border:0; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:650; background:#f3f0ff; color:#3a2c90;
    }
    .btn.primary{background:var(--accent); color:#fff; box-shadow:var(--btn-shadow)}
    .btn.ghost{background:#f8f8f8; color:#333}
    .btn.good{background:#e8f5e9; color:var(--ok)}
    .btn.bad{background:#ffebee; color:var(--err)}
    .stats{display:flex; gap:12px; justify-content:center; color:var(--muted); font-size:.95rem}
    .barline{height:10px; background:#f0f0f6; border-radius:999px; overflow:hidden}
    .barline > span{display:block; height:100%; width:0; background:linear-gradient(90deg,var(--accent), var(--accent-2))}
    /* MCQ */
    .q-wrap{display:grid; gap:14px}
    .choices{display:grid; gap:8px}
    .choice{
      display:flex; gap:10px; align-items:flex-start;
      border:1px solid var(--border); border-radius:12px; padding:10px 12px; cursor:pointer; background:#fff;
    }
    .choice[data-state="correct"]{border-color:var(--ok); box-shadow:0 0 0 2px rgba(46,125,50,.2) inset}
    .choice[data-state="wrong"]{border-color:var(--err); box-shadow:0 0 0 2px rgba(176,0,32,.15) inset}
    .choice input{margin-top:3px}
    .rationale{border-left:4px solid var(--accent); padding:10px 12px; background:#fbfbff; border-radius:10px}
    .score{font-weight:700}
    footer{color:var(--muted); font-size:.85rem; padding:28px 16px; text-align:center}
    .toast{position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background:#111; color:#fff; padding:8px 12px; border-radius:999px; font-size:.9rem; opacity:0; transition:opacity .25s ease}
    .toast.show{opacity:1}
    /* Confetti (emoji) */
    .confetti{
      position:fixed; pointer-events:none; inset:0; overflow:hidden; z-index:1000;
    }
    .bit{position:absolute; font-size:18px; animation:fall 900ms ease-out forwards}
    @keyframes fall{
      from{transform:translateY(0) rotate(0deg); opacity:1}
      to{transform:translateY(120vh) rotate(540deg); opacity:0}
    }
    body.reduced-motion .bit{animation:none; opacity:0}
    /* Buttons */
    .session .btn{padding:8px 12px}
    .hidden{display:none !important}
    /* Focus outlines */
    :focus-visible{outline:var(--focus); outline-offset:2px}
  </style>
</head>
<body>
  <a href="#main" class="skip">Skip to content</a>
  <header>
    <div class="container">
      <div class="title">KIN 100 Review â€” Shoulder &amp; Arm</div>
      <div class="subtitle">Flashcards &amp; MCQ â€¢ textâ€‘only v1 (images can be added later)</div>
    </div>
  </header>

  <div class="container">
    <div class="bar">
      <div class="tabs" role="tablist" aria-label="Mode">
        <button id="tab-flash" role="tab" aria-selected="true" aria-controls="flashcardsPanel">Flashcards</button>
        <button id="tab-mcq" role="tab" aria-selected="false" aria-controls="mcqPanel">MCQ</button>
      </div>

      <fieldset class="filters">
        <legend>Filters</legend>
        <label><input type="checkbox" data-filter="shoulder" checked> Shoulder</label>
        <label><input type="checkbox" data-filter="arm" checked> Arm</label>
        <label><input type="checkbox" data-filter="muscles" checked> Muscles</label>
        <label><input type="checkbox" data-filter="bones" checked> Bones</label>
        <label><input type="checkbox" data-filter="innervation" checked> Innervation</label>
      </fieldset>

      <div class="session">
        <label title="High contrast / AODA friendly"><input type="checkbox" id="hcToggle"> High contrast</label>
        <label title="Reduce animations"><input type="checkbox" id="rmToggle"> Reduced motion</label>
      </div>
    </div>

    <!-- Flashcards -->
    <section id="flashcardsPanel" class="panel flash-wrap" role="tabpanel" aria-labelledby="tab-flash">
      <div class="bar" style="justify-content:center; gap:14px">
        <button class="btn ghost" id="flashShuffle">Shuffle deck</button>
        <button class="btn ghost" id="flashReset">Reset deck</button>
      </div>

      <div class="card" id="flashCard" aria-live="polite" aria-atomic="true">
        <div class="face" id="flashFace">Loading deckâ€¦</div>
      </div>

      <div class="flash-actions" aria-label="Flashcard actions">
        <button class="btn" id="flashFlip" title="Space to flip">Flip</button>
        <button class="btn bad" id="flashAgain" title="A key">Again</button>
        <button class="btn good" id="flashGot" title="G key">Got it</button>
      </div>

      <div class="stats">
        <div>Deck: <span id="deckCount">0</span></div>
        <div>Remaining: <span id="deckRemaining">0</span></div>
        <div>Streak: <span id="streak">0</span> ðŸ”¥</div>
      </div>
      <div class="barline" aria-hidden="true"><span id="progressFill"></span></div>
    </section>

    <!-- MCQ -->
    <section id="mcqPanel" class="panel q-wrap hidden" role="tabpanel" aria-labelledby="tab-mcq">
      <div class="bar" style="justify-content:space-between">
        <div>
          <label>Mode:
            <select id="mcqMode">
              <option value="practice">Practice (endless)</option>
              <option value="quiz">Quiz</option>
            </select>
          </label>
          <label id="quizLenWrap" class=""><span style="margin-left:8px"># Q:</span>
            <input type="number" id="quizLen" min="5" max="30" step="1" value="10" style="width:72px">
          </label>
        </div>
        <div>
          <button class="btn primary" id="mcqStart">Start</button>
          <button class="btn ghost" id="mcqStop">Stop</button>
        </div>
      </div>

      <div id="mcqStatus" class="stats" aria-live="polite"></div>

      <div id="mcqQ" class="panel" style="background:#fff; border-radius:12px; border:1px solid var(--border); box-shadow:var(--shadow)">
        <div id="mcqStem" style="font-size:1.1rem; font-weight:700; margin-bottom:8px">Press Start</div>
        <div id="mcqChoices" class="choices" role="group" aria-label="Choices"></div>
        <div id="mcqRationale" class="rationale hidden"></div>
        <div class="bar" style="justify-content:space-between; margin-top:6px">
          <div><span class="score" id="mcqScore">0/0</span></div>
          <div>
            <button class="btn" id="mcqNext" title="N key">Next</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite" aria-atomic="true"></div>
  <div class="confetti" id="confetti" aria-hidden="true"></div>

  <!-- ===== Question Bank (Edit Inside) ===== -->
  <script type="application/json" id="question-bank">
  {
    "items":[
      /* ---------- FLASHCARDS (shoulder/arm, muscles/bones/innervation) ---------- */
      {"type":"flash","tags":["shoulder","muscles","innervation"],"front":"Deltoid â€” innervation?","back":"Axillary nerve (C5â€“C6)."},
      {"type":"flash","tags":["shoulder","muscles"],"front":"Deltoid (middle fibers) â€” primary action?","back":"Shoulder abduction (~15â€“90Â°)."},
      {"type":"flash","tags":["shoulder","muscles","innervation"],"front":"Teres minor â€” action + innervation?","back":"External (lateral) rotation; axillary nerve."},
      {"type":"flash","tags":["shoulder","muscles","innervation"],"front":"Supraspinatus â€” role + innervation?","back":"Initiates abduction (0â€“15Â°); suprascapular nerve."},
      {"type":"flash","tags":["shoulder","muscles","innervation"],"front":"Infraspinatus â€” action + innervation?","back":"External rotation; suprascapular nerve."},
      {"type":"flash","tags":["shoulder","muscles","innervation"],"front":"Subscapularis â€” action + innervation?","back":"Internal (medial) rotation; upper & lower subscapular nerves."},
      {"type":"flash","tags":["shoulder","muscles"],"front":"Rotator cuff muscles (SITS)?","back":"Supraspinatus, Infraspinatus, Teres minor, Subscapularis."},
      {"type":"flash","tags":["arm","muscles","innervation"],"front":"Biceps brachii â€” major actions + nerve?","back":"Forearm supination; elbow flexion (best when supinated); musculocutaneous nerve (C5â€“C7)."},
      {"type":"flash","tags":["arm","muscles","innervation"],"front":"Brachialis â€” action + nerve?","back":"Primary elbow flexor in all positions; musculocutaneous nerve (C5â€“C6)."},
      {"type":"flash","tags":["arm","muscles","innervation"],"front":"Coracobrachialis â€” action + nerve?","back":"Flexes & adducts shoulder; pierced by musculocutaneous nerve."},
      {"type":"flash","tags":["arm","muscles","innervation"],"front":"Triceps brachii â€” action + nerve?","back":"Elbow extension; long head assists shoulder extension/adduction; radial nerve (C6â€“C8)."},
      {"type":"flash","tags":["shoulder","muscles","innervation"],"front":"Serratus anterior â€” nerve + key function?","back":"Long thoracic nerve (C5â€“C7); protracts & upwardly rotates scapula; stabilizes against thorax."},
      {"type":"flash","tags":["shoulder","muscles","innervation"],"front":"Latissimus dorsi â€” nerve?","back":"Thoracodorsal nerve (C6â€“C8)."},
      {"type":"flash","tags":["shoulder","muscles","innervation"],"front":"Pectoralis major â€” nerves?","back":"Medial & lateral pectoral nerves; adducts & internally rotates shoulder."},
      {"type":"flash","tags":["shoulder","muscles","innervation"],"front":"Pectoralis minor â€” attachments + nerve?","back":"Ribs 3â€“5 to coracoid process; stabilizes scapula; medial pectoral nerve."},
      {"type":"flash","tags":["arm","bones"],"front":"Deltoid tuberosity â€” what & where?","back":"Lateral humerus; insertion for deltoid."},
      {"type":"flash","tags":["arm","bones","innervation"],"front":"Surgical neck of humerus â€” clinical relevance?","back":"Fracture risk to axillary nerve & posterior circumflex humeral artery."},
      {"type":"flash","tags":["arm","bones","innervation"],"front":"Midshaft humerus fracture â€” key nerve risk?","back":"Radial nerve in radial groove â†’ wrist drop."},
      {"type":"flash","tags":["shoulder","bones"],"front":"Quadrangular space â€” contents?","back":"Axillary nerve & posterior circumflex humeral artery."},
      {"type":"flash","tags":["arm","bones"],"front":"Triangular interval â€” contents?","back":"Radial nerve & profunda brachii (deep brachial) artery."},
      {"type":"flash","tags":["arm","bones"],"front":"Intertubercular (bicipital) groove â€” notable content?","back":"Tendon of long head of biceps brachii."},
      {"type":"flash","tags":["shoulder","bones"],"front":"Long head of biceps â€” origin?","back":"Supraglenoid tubercle of scapula."},
      {"type":"flash","tags":["shoulder","bones"],"front":"Short head of biceps â€” origin?","back":"Coracoid process of scapula."},
      {"type":"flash","tags":["shoulder","bones"],"front":"Long head of triceps â€” origin?","back":"Infraglenoid tubercle of scapula."},
      {"type":"flash","tags":["arm","innervation"],"front":"Musculocutaneous nerve â€” terminal sensory branch?","back":"Lateral cutaneous nerve of forearm."},
      {"type":"flash","tags":["shoulder","innervation"],"front":"Axillary nerve â€” sensory patch?","back":"â€˜Regimental badgeâ€™ area over lateral deltoid."},

      /* ---------- MCQ ---------- */
      {"type":"mcq","tags":["shoulder","innervation"],"stem":"Which nerve innervates the deltoid muscle?","options":["Radial","Axillary","Musculocutaneous","Median"],"answerIndex":1,"rationale":"Deltoid (and teres minor) receive axillary nerve (C5â€“C6)."},
      {"type":"mcq","tags":["shoulder","muscles"],"stem":"Which muscle initiates glenohumeral abduction (0â€“15Â°)?","options":["Supraspinatus","Deltoid","Infraspinatus","Subscapularis"],"answerIndex":0,"rationale":"Supraspinatus initiates abduction before the deltoid becomes more effective."},
      {"type":"mcq","tags":["arm","innervation"],"stem":"The anterior compartment of the arm is primarily innervated by which nerve?","options":["Radial","Ulnar","Musculocutaneous","Axillary"],"answerIndex":2,"rationale":"Biceps brachii, brachialis (primarily), and coracobrachialis are musculocutaneous."},
      {"type":"mcq","tags":["arm","innervation","bones"],"stem":"A fracture of the surgical neck of the humerus endangers which nerve?","options":["Radial","Median","Axillary","Ulnar"],"answerIndex":2,"rationale":"Axillary nerve and posterior circumflex humeral artery traverse the quadrangular space and wrap around the surgical neck."},
      {"type":"mcq","tags":["arm","innervation","bones"],"stem":"A midshaft humeral fracture classically injures which nerve?","options":["Ulnar","Radial","Musculocutaneous","Axillary"],"answerIndex":1,"rationale":"The radial nerve lies in the radial groove at the humeral shaftâ€”injury â†’ wrist/finger extensor weakness."},
      {"type":"mcq","tags":["arm","muscles","bones"],"stem":"Which muscle inserts on the deltoid tuberosity?","options":["Deltoid","Teres major","Latissimus dorsi","Pectoralis major"],"answerIndex":0,"rationale":"The deltoid inserts on the deltoid tuberosity (lateral humerus)."},
      {"type":"mcq","tags":["shoulder","bones","innervation"],"stem":"Which structure passes through the quadrangular space along with the posterior circumflex humeral artery?","options":["Radial nerve","Axillary nerve","Musculocutaneous nerve","Ulnar nerve"],"answerIndex":1,"rationale":"Quadrangular space contents: axillary nerve and posterior circumflex humeral artery."},
      {"type":"mcq","tags":["shoulder","innervation","muscles"],"stem":"Injury to the long thoracic nerve primarily weakens which muscle?","options":["Rhomboid major","Serratus anterior","Trapezius","Latissimus dorsi"],"answerIndex":1,"rationale":"Long thoracic â†’ serratus anterior; injury â†’ winged scapula with pushâ€‘up motion."},
      {"type":"mcq","tags":["shoulder","muscles"],"stem":"Which of the following is an external (lateral) rotator of the shoulder?","options":["Subscapularis","Teres major","Infraspinatus","Pectoralis major"],"answerIndex":2,"rationale":"Infraspinatus (and teres minor) laterally rotate the humerus; subscapularis is a medial rotator."},
      {"type":"mcq","tags":["shoulder","bones","muscles"],"stem":"The tendon of which muscle travels in the intertubercular (bicipital) groove?","options":["Biceps brachii long head","Biceps brachii short head","Triceps long head","Brachialis"],"answerIndex":0,"rationale":"The long head biceps tendon runs in the groove enclosed by the transverse humeral ligament."},
      {"type":"mcq","tags":["arm","innervation"],"stem":"Innervation of triceps brachii?","options":["Radial","Axillary","Musculocutaneous","Median"],"answerIndex":0,"rationale":"All heads of triceps are innervated by the radial nerve."},
      {"type":"mcq","tags":["arm","bones","innervation"],"stem":"Which artery typically accompanies the radial nerve through the triangular interval?","options":["Posterior circumflex humeral","Profunda brachii (deep brachial)","Anterior circumflex humeral","Radial recurrent"],"answerIndex":1,"rationale":"Triangular interval contents: radial nerve + profunda brachii artery."},
      {"type":"mcq","tags":["shoulder","muscles"],"stem":"Actions of latissimus dorsi at the shoulder include all EXCEPT:","options":["Adduction","Internal rotation","Abduction","Extension"],"answerIndex":2,"rationale":"Lat dorsi adducts, extends, and medially rotates the humerus; it does not abduct."},
      {"type":"mcq","tags":["shoulder","innervation"],"stem":"Cutaneous sensation over the lateral deltoid (\"regimental badge\" area) is supplied by:","options":["Radial nerve","Axillary nerve","Suprascapular nerve","Lateral pectoral nerve"],"answerIndex":1,"rationale":"The superior lateral cutaneous nerve of the arm is a branch of the axillary nerve."},
      {"type":"mcq","tags":["shoulder","bones","innervation"],"stem":"The axillary nerve is a branch of which cord of the brachial plexus?","options":["Lateral","Medial","Posterior","Superior trunk"],"answerIndex":2,"rationale":"Axillary and radial nerves arise from the posterior cord."},
      {"type":"mcq","tags":["shoulder","bones","muscles"],"stem":"Which muscle originates from the supraglenoid tubercle of the scapula?","options":["Triceps long head","Biceps long head","Biceps short head","Teres minor"],"answerIndex":1,"rationale":"Biceps long head originates from the supraglenoid tubercle; triceps long head from infraglenoid."}
    ]
  }
  </script>

  <script>
    // ===== Utility =====
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const bank = JSON.parse(document.getElementById('question-bank').textContent).items;
    const REGIONS = ['shoulder','arm'];
    const DOMAINS = ['muscles','bones','innervation'];
    let activeFilters = new Set([...REGIONS, ...DOMAINS]);

    const rnd = (n) => Math.floor(Math.random()*n);
    const shuffle = arr => {
      const a = [...arr];
      for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];}
      return a;
    };
    const intersects = (a, b) => a.some(x => b.includes(x));
    const matchesFilters = (item) => {
      const itemTags = item.tags||[];
      const selRegions = REGIONS.filter(t => activeFilters.has(t));
      const selDomains = DOMAINS.filter(t => activeFilters.has(t));
      const itemRegions = itemTags.filter(t=>REGIONS.includes(t));
      const itemDomains = itemTags.filter(t=>DOMAINS.includes(t));
      const regionOK = itemRegions.length===0 || intersects(itemRegions, selRegions);
      const domainOK = itemDomains.length===0 || intersects(itemDomains, selDomains);
      return regionOK && domainOK;
    };

    const tone = 1.5; // micro-copy dial (0-3). User asked for ~1.5
    function say(msg){
      const t = $('#toast');
      t.textContent = msg;
      t.classList.add('show');
      clearTimeout(say._t);
      say._t = setTimeout(()=>t.classList.remove('show'), 1300);
    }
    function micro(type){
      const lines = {
        flip: ["Flip it & rip it.","Quick peek unlocked.","Letâ€™s see the other side."],
        got: ["Nice rep!","Clean form.","Smooth move."],
        again: ["No worriesâ€”one more rep.","We grow on the reps.","Reload & try again."]
      }[type] || [];
      if(!lines.length) return "";
      const pick = lines[rnd(lines.length)];
      // soften tone when dial < 2
      return tone < 2 ? pick.replace(/!$/,'').replace('rip','check') : pick;
    }
    function confettiBurst(){
      if(document.body.classList.contains('reduced-motion')) return;
      const ems = ['ðŸŽ‰','ðŸ’ª','ðŸ‹ï¸','ðŸ¦´','â­','ðŸ”¥'];
      const c = $('#confetti');
      for(let i=0;i<22;i++){
        const b = document.createElement('span');
        b.className='bit';
        b.textContent = ems[rnd(ems.length)];
        b.style.left = (5 + Math.random()*90) + 'vw';
        b.style.top = '-10vh';
        b.style.animationDelay = (Math.random()*0.2) + 's';
        c.appendChild(b);
        setTimeout(()=>b.remove(), 1000);
      }
    }

    // ===== Filters / Toggles =====
    $$('.filters input[type="checkbox"]').forEach(cb=>{
      cb.addEventListener('change', ()=>{
        if(cb.checked) activeFilters.add(cb.dataset.filter);
        else activeFilters.delete(cb.dataset.filter);
        refreshFlashDeck(true);
        mcqStop();
      });
    });
    $('#hcToggle').addEventListener('change', (e)=> {
      document.body.classList.toggle('high-contrast', e.target.checked);
    });
    $('#rmToggle').addEventListener('change', (e)=> {
      document.body.classList.toggle('reduced-motion', e.target.checked);
    });

    // ===== Tabs =====
    const tabs = {
      flash: {btn: $('#tab-flash'), panel: $('#flashcardsPanel')},
      mcq:   {btn: $('#tab-mcq'),   panel: $('#mcqPanel')}
    };
    Object.entries(tabs).forEach(([key, t])=>{
      t.btn.addEventListener('click', ()=>{
        Object.values(tabs).forEach(o=>{o.btn.setAttribute('aria-selected','false'); o.panel.classList.add('hidden'); o.panel.setAttribute('hidden','');});
        t.btn.setAttribute('aria-selected','true');
        t.panel.classList.remove('hidden'); t.panel.removeAttribute('hidden');
        if(key==='flash'){ refreshFlashDeck(false); }
      });
    });

    // ===== Flashcards =====
    let flashDeck = [];
    let deckIndex = 0;
    let showBack = false;
    let streak = 0;

    function currentFlash(){
      return flashDeck[deckIndex] || null;
    }
    function refreshFlashDeck(announce){
      const pool = bank.filter(it => it.type==='flash' && matchesFilters(it));
      flashDeck = shuffle(pool);
      deckIndex = 0; showBack = false; streak = 0;
      updateFlashUI(announce);
    }
    function updateFlashUI(announce){
      const face = $('#flashFace');
      const card = $('#flashCard');
      $('#streak').textContent = String(streak);
      $('#deckCount').textContent = flashDeck.length;
      const remain = flashDeck.length ? (flashDeck.length - deckIndex) : 0;
      $('#deckRemaining').textContent = String(remain);
      const pct = flashDeck.length ? Math.round( (deckIndex/flashDeck.length)*100) : 0;
      $('#progressFill').style.width = pct + '%';

      if(!flashDeck.length){
        face.innerHTML = "No flashcards match your filters.<br><small>Try toggling filters above.</small>";
        $('#flashFlip').disabled = true; $('#flashAgain').disabled = true; $('#flashGot').disabled = true;
        return;
      }
      $('#flashFlip').disabled = false; $('#flashAgain').disabled = false; $('#flashGot').disabled = false;

      const item = currentFlash();
      if(!item){ face.textContent = "Deck complete. Reset or shuffle to go again."; return; }
      card.style.transform = showBack ? 'rotateY(180deg)' : 'rotateY(0deg)';
      face.innerHTML = showBack ? (item.back) : (item.front + '<br><small>Press Space to flip</small>');
      if(announce) say("Deck ready Â· " + flashDeck.length + " cards");
    }
    function nextFlash(){
      deckIndex++;
      showBack = false;
      if(deckIndex >= flashDeck.length){
        $('#flashFace').innerHTML = "ðŸŽ¯ Deck complete â€” smooth work.<br><small>Shuffle or reset to run it back.</small>";
        confettiBurst();
        return;
      }
      updateFlashUI(false);
    }
    function againFlash(){
      const item = currentFlash();
      if(!item) return;
      // Reinsert current card later in the deck
      const insertAt = Math.min(flashDeck.length, deckIndex + 3 + rnd(3));
      flashDeck.splice(insertAt, 0, item);
      deckIndex++; // move past current
      streak = 0;
      say(micro('again'));
      updateFlashUI(false);
    }
    function gotFlash(){
      const item = currentFlash();
      if(!item) return;
      // Remove current card
      flashDeck.splice(deckIndex, 1);
      streak++;
      if(streak>0 && streak % 5 === 0) confettiBurst();
      say(micro('got'));
      if(deckIndex >= flashDeck.length){
        $('#flashFace').innerHTML = "ðŸŽ¯ Deck complete â€” clean set.<br><small>Shuffle or reset to continue.</small>";
        updateFlashUI(false);
        return;
      }
      updateFlashUI(false);
    }

    // Flash events
    $('#flashShuffle').addEventListener('click', ()=>{ refreshFlashDeck(true); });
    $('#flashReset').addEventListener('click', ()=>{ refreshFlashDeck(true); });
    $('#flashFlip').addEventListener('click', ()=>{ showBack = !showBack; say(micro('flip')); updateFlashUI(false); });
    $('#flashAgain').addEventListener('click', againFlash);
    $('#flashGot').addEventListener('click', gotFlash);

    // Keyboard shortcuts (Flashcards)
    document.addEventListener('keydown', (e)=>{
      const flashActive = tabs.flash.btn.getAttribute('aria-selected') === 'true';
      if(!flashActive) return;
      if(e.key===' '){ e.preventDefault(); $('#flashFlip').click(); }
      if(e.key.toLowerCase()==='a'){ $('#flashAgain').click(); }
      if(e.key.toLowerCase()==='g'){ $('#flashGot').click(); }
      if(e.key==='ArrowRight'){ nextFlash(); }
    });

    // ===== MCQ =====
    let mcqSession = null; // {mode, list, idx, score, total}
    const qStem = $('#mcqStem'), qChoices = $('#mcqChoices'), qRat = $('#mcqRationale'), qScore = $('#mcqScore'), qStatus = $('#mcqStatus');

    function mcqStart(){
      const mode = $('#mcqMode').value;
      const pool = bank.filter(it => it.type==='mcq' && matchesFilters(it));
      if(!pool.length){ qStem.textContent = "No MCQs match your filters."; qChoices.innerHTML=''; qRat.classList.add('hidden'); return; }
      let list = shuffle(pool);
      if(mode==='quiz'){
        const n = Math.max(5, Math.min(parseInt($('#quizLen').value||10,10), 30));
        if(list.length > n) list = list.slice(0, n);
      }
      mcqSession = { mode, list, idx:0, score:0, total:0, answered:false };
      say("Quiz loaded Â· " + list.length + " Q");
      renderMCQ();
    }
    function mcqStop(){
      mcqSession = null;
      qStem.textContent = "Press Start";
      qChoices.innerHTML = '';
      qRat.classList.add('hidden');
      qScore.textContent = "0/0";
      qStatus.textContent = "";
    }
    function renderMCQ(){
      if(!mcqSession) return;
      const {list, idx, score, total} = mcqSession;
      if(idx >= list.length){
        qStem.innerHTML = "ðŸŽ‰ Session complete.";
        qChoices.innerHTML = '';
        qRat.classList.add('hidden');
        qScore.textContent = `${score}/${total}`;
        qStatus.textContent = "Nice pace â€” feel free to run another set.";
        confettiBurst();
        return;
      }
      const item = list[idx];
      mcqSession.answered = false;
      qStem.textContent = item.stem;
      qChoices.innerHTML = '';
      const shuffled = shuffle(item.options.map((opt,i)=>({opt, i})));
      qRat.textContent = item.rationale||""; qRat.classList.add('hidden');

      shuffled.forEach((o, k)=>{
        const id = `opt-${idx}-${k}`;
        const wrap = document.createElement('label');
        wrap.className = 'choice';
        wrap.setAttribute('data-state','idle');
        wrap.innerHTML = `
          <input type="radio" name="mcq" id="${id}" value="${o.i}">
          <div><strong>${k+1}.</strong> <span>${o.opt}</span></div>
        `;
        wrap.addEventListener('click', (ev)=>{
          // Prevent double answering
          if(mcqSession.answered) return;
          const chosen = parseInt(wrap.querySelector('input').value,10);
          mcqSession.answered = true;
          const correct = chosen === item.answerIndex;
          mcqSession.total++;
          if(correct){ mcqSession.score++; wrap.dataset.state='correct'; say("Correct."); }
          else{ wrap.dataset.state='wrong'; say("Not quite."); }
          // mark the correct one
          $$('#mcqChoices .choice').forEach(ch=>{
            const val = parseInt(ch.querySelector('input').value,10);
            if(val === item.answerIndex){ ch.dataset.state='correct'; }
            ch.querySelector('input').disabled = true;
          });
          qRat.classList.remove('hidden');
          qScore.textContent = `${mcqSession.score}/${mcqSession.total}`;
        }, {once:false});
        qChoices.appendChild(wrap);
      });
      qStatus.textContent = `Q ${idx+1} of ${list.length}`;
    }
    $('#mcqNext').addEventListener('click', ()=>{
      if(!mcqSession) return;
      mcqSession.idx++;
      renderMCQ();
    });
    $('#mcqStart').addEventListener('click', mcqStart);
    $('#mcqStop').addEventListener('click', mcqStop);
    $('#mcqMode').addEventListener('change', (e)=>{
      $('#quizLenWrap').style.visibility = e.target.value==='quiz' ? 'visible' : 'hidden';
    });
    document.addEventListener('keydown', (e)=>{
      const mcqActive = tabs.mcq.btn.getAttribute('aria-selected') === 'true';
      if(!mcqActive || !mcqSession) return;
      if(e.key.toLowerCase()==='n'){ $('#mcqNext').click(); }
      // Number keys choose options
      const num = parseInt(e.key,10);
      if(!isNaN(num) && num>=1 && num<=9){
        const nth = $(`#mcqChoices .choice:nth-child(${num})`);
        if(nth){ nth.click(); }
      }
    });

    // Init
    refreshFlashDeck(true);
    $('#quizLenWrap').style.visibility = $('#mcqMode').value==='quiz' ? 'visible' : 'hidden';
  </script>

  <footer>
    Singleâ€‘file app Â· Edit the <strong>questionâ€‘bank</strong> JSON above to add/modify items.
    <br/>When youâ€™re ready for diagrams, add <code>"image":"path-or-url","alt":"desc"</code> to any item (weâ€™ll wire display later).
  </footer>
</body>
</html>
