<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>KIN100 Flashcards</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121925; --card2:#0f1622; --text:#e8eef7; --muted:#a8b3c7;
      --accent:#69b3ff; --good:#3ddc97; --bad:#ff6b6b; --warn:#ffd166;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 50% -10%, rgba(105,179,255,.25), transparent 55%),
                  radial-gradient(800px 600px at 10% 20%, rgba(61,220,151,.12), transparent 55%),
                  radial-gradient(900px 700px at 90% 30%, rgba(255,209,102,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      display:flex; flex-direction:column;
      padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom) 14px;
    }

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:10px 0 12px 0;
    }
    .left, .right{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      font-size: 13px;
    }
    .btn{
      appearance:none; border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px; border-radius:12px;
      font-weight:600; font-size:14px;
      cursor:pointer;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{background: rgba(105,179,255,.16); border-color: rgba(105,179,255,.32)}
    .btn.ghost{background: transparent}
    .btn.small{padding:8px 10px; border-radius:10px; font-size:13px}
    .btn.danger{background: rgba(255,107,107,.14); border-color: rgba(255,107,107,.28)}
    .btn.good{background: rgba(61,220,151,.14); border-color: rgba(61,220,151,.28)}
    .btn.warn{background: rgba(255,209,102,.14); border-color: rgba(255,209,102,.28)}

    .wrap{
      flex:1;
      display:flex; align-items:center; justify-content:center;
      padding: 10px 0 18px 0;
    }

    .cardWrap{
      width: min(440px, 92vw);
      height: min(560px, 72vh);
      perspective: 1100px;
    }

    .card{
      width:100%; height:100%;
      position:relative;
      transform-style: preserve-3d;
      transition: transform .55s cubic-bezier(.2,.8,.2,1);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .card.flipped{transform: rotateY(180deg)}
    .side{
      position:absolute; inset:0;
      border-radius: var(--radius);
      overflow:hidden;
      backface-visibility: hidden;
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    }

    /* Back (image cover) */
    .cover{
      display:flex; flex-direction:column; justify-content:flex-end;
      background: radial-gradient(1200px 700px at 50% 10%, rgba(105,179,255,.18), rgba(255,255,255,.03)),
                  linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.12));
    }
    .coverImg{
      position:absolute; inset:0;
      width:100%; height:100%; object-fit:cover;
      filter: saturate(1.08) contrast(1.05);
      transform: scale(1.02);
    }
    .coverOverlay{
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.55));
    }
    .coverMeta{
      position:relative;
      padding: 14px 14px 12px 14px;
    }
    .coverTitle{
      font-size:16px; font-weight:800; letter-spacing:.2px;
      margin:0 0 6px 0;
    }
    .coverSub{
      margin:0;
      font-size: 13px;
      color: rgba(232,238,247,.85);
      line-height: 1.35;
    }
    .tapHint{
      margin-top:10px;
      display:flex; gap:8px; flex-wrap:wrap;
      color: rgba(232,238,247,.75);
      font-size: 12px;
    }
    .kbd{
      display:inline-flex; align-items:center; justify-content:center;
      min-width: 26px;
      padding: 3px 7px;
      border-radius: 8px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight:700;
      color: rgba(232,238,247,.9);
    }

    /* Front (question) */
    .front{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      transform: rotateY(180deg);
      display:flex; flex-direction:column;
    }
    .qHead{
      padding: 14px 14px 10px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
    }
    .qLab{
      font-size: 12px;
      color: rgba(232,238,247,.72);
      margin: 0 0 6px 0;
    }
    .qText{
      margin:0;
      font-size: 18px;
      font-weight: 850;
      line-height: 1.25;
    }

    .qBody{
      padding: 12px 14px 12px 14px;
      display:flex; flex-direction:column;
      gap:10px;
      overflow:auto;
    }
    .choices{display:flex; flex-direction:column; gap:10px}
    .choice{
      display:flex; gap:10px; align-items:flex-start;
      padding:12px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      cursor:pointer;
      user-select:none;
    }
    .choice strong{display:inline-block; width:22px; opacity:.9}
    .choice .label{flex:1; font-weight:650; line-height:1.25}
    .choice.selected{outline: 2px solid rgba(105,179,255,.55); background: rgba(105,179,255,.10)}
    .choice.correct{outline: 2px solid rgba(61,220,151,.65); background: rgba(61,220,151,.12)}
    .choice.wrong{outline: 2px solid rgba(255,107,107,.65); background: rgba(255,107,107,.12)}
    .feedback{
      padding:10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      color: rgba(232,238,247,.9);
      display:none;
      line-height:1.35;
      font-size: 14px;
    }
    .feedback.show{display:block}
    .feedback.good{border-color: rgba(61,220,151,.35)}
    .feedback.bad{border-color: rgba(255,107,107,.35)}
    .feedback.warn{border-color: rgba(255,209,102,.35)}
    .explanation{
      margin-top:8px;
      padding:8px 10px;
      border-radius:10px;
      background: rgba(105,179,255,.08);
      border: 1px solid rgba(105,179,255,.18);
      font-size:13px;
      line-height:1.4;
      color: rgba(232,238,247,.88);
    }
    .explanation strong{color: var(--accent); font-weight:700}

    .actions{
      padding: 12px 14px 14px 14px;
      border-top: 1px solid rgba(255,255,255,.10);
      display:flex; gap:10px; justify-content:space-between; flex-wrap:wrap;
      background: rgba(0,0,0,.10);
    }
    .actions .group{display:flex; gap:10px; flex-wrap:wrap}

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modalBack.show{display:flex}
    .modal{
      width: min(720px, 96vw);
      max-height: min(86vh, 820px);
      overflow:auto;
      background: rgba(18,25,37,.98);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .modal h2{margin: 4px 0 10px 0; font-size: 18px}
    .modal p{margin: 0 0 10px 0; color: rgba(232,238,247,.78); font-size: 13px; line-height:1.35}

    /* ── Settings: Full-screen editorial takeover ── */
    #settingsModalBack{
      background: rgba(6,8,12,.92);
      backdrop-filter: blur(30px) saturate(1.4);
      -webkit-backdrop-filter: blur(30px) saturate(1.4);
      padding: 0;
    }
    #settingsModalBack .modal{
      width: 100%; max-width: 100%; max-height: 100%;
      height: 100%;
      background: transparent;
      border: none;
      border-radius: 0;
      box-shadow: none;
      padding: 0;
      display: flex;
      flex-direction: column;
    }
    .setup-scroll{
      flex:1; overflow:auto;
      padding: 0 20px 40px 20px;
    }
    @media (min-width: 760px){
      .setup-scroll{ padding: 0 48px 60px 48px }
    }

    /* Hero */
    .setup-hero{
      padding: 48px 20px 0 20px;
      text-align: center;
      position: relative;
    }
    @media (min-width: 760px){
      .setup-hero{ padding: 56px 48px 0 48px }
    }
    .setup-hero .overline{
      display: inline-block;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 4px;
      text-transform: uppercase;
      color: rgba(105,179,255,.7);
      margin-bottom: 10px;
    }
    .setup-hero h1{
      margin: 0;
      font-size: clamp(32px, 6vw, 56px);
      font-weight: 900;
      letter-spacing: -1.5px;
      line-height: 1.05;
      background: linear-gradient(135deg, #e8eef7 0%, #69b3ff 40%, #3ddc97 70%, #ffd166 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .setup-hero .sub{
      margin: 12px auto 0 auto;
      max-width: 420px;
      font-size: 14px;
      color: rgba(232,238,247,.5);
      line-height: 1.45;
      font-weight: 500;
    }
    .setup-topbar{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px 0 20px;
    }
    @media (min-width: 760px){
      .setup-topbar{ padding: 20px 48px 0 48px }
    }
    .setup-topbar .ghost-close{
      appearance: none; border: none; background: none;
      color: rgba(232,238,247,.4);
      font-size: 13px; font-weight: 600;
      cursor: pointer;
      letter-spacing: 2px;
      text-transform: uppercase;
      transition: color .2s;
    }
    .setup-topbar .ghost-close:hover{ color: rgba(232,238,247,.8) }
    .setup-version{
      font-size: 11px;
      color: rgba(232,238,247,.25);
      letter-spacing: 2px;
      font-weight: 600;
    }

    /* Region quick-select bar */
    .region-bar{
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
      margin: 28px 0 8px 0;
    }
    .region-chip{
      appearance: none;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: rgba(232,238,247,.65);
      padding: 7px 16px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: .5px;
      cursor: pointer;
      transition: all .2s;
    }
    .region-chip:hover{
      background: rgba(255,255,255,.08);
      color: rgba(232,238,247,.9);
      border-color: rgba(255,255,255,.2);
    }
    .region-chip.active{
      background: rgba(105,179,255,.15);
      border-color: rgba(105,179,255,.4);
      color: var(--accent);
    }

    /* Section headers */
    .section-label{
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: rgba(232,238,247,.3);
      margin: 32px 0 14px 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .section-label::after{
      content: '';
      flex: 1;
      height: 1px;
      background: rgba(255,255,255,.06);
    }

    /* Lab tiles grid */
    .lab-grid{
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 480px){
      .lab-grid{ grid-template-columns: 1fr 1fr }
    }
    @media (min-width: 760px){
      .lab-grid{ grid-template-columns: 1fr 1fr 1fr }
    }

    .lab-tile{
      position: relative;
      display: flex;
      flex-direction: column;
      padding: 14px 14px 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.07);
      background: rgba(255,255,255,.03);
      cursor: pointer;
      transition: all .25s cubic-bezier(.2,.8,.2,1);
      overflow: hidden;
      user-select: none;
    }
    .lab-tile::before{
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 16px;
      opacity: 0;
      transition: opacity .25s;
    }
    .lab-tile:hover{
      border-color: rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      transform: translateY(-2px);
    }
    .lab-tile.selected{
      border-color: rgba(105,179,255,.35);
      background: rgba(105,179,255,.08);
    }
    .lab-tile.selected::before{
      opacity: 1;
      background: linear-gradient(135deg, rgba(105,179,255,.06), transparent 60%);
    }
    .lab-tile .tile-num{
      font-size: 28px;
      font-weight: 900;
      letter-spacing: -1px;
      line-height: 1;
      color: rgba(232,238,247,.12);
      transition: color .25s;
      margin-bottom: 8px;
    }
    .lab-tile.selected .tile-num{
      color: rgba(105,179,255,.35);
    }
    .lab-tile .tile-name{
      font-size: 13px;
      font-weight: 800;
      color: rgba(232,238,247,.85);
      margin-bottom: 3px;
    }
    .lab-tile .tile-topic{
      font-size: 11px;
      color: rgba(232,238,247,.4);
      line-height: 1.3;
      font-weight: 500;
    }
    .lab-tile .tile-check{
      position: absolute;
      top: 10px; right: 12px;
      width: 20px; height: 20px;
      border-radius: 6px;
      border: 1.5px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.2);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .2s;
      font-size: 12px;
      color: transparent;
    }
    .lab-tile.selected .tile-check{
      border-color: var(--accent);
      background: rgba(105,179,255,.2);
      color: var(--accent);
    }

    /* Count badge */
    .select-count{
      text-align: center;
      margin: 16px 0 0 0;
      font-size: 13px;
      color: rgba(232,238,247,.35);
      font-weight: 600;
    }
    .select-count strong{
      color: var(--accent);
      font-weight: 900;
      font-size: 15px;
    }

    /* Mode cards */
    .mode-row{
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 520px){
      .mode-row{ grid-template-columns: 1fr }
    }
    .mode-card{
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 20px 14px 16px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.07);
      background: rgba(255,255,255,.03);
      cursor: pointer;
      transition: all .25s cubic-bezier(.2,.8,.2,1);
      user-select: none;
    }
    .mode-card:hover{
      border-color: rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      transform: translateY(-2px);
    }
    .mode-card.selected{
      border-color: rgba(105,179,255,.35);
      background: rgba(105,179,255,.08);
    }
    .mode-card .mode-icon{
      font-size: 28px;
      margin-bottom: 8px;
      filter: grayscale(.6);
      transition: filter .25s;
    }
    .mode-card.selected .mode-icon{ filter: grayscale(0) }
    .mode-card .mode-title{
      font-size: 15px;
      font-weight: 800;
      letter-spacing: -.3px;
      color: rgba(232,238,247,.85);
    }
    .mode-card .mode-desc{
      font-size: 11px;
      color: rgba(232,238,247,.4);
      line-height: 1.35;
      margin-top: 4px;
    }
    .mode-card input[type="radio"]{ display: none }

    /* Config panel */
    .config-panel{
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.07);
      border-radius: 16px;
      padding: 16px;
      max-width: 480px;
      margin: 0 auto;
    }
    .config-row{
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: flex-end;
    }
    .config-field{
      display: flex;
      flex-direction: column;
      gap: 5px;
      flex: 1;
      min-width: 130px;
    }
    .config-field label{
      font-size: 11px;
      color: rgba(232,238,247,.4);
      font-weight: 600;
      letter-spacing: .5px;
      text-transform: uppercase;
    }
    .config-field input,
    .config-field select{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.2);
      color: var(--text);
      outline: none;
      font-weight: 700;
      font-size: 14px;
    }
    .config-field input:focus,
    .config-field select:focus{
      border-color: rgba(105,179,255,.35);
    }

    /* Launch button */
    .launch-row{
      display: flex;
      gap: 12px;
      justify-content: center;
      align-items: center;
      margin: 32px 0 0 0;
    }
    .btn-launch{
      appearance: none;
      border: none;
      padding: 14px 48px;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 800;
      letter-spacing: .5px;
      cursor: pointer;
      color: #0b0f14;
      background: linear-gradient(135deg, #69b3ff, #3ddc97);
      box-shadow: 0 4px 24px rgba(105,179,255,.25), 0 0 0 1px rgba(105,179,255,.15);
      transition: all .25s cubic-bezier(.2,.8,.2,1);
    }
    .btn-launch:hover{
      transform: translateY(-2px);
      box-shadow: 0 8px 32px rgba(105,179,255,.35), 0 0 0 1px rgba(105,179,255,.25);
    }
    .btn-launch:active{ transform: translateY(0) }
    .btn-reset{
      appearance: none;
      border: 1px solid rgba(255,107,107,.2);
      background: rgba(255,107,107,.06);
      color: rgba(255,107,107,.7);
      padding: 14px 20px;
      border-radius: 14px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all .2s;
    }
    .btn-reset:hover{
      background: rgba(255,107,107,.12);
      color: rgba(255,107,107,.9);
    }

    .setup-footer{
      text-align: center;
      margin-top: 24px;
      font-size: 11px;
      color: rgba(232,238,247,.2);
      letter-spacing: 1px;
    }

    /* Stagger animation */
    @keyframes tileIn{
      from{ opacity:0; transform: translateY(12px) }
      to{ opacity:1; transform: translateY(0) }
    }
    .lab-tile, .mode-card{
      animation: tileIn .4s cubic-bezier(.2,.8,.2,1) both;
    }

    /* Legacy panel/grid/labs kept for non-settings modals */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 760px){
      .grid{grid-template-columns: 1.2fr .8fr}
    }
    .panel{
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 12px;
    }
    .panel h3{margin:0 0 10px 0; font-size:14px; color: rgba(232,238,247,.92)}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .field{
      display:flex; flex-direction:column; gap:6px;
      min-width: 140px;
    }
    .field label{font-size: 12px; color: rgba(232,238,247,.75)}
    .field input, .field select{
      padding: 10px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      color: var(--text);
      outline:none;
      font-weight:700;
    }

    .help{
      font-size: 12px;
      color: rgba(232,238,247,.75);
      line-height:1.35;
      margin-top:10px;
    }
    .hr{height:1px; background: rgba(255,255,255,.10); margin: 10px 0}

    /* Exam results modal */
    .resultsList{
      display:flex; flex-direction:column; gap:10px;
    }
    .resultCard{
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px;
    }
    .resultCard .meta{font-size:12px; color: rgba(232,238,247,.75); margin-bottom:6px}
    .resultCard .qt{font-weight:850; margin:0 0 6px 0}
    .resultCard .ans{font-size:13px; color: rgba(232,238,247,.9); line-height:1.35}
    .badge{
      display:inline-flex; align-items:center;
      padding:4px 8px; border-radius:999px;
      font-size:12px; font-weight:900;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      margin-left:8px;
    }
    .badge.good{border-color: rgba(61,220,151,.35); background: rgba(61,220,151,.10)}
    .badge.bad{border-color: rgba(255,107,107,.35); background: rgba(255,107,107,.10)}
  </style>
</head>
<body>

  <div class="topbar">
    <div class="left">
      <span class="pill" id="modePill">Mode: —</span>
      <button class="btn small" id="settingsBtn" title="Settings (Esc)">Settings</button>
      <button class="btn small ghost" id="helpBtn" title="Shortcuts (?)">?</button>
    </div>
    <div class="right">
      <span class="pill" id="labPill">Labs: —</span>
      <span class="pill" id="progressPill">0 / 0</span>
      <span class="pill" id="timerPill" style="display:none;">Time: —</span>
    </div>
  </div>

  <div class="wrap">
    <div class="cardWrap">
      <div class="card" id="card">
        <!-- COVER (image side) -->
        <div class="side cover" id="coverSide">
          <img class="coverImg" id="coverImg" alt="" />
          <div class="coverOverlay"></div>
          <div class="coverMeta">
            <p class="coverTitle" id="coverTitle">KIN100 Flashcards</p>
            <p class="coverSub" id="coverSub">Tap to flip. Use selected labs to study.</p>
            <div class="tapHint">
              <span><span class="kbd">Space</span> flip</span>
              <span><span class="kbd">1–4</span> choose</span>
              <span><span class="kbd">Enter</span> submit</span>
              <span><span class="kbd">Esc</span> settings</span>
            </div>
          </div>
        </div>

        <!-- FRONT (question side) -->
        <div class="side front">
          <div class="qHead">
            <p class="qLab" id="qLab">—</p>
            <p class="qText" id="qText">—</p>
          </div>

          <div class="qBody">
            <div class="choices" id="choices"></div>
            <div class="feedback" id="feedback"></div>
          </div>

          <div class="actions">
            <div class="group">
              <button class="btn small ghost" id="flipBtn" title="Flip (Space)">Flip</button>
              <button class="btn small warn" id="revealBtn" title="Reveal (R) - Learn mode only">Reveal</button>
            </div>
            <div class="group">
              <button class="btn small primary" id="submitBtn" title="Submit (Enter)">Submit</button>
              <button class="btn small good" id="nextBtn" title="Next (N)">Next</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SETTINGS MODAL -->
  <div class="modalBack" id="settingsModalBack" role="dialog" aria-modal="true">
    <div class="modal">

      <div class="setup-topbar">
        <span class="setup-version">KIN 100</span>
        <button class="ghost-close" id="closeSettingsBtn">ESC</button>
      </div>

      <div class="setup-hero">
        <span class="overline">Anatomy Lab</span>
        <h1>What are we<br>studying today?</h1>
        <p class="sub">Pick your regions. Choose your pain threshold. Begin.</p>
      </div>

      <div class="setup-scroll">

        <!-- Region quick-select -->
        <div class="region-bar" id="regionBar">
          <button class="region-chip" data-region="all">Everything</button>
          <button class="region-chip" data-region="upper">Upper Limb</button>
          <button class="region-chip" data-region="lower">Lower Limb</button>
          <button class="region-chip" data-region="core">Trunk &amp; Pelvis</button>
          <button class="region-chip" data-region="neuro">Neuro</button>
          <button class="region-chip" data-region="none">Clear</button>
        </div>

        <div class="select-count" id="selectCount">
          <strong>0</strong> labs selected &middot; <strong>0</strong> questions in pool
        </div>

        <!-- Lab tiles -->
        <div class="section-label">Select Labs</div>
        <div class="lab-grid" id="labsList"></div>

        <!-- Mode -->
        <div class="section-label">Mode</div>
        <div class="mode-row" id="modeRow">
          <label class="mode-card" data-mode="learn">
            <input type="radio" name="mode" value="learn">
            <div class="mode-icon">&#x1f9e0;</div>
            <div class="mode-title">Learn</div>
            <div class="mode-desc">Reveal answers at your pace. No pressure.</div>
          </label>
          <label class="mode-card" data-mode="test">
            <input type="radio" name="mode" value="test">
            <div class="mode-icon">&#x1f4dd;</div>
            <div class="mode-title">Test</div>
            <div class="mode-desc">Submit to see feedback. Builds accountability.</div>
          </label>
          <label class="mode-card" data-mode="exam">
            <input type="radio" name="mode" value="exam">
            <div class="mode-icon">&#x23f1;&#xfe0f;</div>
            <div class="mode-title">Exam</div>
            <div class="mode-desc">No feedback until the end. Timed. Real stakes.</div>
          </label>
        </div>

        <!-- Config -->
        <div class="section-label">Configure</div>
        <div class="config-panel">
          <div id="examFields" style="display:none;">
            <div class="config-row">
              <div class="config-field">
                <label for="examCount">Questions</label>
                <input id="examCount" type="number" min="5" max="220" value="20" />
              </div>
              <div class="config-field">
                <label for="examTime">Time limit (min)</label>
                <input id="examTime" type="number" min="0" max="180" value="0" />
              </div>
            </div>
          </div>
          <div id="studyFields">
            <div class="config-row">
              <div class="config-field">
                <label for="sessionCount">Questions</label>
                <select id="sessionCount">
                  <option value="20">20</option>
                  <option value="30" selected>30</option>
                  <option value="50">50</option>
                  <option value="9999">All available</option>
                </select>
              </div>
              <div class="config-field">
                <label for="remember">Remember</label>
                <select id="remember">
                  <option value="yes" selected>Yes</option>
                  <option value="no">No</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- Launch -->
        <div class="launch-row">
          <button class="btn-reset" id="resetBtn">Reset</button>
          <button class="btn-launch" id="startBtn">Begin Session</button>
        </div>

        <div class="setup-footer">
          <span class="kbd">Space</span> flip &middot;
          <span class="kbd">1-4</span> choose &middot;
          <span class="kbd">Enter</span> submit &middot;
          <span class="kbd">N</span> next &middot;
          <span class="kbd">?</span> help
        </div>

      </div>
    </div>
  </div>

  <!-- HELP MODAL -->
  <div class="modalBack" id="helpModalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <h2>Keyboard Shortcuts</h2>
        <button class="btn small ghost" id="closeHelpBtn">Close</button>
      </div>
      <div class="panel">
        <div class="help" style="font-size:13px;">
          <div class="row" style="gap:14px;">
            <span><span class="kbd">Space</span> Flip card</span>
            <span><span class="kbd">1</span>–<span class="kbd">4</span> Select choice</span>
            <span><span class="kbd">Enter</span> Submit (or advance if already submitted)</span>
          </div>
          <div class="row" style="gap:14px; margin-top:10px;">
            <span><span class="kbd">N</span> Next</span>
            <span><span class="kbd">R</span> Reveal (Learn mode)</span>
            <span><span class="kbd">Esc</span> Settings</span>
            <span><span class="kbd">?</span> Open this help</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- EXAM RESULTS MODAL -->
  <div class="modalBack" id="resultsModalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <h2>Exam Results</h2>
        <button class="btn small ghost" id="closeResultsBtn">Close</button>
      </div>
      <p id="resultsSummary">—</p>
      <div class="resultsList" id="resultsList"></div>
      <div class="hr"></div>
      <div class="row" style="justify-content:flex-end;">
        <button class="btn primary" id="restartBtn">Start New Session</button>
      </div>
    </div>
  </div>

<script>
/* =========================================================
   EDIT THIS: Add your own images in /images and list them here.
   If an image fails to load, a placeholder will appear instead.
========================================================= */
const LAB_IMAGES = {
  1: ["images/lab1_01.jpg","images/lab1_02.jpg"],
  2: ["images/lab2_01.jpg","images/lab2_02.jpg"],
  3: ["images/lab3_01.jpg","images/lab3_02.jpg"],
  4: ["images/lab4_01.jpg","images/lab4_02.jpg"],
  5: ["images/lab5_01.jpg","images/lab5_02.jpg"],
  6: ["images/lab6_01.jpg","images/lab6_02.jpg"],
  7: ["images/lab7_01.jpg","images/lab7_02.jpg"],
  8: ["images/lab8_01.jpg","images/lab8_02.jpg"],
  9: ["images/lab9_01.jpg","images/lab9_02.jpg"],
 10: ["images/lab10_01.jpg","images/lab10_02.jpg"],
 11: ["images/lab11_01.jpg","images/lab11_02.jpg"]
};

const LABS = [
  {id:1,  name:"Lab 1",  topic:"Back and Pectoral Girdle"},
  {id:2,  name:"Lab 2",  topic:"Axio-Appendicular and Scapulohumeral Muscles"},
  {id:3,  name:"Lab 3",  topic:"Axilla, Brachial Plexus, and Heart"},
  {id:4,  name:"Lab 4",  topic:"Arm, Cubital Fossa, and Elbow Joint"},
  {id:5,  name:"Lab 5",  topic:"Anterior and Posterior Forearm"},
  {id:6,  name:"Lab 6",  topic:"Wrist and Hand"},
  {id:7,  name:"Lab 7",  topic:"Abdominal Walls, Pelvis, and Hip Joint"},
  {id:8,  name:"Lab 8",  topic:"Gluteal Region and Thigh"},
  {id:9,  name:"Lab 9",  topic:"Knee Joint, Ankle Joints, and Bones of the Foot"},
  {id:10, name:"Lab 10", topic:"Muscles of the Leg and Foot"},
  {id:11, name:"Lab 11", topic:"Introduction to Neuroanatomy"}
];

/* =========================================================
   QUESTION BANK (20 per lab, MC)
   Format per line:
   prompt<TAB>A<TAB>B<TAB>C<TAB>D<TAB>CorrectLetter
========================================================= */
const QUESTION_DATA = {
1: `
Scapular protraction is mainly produced by	Serratus anterior	Rhomboid major	Trapezius	Levator scapulae	A	Serratus anterior attaches along the medial border of the scapula and pulls it anterolaterally against the thoracic wall.
Scapular retraction is strongly produced by	Rhomboid major	Serratus anterior	Pectoralis minor	Subscapularis	A	Rhomboid major runs from the spinous processes to the medial scapular border, pulling the scapula toward the midline.
Scapular elevation is a primary action of	Levator scapulae	Lower trapezius	Serratus anterior	Teres major	A	Levator scapulae originates from the transverse processes of C1-C4 and inserts on the superior angle of the scapula, elevating it.
Scapular depression is a key action of	Lower trapezius	Upper trapezius	Rhomboid major	Deltoid	A	The lower fibers of trapezius pull the scapula inferiorly, counterbalancing the upper trapezius and levator scapulae.
Which bone has the acromion process?	Scapula	Clavicle	Sternum	Humerus	A	The acromion is the lateral extension of the scapular spine, forming the bony point of the shoulder.
Joint between clavicle and sternum	Sternoclavicular joint	Acromioclavicular joint	Glenohumeral joint	Costovertebral joint	A	The sternoclavicular joint is the only bony articulation between the upper limb and the axial skeleton.
Vertebrae with costal facets for ribs	Thoracic	Cervical	Lumbar	Sacral	A	Thoracic vertebrae have superior and inferior costal facets on their bodies and transverse costal facets for rib articulation.
Transverse foramina are characteristic of	Cervical	Thoracic	Lumbar	Sacral	A	Transverse foramina are unique to cervical vertebrae and transmit the vertebral arteries (C1-C6).
Muscle forming posterior axillary fold	Latissimus dorsi	Biceps brachii	Pectoralis minor	Pronator teres	A	Latissimus dorsi forms the posterior axillary fold as it courses toward its insertion on the intertubercular groove of the humerus.
Primary nerve supply to serratus anterior	Long thoracic nerve	Axillary nerve	Radial nerve	Ulnar nerve	A	The long thoracic nerve (C5-C7) runs along the superficial surface of serratus anterior on the thoracic wall.
Classic "winged scapula" lesion	Long thoracic nerve	Suprascapular nerve	Median nerve	Musculocutaneous nerve	A	Damage to the long thoracic nerve denervates serratus anterior, causing the medial border of the scapula to protrude.
Trapezius inserts on lateral third of	Clavicle	Scapular medial border	Humeral shaft	Radius	A	Trapezius inserts on the lateral third of the clavicle, the acromion, and the spine of the scapula.
Spine of scapula continues laterally as	Acromion	Coracoid	Olecranon	Greater tubercle	A	The scapular spine extends laterally and flattens into the acromion, which articulates with the clavicle at the AC joint.
The clavicle most often fractures at	Middle third	Medial end	Lateral end	Sternal angle	A	The middle third is the thinnest part and lacks ligamentous reinforcement, making it the most vulnerable to fracture.
The pectoral girdle consists of	Clavicle and scapula	Humerus and radius	Ulna and radius	Sternum and ribs	A	The pectoral girdle consists of the clavicle anteriorly and the scapula posteriorly, connecting the upper limb to the axial skeleton.
Scapulothoracic "joint" is best described as	A functional articulation	A synovial hinge	A cartilaginous joint	A fibrous joint	A	The scapulothoracic joint is not a true synovial joint but a functional articulation where the scapula glides over the thoracic wall.
Facet joints of vertebrae are also called	Zygapophyseal joints	Costovertebral joints	Sacroiliac joints	Symphyses	A	Facet joints are synovial joints between the superior and inferior articular processes of adjacent vertebrae.
Rhomboid major attaches to the	Medial border of scapula	Lateral epicondyle	Deltoid tuberosity	Coracoid process	A	Rhomboid major attaches from the T2-T5 spinous processes to the medial border of the scapula below the scapular spine.
Trapezius is innervated primarily by	Spinal accessory nerve (CN XI)	Long thoracic nerve	Axillary nerve	Phrenic nerve	A	The spinal accessory nerve (CN XI) provides motor innervation to the trapezius, with C3-C4 contributing proprioception.
Floating ribs are typically ribs	11 and 12	1 and 2	7 and 8	3 and 4	A	Ribs 11 and 12 are called floating ribs because they lack anterior cartilaginous attachments to the sternum.
`.trim(),

2: `
Supraspinatus primarily initiates	Abduction of the arm	Adduction of the arm	Elbow flexion	Wrist extension	A	Supraspinatus initiates the first 15 degrees of arm abduction before the deltoid takes over as the primary abductor.
Infraspinatus is best known for	External rotation	Internal rotation	Elbow extension	Forearm pronation	A	Infraspinatus is the primary external rotator of the shoulder, originating from the infraspinous fossa of the scapula.
Subscapularis primarily produces	Internal rotation	External rotation	Elbow flexion	Scapular elevation	A	Subscapularis lies on the anterior surface of the scapula and is the strongest internal rotator of the rotator cuff.
Teres minor contributes most to	External rotation	Scapular protraction	Hip extension	Wrist flexion	A	Teres minor assists infraspinatus in external rotation and also helps stabilize the humeral head in the glenoid.
Rotator cuff muscles include	Supraspinatus, infraspinatus, teres minor, subscapularis	Deltoid, biceps, triceps, brachialis	Pectoralis major, latissimus dorsi, trapezius, rhomboids	Rectus abdominis, obliques, transversus	A	The rotator cuff comprises Supraspinatus, Infraspinatus, Teres minor, and Subscapularis (SITS), collectively stabilizing the glenohumeral joint.
Deltoid is a prime mover for	Abduction after ~15°	Forearm pronation	Knee extension	Ankle dorsiflexion	A	After supraspinatus initiates abduction, the deltoid (especially its middle fibers) becomes the primary abductor from about 15 to 90 degrees.
Pectoralis major primarily	Adducts and internally rotates arm	Extends elbow	Protracts scapula	Dorsiflexes ankle	A	Pectoralis major has clavicular and sternocostal heads that converge on the intertubercular groove, producing adduction, flexion, and internal rotation.
Pectoralis minor primarily acts to	Protract and depress scapula	Extend wrist	Flex hip	Extend knee	A	Pectoralis minor runs from ribs 3-5 to the coracoid process, pulling the scapula anteriorly and inferiorly.
Teres major primarily	Adducts and internally rotates arm	Extends knee	Everts foot	Supinates forearm	A	Teres major originates from the inferior angle of the scapula and acts synergistically with latissimus dorsi for adduction and internal rotation.
Latissimus dorsi primarily	Extends and adducts arm	Flexes knee	Protracts scapula	Abducts hip	A	Latissimus dorsi is the broadest back muscle, originating from the thoracolumbar fascia and inserting on the humerus for powerful extension and adduction.
Serratus anterior helps	Upwardly rotate scapula	Downwardly rotate scapula	Flex elbow	Extend knee	A	The lower fibers of serratus anterior rotate the glenoid upward, which is essential for overhead arm elevation.
Upper trapezius assists with	Scapular elevation	Scapular depression	Forearm pronation	Ankle inversion	A	The upper fibers of trapezius elevate the scapula and are commonly overactivated in poor posture.
Lower trapezius assists with	Scapular depression and upward rotation	Scapular elevation	Wrist flexion	Toe extension	A	Lower trapezius depresses the scapula while assisting with upward rotation during overhead movements.
A common site of rotator cuff impingement is the	Supraspinatus tendon	Pectoralis minor tendon	Achilles tendon	Patellar ligament	A	The supraspinatus tendon passes through the narrow subacromial space and is the most commonly impinged rotator cuff structure.
Muscle that stabilizes scapula against thorax	Serratus anterior	Pronator teres	Flexor carpi ulnaris	Extensor digitorum	A	Serratus anterior holds the scapula against the thoracic wall during pushing movements and overhead reaching.
Which is NOT a rotator cuff muscle?	Teres major	Teres minor	Supraspinatus	Subscapularis	A	Teres major is often confused with the rotator cuff muscles but is not one of the four SITS muscles.
Scapulohumeral muscles attach from scapula to	Humerus	Radius	Ulna	Femur	A	Scapulohumeral muscles originate from the scapula and insert on the humerus to move and stabilize the glenohumeral joint.
Scapular upward rotation is essential for	Overhead abduction	Knee extension	Toe flexion	Hip adduction	A	Upward rotation by trapezius and serratus anterior tilts the glenoid superiorly, allowing full overhead abduction.
Subacromial bursa reduces friction under the	Acromion	Olecranon	Patella	Trochanter	A	The subacromial bursa lies between the acromion and the supraspinatus tendon, reducing friction during shoulder movements.
The "SITS" mnemonic refers to	Rotator cuff muscles	Carpal bones	Foot arches	Cranial nerves	A	SITS stands for Supraspinatus, Infraspinatus, Teres minor, and Subscapularis, the four rotator cuff muscles.
`.trim(),

3: `
Brachial plexus roots are primarily	C5–T1	C1–C4	T2–T6	L1–L5	A	The brachial plexus is formed by the ventral rami of spinal nerves C5, C6, C7, C8, and T1.
The axillary artery is a continuation of the	Subclavian artery	Brachial artery	Radial artery	Ulnar artery	A	The subclavian artery becomes the axillary artery at the lateral border of the first rib.
The brachial artery is a continuation of the	Axillary artery	Subclavian artery	Femoral artery	Popliteal artery	A	The axillary artery becomes the brachial artery at the lower border of the teres major muscle.
Terminal branch: musculocutaneous nerve arises from	Lateral cord	Medial cord	Posterior cord	Cervical plexus	A	The musculocutaneous nerve (C5-C7) branches from the lateral cord and pierces the coracobrachialis to innervate arm flexors.
Terminal branch: axillary nerve arises from	Posterior cord	Lateral cord	Medial cord	Lumbar plexus	A	The axillary nerve (C5-C6) arises from the posterior cord and passes through the quadrangular space to innervate the deltoid and teres minor.
Terminal branch: radial nerve arises from	Posterior cord	Medial cord	Lateral cord	Sacral plexus	A	The radial nerve (C5-T1) is the largest branch of the posterior cord and innervates all posterior arm and forearm muscles.
Terminal branch: ulnar nerve arises from	Medial cord	Posterior cord	Lateral cord	Cervical plexus	A	The ulnar nerve (C8-T1) arises from the medial cord and innervates most intrinsic hand muscles.
Median nerve is formed by contributions from	Lateral and medial cords	Posterior cord only	Medial cord only	Lateral cord only	A	The median nerve is formed by a lateral root (from the lateral cord) and a medial root (from the medial cord) joining anterior to the axillary artery.
Structure in axilla commonly compressed by crutches	Axillary nerve	Median nerve	Femoral nerve	Tibial nerve	A	Improper crutch use compresses structures in the axilla; the axillary nerve and posterior cord are particularly vulnerable.
Axillary lymph nodes primarily drain the	Upper limb	Lower limb	Brain	Abdominal viscera	A	Axillary lymph nodes receive lymphatic drainage from the upper limb, breast, and superficial trunk.
Chamber that pumps to pulmonary circulation	Right ventricle	Left ventricle	Right atrium	Left atrium	A	The right ventricle pumps deoxygenated blood through the pulmonary valve into the pulmonary trunk toward the lungs.
Valve between left atrium and left ventricle	Mitral (bicuspid)	Tricuspid	Aortic	Pulmonary	A	The mitral (bicuspid) valve has two leaflets and guards the left atrioventricular orifice, preventing backflow during ventricular systole.
Valve between right atrium and right ventricle	Tricuspid	Mitral	Aortic	Pulmonary	A	The tricuspid valve has three leaflets and lies between the right atrium and right ventricle.
Valve between left ventricle and aorta	Aortic	Pulmonary	Tricuspid	Mitral	A	The aortic valve has three semilunar cusps and prevents backflow from the aorta into the left ventricle during diastole.
Valve between right ventricle and pulmonary trunk	Pulmonary	Aortic	Mitral	Tricuspid	A	The pulmonary valve has three semilunar cusps and guards the outflow from the right ventricle into the pulmonary trunk.
The sinoatrial (SA) node is the heart's	Primary pacemaker	Aortic valve	Coronary sinus	Chordae tendineae	A	The SA node in the right atrial wall generates the fastest intrinsic depolarization rate, setting the heart rhythm.
The left coronary artery commonly branches into	LAD and circumflex	Right marginal and PDA	Azygos and hemiazygos	Brachiocephalic and carotid	A	The left coronary artery bifurcates into the left anterior descending (LAD) and the circumflex artery to supply most of the left ventricle.
Blood returns from lungs to left atrium via	Pulmonary veins	Pulmonary arteries	Aorta	Venae cavae	A	Four pulmonary veins (two from each lung) carry oxygenated blood back to the left atrium.
The interatrial septum contains the	Fossa ovalis	Foramen magnum	Odontoid process	Sella turcica	A	The fossa ovalis is a remnant of the fetal foramen ovale located on the interatrial septum.
The pericardium is best described as a	Sac surrounding the heart	Muscle of the diaphragm	Valve leaflet	A coronary artery	A	The pericardium is a fibroserous sac with parietal and visceral layers that encloses and protects the heart.
`.trim(),

4: `
Primary elbow flexor (deep)	Brachialis	Biceps brachii	Triceps brachii	Deltoid	A	Brachialis lies deep to biceps brachii and is the primary elbow flexor regardless of forearm position.
Biceps brachii is especially important for	Forearm supination	Wrist extension	Hip flexion	Ankle inversion	A	Biceps brachii is most effective as a supinator when the elbow is flexed to 90 degrees, as its tendon wraps around the radial tuberosity.
Triceps brachii is the prime mover for	Elbow extension	Elbow flexion	Wrist flexion	Finger abduction	A	All three heads of the triceps converge on the olecranon, making it the primary extensor of the elbow.
Median nerve is found in the cubital fossa	Medial to brachial artery	Within carpal tunnel	In Guyon's canal	In popliteal fossa	A	In the cubital fossa, from lateral to medial, the order is: biceps tendon, brachial artery, median nerve (TAN).
Brachial artery is found in the cubital fossa	Medial to biceps tendon	Posterior to ulna	Lateral to radial head	Within tarsal tunnel	A	The brachial artery lies medial to the biceps tendon and lateral to the median nerve in the cubital fossa.
Cubital fossa boundaries include	Pronator teres (medial)	Rectus femoris (medial)	Gluteus medius (lateral)	Soleus (superior)	A	The cubital fossa is bounded medially by pronator teres and laterally by brachioradialis.
Common contents of cubital fossa (lateral→medial)	Tendon, artery, nerve	Nerve, tendon, artery	Artery, nerve, tendon	Vein, artery, nerve	A	The cubital fossa contents from lateral to medial are: Tendon (biceps), Artery (brachial), Nerve (median) — TAN.
Elbow joint is primarily a	Hinge joint	Ball-and-socket	Pivot between femur and tibia	Saddle joint	A	The humeroulnar articulation functions primarily as a hinge joint allowing flexion and extension.
Ligament resisting valgus stress at elbow	Ulnar collateral ligament	ACL	LCL	Deltoid ligament	A	The ulnar (medial) collateral ligament resists valgus stress at the elbow and is commonly injured in throwing athletes.
Bony landmark for triceps insertion	Olecranon	Coracoid	Styloid process	Greater trochanter	A	The olecranon process of the ulna is the attachment point for the triceps tendon and forms the bony point of the elbow.
"Funny bone" sensation involves the	Ulnar nerve	Median nerve	Radial nerve	Femoral nerve	A	The ulnar nerve passes posterior to the medial epicondyle in a superficial groove, where it is vulnerable to compression.
Radial head articulates with the	Capitulum	Trochlea	Medial epicondyle	Olecranon fossa	A	The head of the radius articulates with the capitulum of the humerus during flexion-extension and pronation-supination.
Trochlea articulates with the	Trochlear notch of ulna	Head of radius	Scaphoid	Patella	A	The trochlea of the humerus fits into the trochlear notch of the ulna, forming the main hinge of the elbow.
Biceps tendon inserts on the	Radial tuberosity	Ulnar olecranon	Lateral epicondyle	Clavicle	A	The biceps tendon inserts on the radial tuberosity, allowing it to flex the elbow and supinate the forearm.
Brachialis inserts on the	Ulnar tuberosity	Greater tubercle	Scapular spine	Fibular head	A	Brachialis inserts on the coronoid process and ulnar tuberosity, making it a pure elbow flexor unaffected by forearm rotation.
Musculocutaneous nerve primarily innervates	Flexors of arm	Extensors of forearm	Intrinsic hand muscles	Gluteal muscles	A	The musculocutaneous nerve innervates all three anterior arm muscles: biceps brachii, brachialis, and coracobrachialis.
Radial nerve injury classically causes	Wrist drop	Foot drop	Hip drop	Scapular winging	A	Radial nerve palsy denervates the posterior forearm extensors, causing inability to extend the wrist and fingers (wrist drop).
The cubital fossa floor includes	Brachialis and supinator	Rectus abdominis and iliopsoas	Soleus and gastrocnemius	Piriformis and obturator internus	A	The floor of the cubital fossa is formed by the brachialis muscle proximally and the supinator muscle distally.
Main blood supply crossing anterior elbow	Brachial artery	Femoral artery	Popliteal artery	Posterior tibial artery	A	The brachial artery crosses the anterior elbow in the cubital fossa before bifurcating into the radial and ulnar arteries.
Radius and ulna rotate at the	Proximal radioulnar joint	Acromioclavicular joint	Sacroiliac joint	Knee joint	A	The proximal radioulnar joint is a pivot joint where the radial head rotates within the annular ligament during pronation and supination.
`.trim(),

5: `
Most forearm flexors are innervated by	Median nerve	Radial nerve	Femoral nerve	Tibial nerve	A	The median nerve innervates most flexors of the forearm, except flexor carpi ulnaris and the medial half of FDP.
Flexor carpi ulnaris is innervated by	Ulnar nerve	Median nerve	Radial nerve	Axillary nerve	A	Flexor carpi ulnaris is one of only two forearm flexor muscles innervated by the ulnar nerve (the other being medial FDP).
Medial half of flexor digitorum profundus is innervated by	Ulnar nerve	Median nerve	Radial nerve	Musculocutaneous nerve	A	The medial half of FDP (to digits 4-5) is innervated by the ulnar nerve; the lateral half by the anterior interosseous nerve.
Pronator teres primarily causes	Pronation	Supination	Wrist extension	Thumb abduction	A	Pronator teres crosses from the medial epicondyle to the lateral radius, rotating the radius medially over the ulna.
Supinator muscle primarily causes	Supination	Pronation	Elbow extension	Knee flexion	A	The supinator wraps around the proximal radius and rotates it laterally; it acts alone in slow, unresisted supination.
Flexor digitorum superficialis flexes	PIP joints	DIP joints	MCP extension	IP extension	A	FDS splits into two slips that insert on the sides of the middle phalanx, flexing the proximal interphalangeal joints.
Flexor digitorum profundus flexes	DIP joints	PIP joints	Wrist extension	Elbow extension	A	FDP passes through the split in FDS to insert on the distal phalanx, flexing the distal interphalangeal joints.
Palmaris longus primarily	flexes wrist weakly	extends elbow	abducts hip	extends toes	A	Palmaris longus is a vestigial muscle absent in about 14% of people; it tenses the palmar aponeurosis and weakly flexes the wrist.
Brachioradialis is best known for	Elbow flexion in neutral grip	Wrist flexion	Finger abduction	Hip extension	A	Brachioradialis is most effective at flexing the elbow from a mid-pronated position and is innervated by the radial nerve despite being a flexor.
Extensor digitorum primarily	extends fingers	extends hip	flexes knee	inverts ankle	A	Extensor digitorum extends the MCP joints of digits 2-5 via the extensor expansion on the dorsum of the hand.
Extensor carpi ulnaris primarily	extends and adducts wrist	flexes wrist	everts foot	extends knee	A	ECU extends and ulnarly deviates (adducts) the wrist, acting from the lateral epicondyle to the base of the 5th metacarpal.
Extensor carpi radialis longus primarily	extends and abducts wrist	flexes fingers	abducts hip	extends toes	A	ECRL extends and radially deviates (abducts) the wrist, working with ECRB for powerful wrist extension.
"Carpal tunnel" is formed by carpal bones and	Flexor retinaculum	Extensor retinaculum	Deltoid fascia	Plantar fascia	A	The carpal tunnel is an osseofibrous tunnel bounded by the carpal bones and roofed by the flexor retinaculum (transverse carpal ligament).
Radial artery is commonly palpated at	Lateral wrist	Medial ankle	Popliteal fossa	Carotid triangle	A	The radial artery pulse is palpated at the lateral wrist between the flexor carpi radialis tendon and the radial styloid.
Ulnar artery primarily contributes to the	Superficial palmar arch	Popliteal artery	Aortic arch	Vertebral artery	A	The ulnar artery is the major contributor to the superficial palmar arch, which supplies the common digital arteries.
The "anatomical snuffbox" contains the	Radial artery	Ulnar nerve	Median nerve	Femoral vein	A	The radial artery crosses the floor of the anatomical snuffbox (between EPL and EPB/APL tendons) to enter the deep palm.
Posterior interosseous nerve is a branch of	Radial nerve	Ulnar nerve	Median nerve	Axillary nerve	A	The posterior interosseous nerve is the deep motor branch of the radial nerve that innervates the extensors of the posterior forearm.
A key extensor compartment of forearm is innervated by	Radial nerve	Femoral nerve	Obturator nerve	Long thoracic nerve	A	All muscles in the posterior (extensor) compartment of the forearm are innervated by the radial nerve or its branches.
Flexor pollicis longus is typically innervated by	Anterior interosseous (median)	Axillary	Ulnar	Tibial	A	Flexor pollicis longus is innervated by the anterior interosseous nerve, a pure motor branch of the median nerve.
Ulnar nerve passes posterior to the	Medial epicondyle	Lateral epicondyle	Patella	Fibular head	A	The ulnar nerve passes posterior to the medial epicondyle in the cubital tunnel, where it is susceptible to compression or trauma.
`.trim(),

6: `
Most commonly fractured carpal bone	Scaphoid	Lunate	Triquetrum	Hamate	A	The scaphoid spans both carpal rows and bears significant load during falls on an outstretched hand, making it the most commonly fractured carpal bone.
Carpal tunnel commonly compresses the	Median nerve	Ulnar nerve	Radial nerve	Femoral nerve	A	The median nerve passes through the carpal tunnel and can be compressed, causing numbness in the thumb, index, middle, and radial half of the ring finger.
Flexor retinaculum forms the roof of the	Carpal tunnel	Cubital fossa	Femoral triangle	Popliteal fossa	A	The flexor retinaculum (transverse carpal ligament) bridges the carpal arch, forming the roof of the carpal tunnel.
Thenar eminence is associated with the	Thumb	Big toe	Little toe	Shoulder	A	The thenar eminence is the fleshy mound at the base of the thumb, formed by abductor pollicis brevis, flexor pollicis brevis, and opponens pollicis.
Hypothenar eminence is associated with	Little finger	Thumb	Index finger	Middle toe	A	The hypothenar eminence at the base of the little finger contains abductor digiti minimi, flexor digiti minimi brevis, and opponens digiti minimi.
Anatomical snuffbox tenderness suggests injury to	Scaphoid	Hamate	Trapezoid	Pisiform	A	Tenderness in the anatomical snuffbox after a fall is a classic sign of scaphoid fracture, which may not be visible on initial X-rays.
The hook of hamate is clinically relevant due to	Ulnar nerve/artery proximity	Femoral artery proximity	Carotid sinus proximity	Sciatic nerve proximity	A	The hook of the hamate forms the lateral wall of Guyon's canal, and fractures here can injure the ulnar nerve and artery.
Ulnar nerve enters the hand via	Guyon's canal	Carpal tunnel	Foramen magnum	Obturator canal	A	Guyon's canal (ulnar canal) is a fibro-osseous tunnel at the wrist through which the ulnar nerve and artery enter the hand.
Median nerve enters the hand via	Carpal tunnel	Guyon's canal	Cubital tunnel	Tarsal tunnel	A	The median nerve enters the hand through the carpal tunnel along with the tendons of FDS, FDP, and FPL.
Interossei muscles are best known for	Finger abduction/adduction	Elbow extension	Hip flexion	Ankle inversion	A	The interossei are intrinsic hand muscles between the metacarpals that abduct (dorsal) and adduct (palmar) the fingers.
"DAB" mnemonic: dorsal interossei	Abduct fingers	Adduct fingers	Abduct toes	Adduct toes	A	DAB: Dorsal ABduct — the four dorsal interossei spread the fingers apart from the axis of the middle finger.
"PAD" mnemonic: palmar interossei	Adduct fingers	Abduct fingers	Adduct toes	Abduct toes	A	PAD: Palmar ADduct — the palmar interossei draw the fingers toward the middle finger.
Lumbricals typically	Flex MCP and extend IP	Extend MCP and flex IP	Supinate forearm	Plantarflex ankle	A	Lumbricals originate from FDP tendons and insert into the extensor expansion, uniquely flexing the MCP while extending the IP joints.
Flexor pollicis brevis is a	Thenar muscle	Hypothenar muscle	Rotator cuff muscle	Hamstring	A	Flexor pollicis brevis is a thenar muscle that flexes the thumb at the MCP joint, important for grip and pinch.
Opponens pollicis is a	Thenar muscle	Forearm extensor	Gluteal muscle	Foot inverter	A	Opponens pollicis rotates the first metacarpal medially, enabling thumb opposition — the most functionally important movement of the hand.
The pisiform is a sesamoid bone in the tendon of	Flexor carpi ulnaris	Extensor carpi ulnaris	Pronator teres	Biceps brachii	A	The pisiform is a sesamoid bone embedded within the tendon of flexor carpi ulnaris at the ulnar side of the wrist.
Carpal bones in proximal row (lateral→medial)	Scaphoid, lunate, triquetrum, pisiform	Hamate, capitate, trapezoid, trapezium	Talus, calcaneus, navicular, cuboid	Ulna, radius, humerus, scapula	A	From lateral (radial) to medial (ulnar), the proximal carpal row is: Scaphoid, Lunate, Triquetrum, Pisiform.
Carpal bones in distal row (lateral→medial)	Trapezium, trapezoid, capitate, hamate	Scaphoid, lunate, triquetrum, pisiform	Talus, navicular, cuboid, calcaneus	Ulna, radius, humerus, clavicle	A	From lateral to medial, the distal carpal row is: Trapezium, Trapezoid, Capitate, Hamate.
Superficial palmar arch is primarily from the	Ulnar artery	Radial artery	Brachial artery	Popliteal artery	A	The superficial palmar arch is primarily formed by the ulnar artery with a minor contribution from the superficial palmar branch of the radial artery.
Deep palmar arch is primarily from the	Radial artery	Ulnar artery	Femoral artery	Aorta	A	The deep palmar arch is primarily formed by the radial artery after it enters the palm through the first dorsal interosseous space.
`.trim(),

7: `
Primary "six-pack" muscle	Rectus abdominis	Transversus abdominis	Gluteus medius	Soleus	A	Rectus abdominis runs vertically from the pubic symphysis to the xiphoid process, divided by tendinous intersections creating the six-pack appearance.
External oblique fibers generally run	Inferomedially	Inferolaterally	Vertically	Superiorly	A	External oblique fibers run like hands in pockets (inferomedially), forming the most superficial anterolateral abdominal muscle layer.
Internal oblique fibers generally run	Superomedially	Superolaterally	Inferomedially	Vertically	A	Internal oblique fibers run perpendicular to the external oblique, coursing superomedially from the iliac crest and inguinal ligament.
Transversus abdominis fibers run	Transversely	Vertically	Inferomedially	Superomedially	A	Transversus abdominis is the deepest flat abdominal muscle with horizontally running fibers that compress the abdominal contents.
Linea alba is a midline	Aponeurotic raphe	Synovial joint	Nerve plexus	Artery	A	The linea alba is a fibrous raphe in the midline formed by the fusion of the aponeuroses of the three flat abdominal muscles.
Inguinal ligament runs from	ASIS to pubic tubercle	PSIS to sacrum	Femoral head to tibia	Clavicle to sternum	A	The inguinal ligament is the folded inferior edge of the external oblique aponeurosis, running from the ASIS to the pubic tubercle.
Inguinal canal contains	Spermatic cord (male)	Median nerve	Radial artery	Sciatic nerve	A	The inguinal canal transmits the spermatic cord in males (or round ligament in females) and the ilioinguinal nerve.
Femoral triangle boundaries include	Inguinal ligament superior	Achilles tendon superior	Pectoralis major superior	Deltoid superior	A	The femoral triangle is bounded superiorly by the inguinal ligament, medially by adductor longus, and laterally by sartorius.
Order (lateral→medial) in femoral triangle	Nerve, artery, vein, lymph	Vein, artery, nerve, lymph	Artery, nerve, vein, lymph	Lymph, vein, artery, nerve	A	From lateral to medial: Nerve, Artery, Vein, Empty space, Lymphatics (NAVEL) within the femoral triangle.
Pelvic bone parts include	Ilium, ischium, pubis	Scaphoid, lunate, triquetrum	Atlas, axis, sacrum	Radius, ulna, humerus	A	The hip bone (os coxae) is formed by the fusion of three bones: the ilium, ischium, and pubis, which meet at the acetabulum.
Joint between pubic bones	Pubic symphysis	Sacroiliac joint	Glenohumeral joint	Atlantoaxial joint	A	The pubic symphysis is a secondary cartilaginous joint connecting the two pubic bones at the anterior midline of the pelvis.
Hip joint is a	Ball-and-socket	Hinge	Pivot	Saddle	A	The hip joint is a multiaxial ball-and-socket synovial joint between the femoral head and the acetabulum, allowing movement in all planes.
Acetabulum is the socket of the	Hip joint	Shoulder joint	Elbow joint	Knee joint	A	The acetabulum is a deep cup-shaped socket on the lateral pelvis that receives the femoral head, enhanced by the acetabular labrum.
Primary ligament resisting hyperextension of hip	Iliofemoral ligament	ACL	Deltoid ligament	Radial collateral ligament	A	The iliofemoral (Y-shaped) ligament is the strongest ligament in the body and limits hip hyperextension in standing posture.
Ischiofemoral ligament is located on the	Posterior hip	Anterior elbow	Medial ankle	Posterior knee	A	The ischiofemoral ligament spirals posteriorly from the ischium to the femoral neck, limiting internal rotation and extension.
Pubofemoral ligament is located on the	Inferior/anterior hip	Lateral knee	Posterior ankle	Medial elbow	A	The pubofemoral ligament reinforces the inferior and anterior hip capsule, limiting abduction and extension.
Gluteus medius primarily	Abducts hip	Extends knee	Plantarflexes ankle	Flexes wrist	A	Gluteus medius is the primary hip abductor, essential for stabilizing the pelvis during single-leg stance.
Iliopsoas is a primary	Hip flexor	Knee extensor	Ankle evertor	Shoulder abductor	A	Iliopsoas (iliacus + psoas major) is the most powerful hip flexor, crossing from the lumbar spine and iliac fossa to the lesser trochanter.
Femoral canal is clinically relevant for	Femoral hernias	Carpal tunnel	Rotator cuff tears	ACL tears	A	The femoral canal is the medial-most compartment of the femoral sheath; its opening (femoral ring) is a potential site for femoral hernias.
Greater sciatic notch transmits the	Sciatic nerve	Median nerve	Ulnar nerve	Radial nerve	A	The sciatic nerve (L4-S3), the largest nerve in the body, exits the pelvis through the greater sciatic foramen below the piriformis.
`.trim(),

8: `
Gluteus maximus is a powerful	Hip extensor	Knee flexor	Ankle dorsiflexor	Elbow extensor	A	Gluteus maximus is the largest and most powerful hip extensor, essential for climbing stairs, rising from sitting, and running.
Gluteus medius is key for	Hip abduction	Knee extension	Wrist flexion	Neck rotation	A	Gluteus medius abducts and medially rotates the hip, critically stabilizing the pelvis during the single-leg stance phase of gait.
Trendelenburg sign suggests weakness of	Gluteus medius	Triceps brachii	Serratus anterior	Pronator teres	A	A positive Trendelenburg sign (pelvis drops on the unsupported side) indicates weakness of the gluteus medius on the stance limb.
Piriformis passes through the	Greater sciatic foramen	Lesser sciatic foramen	Carpal tunnel	Inguinal canal	A	The piriformis originates in the pelvis and passes through the greater sciatic foramen, serving as a key landmark for gluteal region structures.
Sciatic nerve exits pelvis usually	Inferior to piriformis	Superior to piriformis	Through obturator canal	Through femoral canal	A	The sciatic nerve typically exits the pelvis inferior to the piriformis muscle, though anatomical variations exist in about 12% of people.
Quadriceps femoris primarily	Extends knee	Flexes knee	Inverts ankle	Extends elbow	A	The four muscles of the quadriceps (rectus femoris, vastus lateralis, medialis, intermedius) converge on the patella to extend the knee.
Hamstrings primarily	Extend hip and flex knee	Flex hip and extend knee	Plantarflex wrist	Abduct shoulder	A	The hamstrings (biceps femoris, semitendinosus, semimembranosus) cross both the hip and knee, extending the hip and flexing the knee.
Femoral nerve innervates most of	Anterior thigh	Posterior forearm	Intrinsic hand	Gluteal region	A	The femoral nerve (L2-L4) innervates the quadriceps and sartorius in the anterior thigh, plus provides sensation via the saphenous nerve.
Obturator nerve primarily innervates	Medial thigh adductors	Anterior thigh extensors	Posterior leg flexors	Forearm extensors	A	The obturator nerve (L2-L4) passes through the obturator canal to innervate the adductor muscles of the medial thigh.
Superior gluteal nerve innervates	Gluteus medius/minimus	Gluteus maximus	Quadriceps	Hamstrings	A	The superior gluteal nerve (L4-S1) exits above the piriformis and innervates gluteus medius, gluteus minimus, and tensor fasciae latae.
Inferior gluteal nerve innervates	Gluteus maximus	Gluteus medius	Adductors	Iliopsoas	A	The inferior gluteal nerve (L5-S2) exits below the piriformis and exclusively innervates the gluteus maximus.
Femoral triangle contents include	Femoral nerve/artery/vein	Popliteal artery/vein	Tibial nerve only	Median nerve only	A	The femoral triangle contains the femoral nerve, artery, and vein (lateral to medial), plus lymphatics and the femoral canal.
NAVEL mnemonic (lateral→medial) refers to	Femoral triangle	Carpal tunnel	Cubital fossa	Axilla	A	NAVEL describes the lateral-to-medial arrangement in the femoral triangle: Nerve, Artery, Vein, Empty space, Lymphatics.
Adductor longus is located in the	Medial thigh	Anterior leg	Posterior forearm	Shoulder	A	Adductor longus is a superficial medial thigh muscle that adducts the hip and forms the medial boundary of the femoral triangle.
Sartorius crosses both	Hip and knee	Elbow and wrist	Shoulder and elbow	Ankle and toes	A	Sartorius is the longest muscle in the body, crossing from the ASIS to the proximal medial tibia, flexing both the hip and knee.
Rectus femoris crosses	Hip and knee	Only knee	Only hip	Ankle and knee	A	Rectus femoris is the only quadriceps muscle that crosses both the hip and knee joints, allowing it to flex the hip and extend the knee.
Vastus medialis primarily	Extends knee	Abducts hip	Plantarflexes ankle	Extends wrist	A	Vastus medialis (especially its oblique fibers, VMO) extends the knee and is critical for patellar tracking and stability.
Vastus lateralis primarily	Extends knee	Flexes hip	Extends elbow	Supinates forearm	A	Vastus lateralis is the largest quadriceps muscle, providing powerful knee extension on the lateral side of the thigh.
Gracilis is a	Medial thigh adductor	Thenar muscle	Rotator cuff muscle	Deep leg extensor	A	Gracilis is the most superficial medial thigh muscle, adducting the hip and flexing the knee; its tendon is part of the pes anserinus.
Adductor magnus is innervated mainly by	Obturator nerve	Axillary nerve	Long thoracic nerve	Accessory nerve	A	Adductor magnus is innervated primarily by the obturator nerve (adductor part), with its hamstring part receiving tibial nerve innervation.
`.trim(),

9: `
ACL primarily prevents	Anterior tibial translation	Posterior tibial translation	Valgus stress	Varus stress	A	The ACL runs from the posterior femur to the anterior tibia, preventing anterior displacement of the tibia relative to the femur.
PCL primarily prevents	Posterior tibial translation	Anterior tibial translation	Varus stress	Eversion	A	The PCL is the strongest knee ligament, running from the anterior femur to the posterior tibia, preventing posterior tibial displacement.
MCL resists	Valgus stress	Varus stress	Anterior translation	Plantarflexion	A	The medial collateral ligament resists valgus (lateral) force at the knee and is attached to the medial meniscus.
LCL resists	Varus stress	Valgus stress	Posterior translation	Dorsiflexion	A	The lateral collateral ligament is a cord-like structure resisting varus (medial) force; unlike the MCL, it is not attached to the meniscus.
Menisci primarily	Improve congruency and shock absorption	Extend the knee	Adduct the hip	Plantarflex ankle	A	The medial and lateral menisci are C-shaped fibrocartilage discs that deepen the tibial plateau, distribute load, and absorb shock.
Patellar ligament connects	Patella to tibial tuberosity	Femur to tibia	Tibia to fibula	Talus to calcaneus	A	The patellar ligament is the continuation of the quadriceps tendon from the inferior patella to the tibial tuberosity.
Knee is primarily a	Modified hinge	Ball-and-socket	Pivot	Saddle	A	The knee is classified as a modified hinge joint, allowing primarily flexion-extension with some rotation when the knee is flexed.
"Unhappy triad" often involves ACL, MCL, and	Medial meniscus	Lateral meniscus	PCL	Deltoid ligament	A	The unhappy triad is a combined injury to the ACL, MCL, and medial meniscus, typically from a lateral blow to the knee.
Talocrural joint is the	Ankle joint	Shoulder joint	Hip joint	Wrist joint	A	The talocrural (ankle) joint is formed by the tibia, fibula, and talus, functioning as a hinge joint for dorsiflexion and plantarflexion.
Ankle dorsiflexion primarily occurs at the	Talocrural joint	Subtalar joint	Hip joint	Interphalangeal joints	A	Dorsiflexion occurs primarily at the talocrural joint, where the wider anterior part of the talus is gripped by the malleoli.
Deltoid ligament is on the	Medial ankle	Lateral ankle	Anterior knee	Posterior elbow	A	The deltoid ligament is a strong, fan-shaped ligament on the medial ankle that resists eversion and prevents lateral talar shift.
ATFL is commonly injured in	Ankle inversion sprain	Hip dislocation	Wrist fracture	Rotator cuff tear	A	The anterior talofibular ligament (ATFL) is the weakest lateral ankle ligament and the most commonly injured in inversion sprains.
Bone that articulates with tibia in ankle joint	Talus	Calcaneus	Navicular	Cuboid	A	The talus articulates superiorly with the tibia and laterally with the fibula, forming the ankle mortise.
Largest tarsal bone	Calcaneus	Talus	Navicular	Cuneiform	A	The calcaneus (heel bone) is the largest tarsal bone, bearing the body's weight in standing and serving as the attachment for the Achilles tendon.
Navicular is on the	Medial foot	Lateral foot	Proximal phalanx	Patella	A	The navicular bone sits on the medial side of the midfoot, articulating with the talus posteriorly and the three cuneiforms anteriorly.
Cuboid is on the	Lateral midfoot	Medial midfoot	Forearm	Upper arm	A	The cuboid is on the lateral side of the midfoot, articulating with the calcaneus posteriorly and the 4th and 5th metatarsals anteriorly.
Cuneiform bones are on the	Medial midfoot	Posterior leg	Hand	Skull	A	The three cuneiform bones (medial, intermediate, lateral) are wedge-shaped bones in the medial midfoot articulating with the navicular and metatarsals 1-3.
First metatarsal is associated with the	Big toe	Little finger	Thumb	Calcaneus	A	The first metatarsal is the thickest and shortest, associated with the great (big) toe and bearing significant weight during push-off in gait.
Plantar fascia primarily supports the	Arch of the foot	Elbow joint	Shoulder capsule	Carpal tunnel	A	The plantar fascia spans the sole from the calcaneus to the toes, supporting the longitudinal arch of the foot.
Subtalar joint is between	Talus and calcaneus	Tibia and fibula	Femur and tibia	Navicular and cuboid	A	The subtalar joint between the talus and calcaneus allows inversion and eversion, essential for adapting the foot to uneven terrain.
`.trim(),

10: `
Tibialis anterior primarily	Dorsiflexes and inverts foot	Plantarflexes and everts foot	Extends knee	Flexes wrist	A	Tibialis anterior dorsiflexes and inverts the foot, and is the primary muscle preventing foot slap during heel strike in gait.
Extensor hallucis longus primarily	Extends great toe	Flexes great toe	Abducts hip	Pronates forearm	A	Extensor hallucis longus extends the great toe at the MTP and IP joints and assists in dorsiflexion.
Extensor digitorum longus primarily	Extends toes 2–5	Flexes toes 2–5	Extends elbow	Flexes hip	A	Extensor digitorum longus extends toes 2-5 at the MTP joints and assists in dorsiflexion and eversion.
Fibularis (peroneus) longus primarily	Everts foot	Dorsiflexes foot	Inverts foot	Extends knee	A	Fibularis longus everts the foot and plantarflexes the ankle; its tendon crosses the sole to support the transverse arch.
Fibularis (peroneus) brevis primarily	Everts foot	Plantarflexes toes	Extends wrist	Flexes elbow	A	Fibularis brevis everts the foot and weakly plantarflexes; it inserts on the base of the 5th metatarsal tuberosity.
Gastrocnemius primarily	Plantarflexes ankle	Flexes wrist	Extends elbow	Inverts foot	A	Gastrocnemius is the superficial two-headed calf muscle, providing powerful plantarflexion and assisting in knee flexion.
Soleus primarily	Plantarflexes ankle	Extends knee	Abducts shoulder	Supinates forearm	A	Soleus lies deep to gastrocnemius and is a pure plantarflexor that does not cross the knee, active during standing and slow walking.
Achilles tendon connects	Gastrocnemius/soleus to calcaneus	Quadriceps to patella	Biceps to radius	Gluteus medius to femur	A	The Achilles (calcaneal) tendon is the strongest tendon in the body, transmitting the force of the triceps surae to the calcaneus.
Tibialis posterior primarily	Inverts and plantarflexes foot	Everts and dorsiflexes foot	Extends toes	Abducts hip	A	Tibialis posterior is the deepest posterior compartment muscle, the primary invertor of the foot and a key dynamic supporter of the medial arch.
Flexor hallucis longus primarily	Flexes great toe	Extends great toe	Abducts fingers	Extends knee	A	Flexor hallucis longus flexes the great toe at the IP joint and is crucial for push-off during walking and running.
Flexor digitorum longus primarily	Flexes toes 2–5	Extends toes 2–5	Extends elbow	Adducts hip	A	Flexor digitorum longus flexes the distal phalanges of toes 2-5 and assists in plantarflexion and foot inversion.
Popliteus primarily	"Unlocks" the knee	Extends the elbow	Opposes thumb	Dorsiflexes foot	A	Popliteus medially rotates the tibia (or laterally rotates the femur) to unlock the fully extended knee, initiating flexion.
Deep posterior compartment includes	Tibialis posterior	Fibularis longus	Tibialis anterior	Extensor digitorum longus	A	The deep posterior compartment contains tibialis posterior, flexor digitorum longus, and flexor hallucis longus, all innervated by the tibial nerve.
Anterior compartment is innervated mainly by	Deep fibular nerve	Tibial nerve	Femoral nerve	Ulnar nerve	A	The deep fibular (peroneal) nerve innervates all muscles of the anterior compartment: tibialis anterior, EHL, EDL, and fibularis tertius.
Posterior compartment is innervated mainly by	Tibial nerve	Deep fibular nerve	Radial nerve	Axillary nerve	A	The tibial nerve innervates all muscles of the superficial and deep posterior compartments of the leg.
Common site of tibial nerve compression	Tarsal tunnel	Carpal tunnel	Cubital tunnel	Thoracic outlet	A	The tarsal tunnel is posterior to the medial malleolus; tibial nerve compression here causes tarsal tunnel syndrome with plantar foot symptoms.
Plantarflexion strength is largely from	Gastrocnemius and soleus	Gluteus medius	Deltoid	Trapezius	A	The triceps surae (gastrocnemius and soleus) generates the majority of plantarflexion force, essential for walking, running, and jumping.
Dorsiflexion weakness can cause	Foot drop	Winged scapula	Wrist drop	Trendelenburg gait	A	Foot drop results from weakness of dorsiflexors (usually deep fibular nerve injury), causing a steppage gait to clear the drooping foot.
Intrinsic foot muscles assist with	Arch support and toe control	Elbow extension	Shoulder abduction	Wrist pronation	A	The intrinsic foot muscles (four layers on the plantar surface) dynamically support the arches and provide fine control of the toes.
Calcaneal (Achilles) reflex tests	S1–S2 spinal segments	C5–C6 spinal segments	T1–T2 spinal segments	L3–L4 spinal segments	A	The Achilles tendon reflex tests the S1-S2 spinal segments via the tibial nerve, assessing the integrity of the reflex arc.
`.trim(),

11: `
The CNS includes brain and	Spinal cord	Peripheral nerves	Heart	Lymph nodes	A	The central nervous system consists of the brain and spinal cord, protected by the meninges, cerebrospinal fluid, and bony structures.
Outer meningeal layer	Dura mater	Arachnoid mater	Pia mater	Ependyma	A	The dura mater is the tough, fibrous outermost meningeal layer that lines the skull and vertebral canal.
CSF is primarily found in the	Ventricles and subarachnoid space	Myelin sheath	Tendons	Periosteum	A	CSF is produced by the choroid plexus in the ventricles and circulates through the ventricular system into the subarachnoid space.
Largest commissural tract	Corpus callosum	Internal capsule	Optic chiasm	Arcuate fasciculus	A	The corpus callosum is the largest white matter tract connecting the left and right cerebral hemispheres, enabling interhemispheric communication.
The cerebellum is important for	Coordination and balance	Primary hearing	Primary smell	Blood pressure only	A	The cerebellum fine-tunes motor commands by comparing intended and actual movements, coordinating balance, posture, and smooth voluntary movements.
Brainstem includes	Midbrain, pons, medulla	Frontal, parietal, occipital	Thalamus, hypothalamus, amygdala	Corpus callosum only	A	The brainstem connects the cerebrum to the spinal cord and contains vital centers for autonomic functions and cranial nerve nuclei.
The medulla helps regulate	Breathing and heart rate	Vision only	Hip extension	Elbow flexion	A	The medulla oblongata contains the cardiovascular and respiratory centers that regulate heart rate, blood pressure, and breathing rhythm.
The pons is part of the	Brainstem	Cerebellar cortex	Spinal nerve	Retina	A	The pons lies between the midbrain and medulla, relaying signals between the cerebrum and cerebellum and housing nuclei for several cranial nerves.
The thalamus is a major	Sensory relay station	Primary motor nucleus	Spinal reflex center	Skull bone	A	The thalamus acts as the brain's relay station, directing nearly all sensory information (except olfaction) to the appropriate cortical areas.
Hypothalamus is crucial for	Homeostasis and autonomic control	Wrist extension	Knee ligaments	Foot arches	A	The hypothalamus regulates body temperature, hunger, thirst, circadian rhythms, and autonomic functions, linking the nervous and endocrine systems.
Primary motor cortex is in the	Precentral gyrus	Postcentral gyrus	Calcarine sulcus	Insula	A	The primary motor cortex (Brodmann area 4) in the precentral gyrus initiates voluntary movements via upper motor neurons in a somatotopic pattern.
Primary somatosensory cortex is in the	Postcentral gyrus	Precentral gyrus	Cingulate gyrus	Cerebellar vermis	A	The primary somatosensory cortex (areas 3, 1, 2) in the postcentral gyrus receives and processes tactile, proprioceptive, and pain information.
Occipital lobe is primarily for	Vision	Hearing	Language production	Balance	A	The occipital lobe contains the primary visual cortex (V1) along the calcarine sulcus, processing all visual information from the retina.
Temporal lobe is strongly linked to	Hearing and memory	Primary vision	Balance only	Hip flexion	A	The temporal lobe houses the primary auditory cortex, Wernicke's area for language comprehension, and medial structures for memory.
Parietal lobe is key for	Somatosensory integration	Smell only	Cardiac rhythm	Plantarflexion	A	The parietal lobe integrates somatosensory information and is involved in spatial awareness, attention, and sensory integration.
The hippocampus is important for	Memory formation	Reflex arcs only	Muscle tone only	Blood clotting	A	The hippocampus in the medial temporal lobe is essential for consolidating short-term memories into long-term declarative memories.
The amygdala is strongly linked to	Emotion processing	Ankle dorsiflexion	Wrist supination	Scapular retraction	A	The amygdala processes emotional responses, particularly fear and anxiety, and attaches emotional significance to memories.
The internal capsule carries many	Ascending/descending fibers	Carpal bones	Fascial layers	Vertebrae	A	The internal capsule is a V-shaped white matter structure carrying corticospinal (descending motor) and thalamocortical (ascending sensory) fibers.
Basal ganglia are involved in	Motor control loops	Pelvic stability only	Finger extension only	CSF production only	A	The basal ganglia (caudate, putamen, globus pallidus) modulate motor control through inhibitory loops, helping initiate and regulate voluntary movements.
The lateral ventricles are found in the	Cerebrum	Cerebellum	Spinal cord	Skull sutures	A	The lateral ventricles are the largest CSF-filled cavities, located within each cerebral hemisphere and connecting to the third ventricle via the interventricular foramina.
`.trim()
};

/* =========================
   App State
========================= */
const $ = (id)=>document.getElementById(id);

const card = $("card");
const coverImg = $("coverImg");
const coverTitle = $("coverTitle");
const coverSub = $("coverSub");

const qLab = $("qLab");
const qText = $("qText");
const choicesEl = $("choices");
const feedbackEl = $("feedback");

const modePill = $("modePill");
const labPill = $("labPill");
const progressPill = $("progressPill");
const timerPill = $("timerPill");

const settingsModalBack = $("settingsModalBack");
const helpModalBack = $("helpModalBack");
const resultsModalBack = $("resultsModalBack");

const labsList = $("labsList");

const examFields = $("examFields");
const examCount = $("examCount");
const examTime = $("examTime");

const sessionCount = $("sessionCount");
const remember = $("remember");

const resetBtn = $("resetBtn");
const startBtn = $("startBtn");

const flipBtn = $("flipBtn");
const revealBtn = $("revealBtn");
const submitBtn = $("submitBtn");
const nextBtn = $("nextBtn");

let state = {
  selectedLabs: [1,2,3,4,5,6],
  mode: "learn", // learn | test | exam
  sessionN: 30,
  remember: true,

  queue: [],
  idx: 0,
  flipped: false,

  selectedChoice: null,
  submitted: false,
  revealed: false,

  exam: {
    active: false,
    n: 20,
    timeMin: 0,
    startTs: 0,
    endTs: 0,
    timerId: null,
    answers: [] // {q, pickedIndex, correctIndex, correctText, pickedText, isCorrect}
  }
};

function savePrefs(){
  if(!state.remember) return;
  const prefs = {
    selectedLabs: state.selectedLabs,
    mode: state.mode,
    sessionN: state.sessionN,
    examN: state.exam.n,
    examTimeMin: state.exam.timeMin
  };
  localStorage.setItem("kin100_flashcards_prefs", JSON.stringify(prefs));
}
function loadPrefs(){
  try{
    const raw = localStorage.getItem("kin100_flashcards_prefs");
    if(!raw) return;
    const prefs = JSON.parse(raw);
    if(Array.isArray(prefs.selectedLabs) && prefs.selectedLabs.length) state.selectedLabs = prefs.selectedLabs;
    if(["learn","test","exam"].includes(prefs.mode)) state.mode = prefs.mode;
    if(typeof prefs.sessionN === "number") state.sessionN = prefs.sessionN;
    if(typeof prefs.examN === "number") state.exam.n = prefs.examN;
    if(typeof prefs.examTimeMin === "number") state.exam.timeMin = prefs.examTimeMin;
  }catch(e){}
}

function labLabel(ids){
  if(!ids || !ids.length) return "—";
  const sorted = [...ids].sort((a,b)=>a-b);
  if(sorted.length===11) return "All";
  // compress ranges (e.g., 1–6, 8–10)
  let out = [];
  let start = sorted[0], prev = sorted[0];
  for(let i=1;i<sorted.length;i++){
    const cur = sorted[i];
    if(cur===prev+1){ prev=cur; continue; }
    out.push(start===prev ? `${start}` : `${start}–${prev}`);
    start=prev=cur;
  }
  out.push(start===prev ? `${start}` : `${start}–${prev}`);
  return out.join(", ");
}

function setPills(){
  modePill.textContent = `Mode: ${state.mode.toUpperCase()}`;
  labPill.textContent = `Labs: ${labLabel(state.selectedLabs)}`;
  progressPill.textContent = `${Math.min(state.idx+1, state.queue.length)} / ${state.queue.length}`;
  timerPill.style.display = state.mode==="exam" ? "inline-flex" : "none";
}

function openSettings(){
  settingsModalBack.classList.add("show");
}
function closeSettings(){
  settingsModalBack.classList.remove("show");
}
function openHelp(){
  helpModalBack.classList.add("show");
}
function closeHelp(){
  helpModalBack.classList.remove("show");
}
function openResults(){
  resultsModalBack.classList.add("show");
}
function closeResults(){
  resultsModalBack.classList.remove("show");
}

function flip(toQuestion){
  if(typeof toQuestion === "boolean"){
    state.flipped = toQuestion;
  }else{
    state.flipped = !state.flipped;
  }
  card.classList.toggle("flipped", state.flipped);
}

function randItem(arr){
  if(!arr || !arr.length) return null;
  return arr[Math.floor(Math.random()*arr.length)];
}

function setCoverForLab(labId){
  const lab = LABS.find(l=>l.id===labId);
  coverTitle.textContent = lab ? `${lab.name}: ${lab.topic}` : "KIN100 Flashcards";
  coverSub.textContent = state.mode==="exam"
    ? "Exam mode: no feedback until the end."
    : state.mode==="test"
      ? "Test mode: select an option, then submit."
      : "Learn mode: reveal or submit at your pace.";

  const src = randItem(LAB_IMAGES[labId]) || "";
  if(!src){
    coverImg.removeAttribute("src");
    coverImg.style.display = "none";
    return;
  }
  coverImg.style.display = "block";
  coverImg.src = src;
  coverImg.onerror = () => {
    coverImg.style.display = "none";
  };
  coverImg.onload = () => {
    coverImg.style.display = "block";
  };
}

function parseQuestionsForLab(labId){
  const raw = QUESTION_DATA[labId];
  if(!raw) return [];
  return raw.split("\n").map(line=>{
    const parts = line.split("\t");
    if(parts.length < 6) return null;
    const prompt = parts[0].trim();
    const choices = parts.slice(1,5).map(s=>s.trim());
    const correctLetter = parts[5].trim().toUpperCase();
    const correctIndex = ["A","B","C","D"].indexOf(correctLetter);
    const explanation = (parts[6] || "").trim();
    return {labId, prompt, choices, correctIndex, explanation};
  }).filter(Boolean);
}

function shuffleInPlace(a){
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

function makeShuffledQuestion(q){
  // shuffle choices while preserving correct
  const indexed = q.choices.map((text, i)=>({text, i}));
  shuffleInPlace(indexed);
  const newChoices = indexed.map(x=>x.text);
  const newCorrect = indexed.findIndex(x=>x.i===q.correctIndex);
  return {
    ...q,
    choices: newChoices,
    correctIndex: newCorrect,
    explanation: q.explanation
  };
}

function buildPool(selectedLabs){
  let pool = [];
  for(const id of selectedLabs){
    pool = pool.concat(parseQuestionsForLab(id));
  }
  return pool;
}

function startSession(){
  // validate
  if(!state.selectedLabs.length){
    alert("Please select at least one lab.");
    return;
  }

  // clear exam timer
  if(state.exam.timerId) { clearInterval(state.exam.timerId); state.exam.timerId=null; }

  state.idx = 0;
  state.selectedChoice = null;
  state.submitted = false;
  state.revealed = false;
  state.exam.active = (state.mode==="exam");
  state.exam.answers = [];
  timerPill.textContent = "Time: —";

  const pool = buildPool(state.selectedLabs);
  if(!pool.length){
    alert("No questions found for selected labs.");
    return;
  }

  let desiredN;
  if(state.mode==="exam"){
    desiredN = Math.max(5, Math.min(Number(state.exam.n)||20, pool.length));
  }else{
    const sc = sessionCount.value;
    desiredN = (sc==="9999") ? pool.length : Math.min(Number(sc)||30, pool.length);
  }

  shuffleInPlace(pool);
  const chosen = pool.slice(0, desiredN).map(makeShuffledQuestion);

  state.queue = chosen;

  // set cover based on first question lab
  setCoverForLab(state.queue[0].labId);
  renderCurrent();
  flip(false);
  setPills();
  closeSettings();

  if(state.mode==="exam"){
    setupExamTimer();
  }
}

function setupExamTimer(){
  const minutes = Number(state.exam.timeMin)||0;
  if(minutes <= 0){
    timerPill.textContent = "Time: ∞";
    return;
  }
  state.exam.startTs = Date.now();
  state.exam.endTs = state.exam.startTs + minutes*60*1000;

  function tick(){
    const now = Date.now();
    const remaining = Math.max(0, state.exam.endTs - now);
    const mm = Math.floor(remaining/60000);
    const ss = Math.floor((remaining%60000)/1000);
    timerPill.textContent = `Time: ${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}`;
    if(remaining<=0){
      clearInterval(state.exam.timerId);
      state.exam.timerId=null;
      finishExam(true);
    }
  }
  tick();
  state.exam.timerId = setInterval(tick, 250);
}

function renderCurrent(){
  const q = state.queue[state.idx];
  if(!q) return;

  const lab = LABS.find(l=>l.id===q.labId);
  qLab.textContent = lab ? `${lab.name}: ${lab.topic}` : `Lab ${q.labId}`;
  qText.textContent = q.prompt;

  // reset local question state
  state.selectedChoice = null;
  state.submitted = false;
  state.revealed = false;

  // buttons behavior per mode
  revealBtn.style.display = (state.mode==="learn") ? "inline-block" : "none";
  submitBtn.style.display = (state.mode==="learn") ? "inline-block" : "inline-block";
  nextBtn.style.display = "inline-block";

  feedbackEl.className = "feedback";
  feedbackEl.textContent = "";
  feedbackEl.classList.remove("show","good","bad","warn");

  // cover image updates per question (keeps the “cue card cover” tied to lab)
  setCoverForLab(q.labId);

  // choices
  choicesEl.innerHTML = "";
  const letters = ["A","B","C","D"];
  q.choices.forEach((choiceText, i)=>{
    const btn = document.createElement("div");
    btn.className = "choice";
    btn.setAttribute("role","button");
    btn.setAttribute("tabindex","0");
    btn.dataset.index = String(i);
    btn.innerHTML = `<strong>${letters[i]}</strong><div class="label">${escapeHtml(choiceText)}</div>`;
    btn.addEventListener("click", ()=>selectChoice(i));
    btn.addEventListener("keydown", (e)=>{
      if(e.key==="Enter" || e.key===" "){
        e.preventDefault();
        selectChoice(i);
      }
    });
    choicesEl.appendChild(btn);
  });

  setPills();
}

function escapeHtml(s){
  return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
}

function selectChoice(i){
  if(state.submitted && state.mode!=="learn") return; // lock after submit in test/exam
  state.selectedChoice = i;
  [...choicesEl.querySelectorAll(".choice")].forEach(el=>{
    el.classList.toggle("selected", Number(el.dataset.index)===i);
  });
}

function revealAnswer(){
  if(state.mode!=="learn") return;
  const q = state.queue[state.idx];
  if(!q) return;
  state.revealed = true;

  [...choicesEl.querySelectorAll(".choice")].forEach(el=>{
    const idx = Number(el.dataset.index);
    el.classList.remove("wrong","correct");
    if(idx === q.correctIndex) el.classList.add("correct");
  });

  feedbackEl.className = "feedback show warn";
  feedbackEl.innerHTML = `Reveal: Correct answer is "${escapeHtml(q.choices[q.correctIndex])}".`
    + (q.explanation ? `<div class="explanation"><strong>Why?</strong> ${escapeHtml(q.explanation)}</div>` : "");
}

function submitAnswer(){
  const q = state.queue[state.idx];
  if(!q) return;

  if(state.selectedChoice === null || state.selectedChoice === undefined){
    feedbackEl.className = "feedback show warn";
    feedbackEl.textContent = "Select an option first (keys 1–4 or tap), then press Submit / Enter.";
    return;
  }

  // Learn mode can show feedback immediately; Test mode shows correctness; Exam mode records only
  const isCorrect = (state.selectedChoice === q.correctIndex);

  if(state.mode==="exam"){
    state.submitted = true;
    // record
    const pickedText = q.choices[state.selectedChoice];
    const correctText = q.choices[q.correctIndex];
    state.exam.answers[state.idx] = {
      q,
      pickedIndex: state.selectedChoice,
      correctIndex: q.correctIndex,
      pickedText,
      correctText,
      isCorrect
    };
    // no feedback now
    feedbackEl.className = "feedback show";
    feedbackEl.textContent = "Answer recorded. (Exam mode: feedback shown at the end.)";
  }else{
    state.submitted = true;

    [...choicesEl.querySelectorAll(".choice")].forEach(el=>{
      const idx = Number(el.dataset.index);
      el.classList.remove("wrong","correct");
      if(idx === q.correctIndex) el.classList.add("correct");
      if(idx === state.selectedChoice && idx !== q.correctIndex) el.classList.add("wrong");
    });

    feedbackEl.className = "feedback show " + (isCorrect ? "good" : "bad");
    const base = isCorrect
      ? "Correct!"
      : `Incorrect. Correct answer: "${escapeHtml(q.choices[q.correctIndex])}".`;
    feedbackEl.innerHTML = base
      + (q.explanation ? `<div class="explanation"><strong>Why?</strong> ${escapeHtml(q.explanation)}</div>` : "");
  }
}

function nextQuestion(){
  if(state.mode==="exam"){
    // In exam mode, require an answer before moving on
    const recorded = state.exam.answers[state.idx];
    if(!recorded){
      feedbackEl.className = "feedback show warn";
      feedbackEl.textContent = "Exam mode: submit an answer before moving on.";
      return;
    }
  }else if(state.mode==="test"){
    // Test mode: require submit before moving on
    if(!state.submitted){
      feedbackEl.className = "feedback show warn";
      feedbackEl.textContent = "Test mode: submit your answer before moving on.";
      return;
    }
  }

  if(state.idx >= state.queue.length - 1){
    if(state.mode==="exam"){
      finishExam(false);
      return;
    }
    // loop by reshuffling
    shuffleInPlace(state.queue);
    state.idx = 0;
    renderCurrent();
    flip(false);
    return;
  }

  state.idx++;
  renderCurrent();
  flip(false);
}

function finishExam(forcedByTime){
  if(state.exam.timerId){ clearInterval(state.exam.timerId); state.exam.timerId=null; }

  // ensure all answered? If not, mark unanswered as incorrect
  for(let i=0;i<state.queue.length;i++){
    if(!state.exam.answers[i]){
      const q = state.queue[i];
      state.exam.answers[i] = {
        q,
        pickedIndex: null,
        correctIndex: q.correctIndex,
        pickedText: "(no answer)",
        correctText: q.choices[q.correctIndex],
        isCorrect: false
      };
    }
  }

  const total = state.exam.answers.length;
  const correct = state.exam.answers.filter(a=>a.isCorrect).length;
  const pct = Math.round((correct/total)*100);

  $("resultsSummary").textContent =
    `${forcedByTime ? "Time is up. " : ""}Score: ${correct} / ${total} (${pct}%). Review below.`;

  const list = $("resultsList");
  list.innerHTML = "";
  state.exam.answers.forEach((a, i)=>{
    const lab = LABS.find(l=>l.id===a.q.labId);
    const div = document.createElement("div");
    div.className = "resultCard";
    div.innerHTML = `
      <div class="meta">
        Q${i+1} • ${lab ? lab.name : "Lab"} • ${lab ? lab.topic : ""}
        <span class="badge ${a.isCorrect ? "good" : "bad"}">${a.isCorrect ? "Correct" : "Incorrect"}</span>
      </div>
      <p class="qt">${escapeHtml(a.q.prompt)}</p>
      <div class="ans"><strong>Your answer:</strong> ${escapeHtml(a.pickedText || "(no answer)")}</div>
      <div class="ans"><strong>Correct:</strong> ${escapeHtml(a.correctText)}</div>
      ${a.q.explanation ? `<div class="explanation"><strong>Why?</strong> ${escapeHtml(a.q.explanation)}</div>` : ""}
    `;
    list.appendChild(div);
  });

  openResults();
}

/* =========================
   UI Wiring
========================= */
$("settingsBtn").addEventListener("click", openSettings);
$("closeSettingsBtn").addEventListener("click", closeSettings);

$("helpBtn").addEventListener("click", openHelp);
$("closeHelpBtn").addEventListener("click", closeHelp);

$("closeResultsBtn").addEventListener("click", closeResults);
$("restartBtn").addEventListener("click", ()=>{
  closeResults();
  openSettings();
});

flipBtn.addEventListener("click", ()=>flip());
$("coverSide").addEventListener("click", ()=>flip(true));

revealBtn.addEventListener("click", revealAnswer);
submitBtn.addEventListener("click", submitAnswer);
nextBtn.addEventListener("click", nextQuestion);

resetBtn.addEventListener("click", ()=>{
  localStorage.removeItem("kin100_flashcards_prefs");
  state.selectedLabs = [1,2,3,4,5,6];
  state.mode = "learn";
  state.sessionN = 30;
  state.exam.n = 20;
  state.exam.timeMin = 0;
  remember.value = "yes";
  renderSettings();
});

startBtn.addEventListener("click", ()=>{
  // pull settings from modal
  state.remember = (remember.value === "yes");
  state.sessionN = Number(sessionCount.value)==9999 ? 9999 : Number(sessionCount.value)||30;
  state.exam.n = Number(examCount.value)||20;
  state.exam.timeMin = Number(examTime.value)||0;
  savePrefs();
  startSession();
});

$("restartBtn").addEventListener("click", ()=>{
  closeResults();
  openSettings();
});

/* =========================
   Region quick-select mapping
========================= */
const REGION_MAP = {
  upper: [1,2,3,4,5,6],
  lower: [7,8,9,10],
  core:  [7],
  neuro: [11],
  all:   [1,2,3,4,5,6,7,8,9,10,11],
  none:  []
};

function getPoolCount(labIds){
  let n = 0;
  for(const id of labIds) n += (parseQuestionsForLab(id)).length;
  return n;
}

function updateSelectCount(){
  const n = state.selectedLabs.length;
  const q = getPoolCount(state.selectedLabs);
  $("selectCount").innerHTML = `<strong>${n}</strong> lab${n!==1?"s":""} selected &middot; <strong>${q}</strong> question${q!==1?"s":""} in pool`;
}

function updateLabTiles(){
  document.querySelectorAll(".lab-tile").forEach(tile=>{
    const id = Number(tile.dataset.labId);
    tile.classList.toggle("selected", state.selectedLabs.includes(id));
  });
  updateSelectCount();
  updateRegionChips();
  setPills();
}

function updateRegionChips(){
  document.querySelectorAll(".region-chip").forEach(chip=>{
    const region = chip.dataset.region;
    const ids = REGION_MAP[region];
    if(!ids || region==="none") {
      chip.classList.remove("active");
      return;
    }
    const allSelected = ids.every(id => state.selectedLabs.includes(id));
    chip.classList.toggle("active", allSelected);
  });
}

function updateModeCards(){
  document.querySelectorAll(".mode-card").forEach(card=>{
    const mode = card.dataset.mode;
    card.classList.toggle("selected", state.mode === mode);
    card.querySelector("input").checked = (state.mode === mode);
  });
  examFields.style.display = (state.mode==="exam") ? "block" : "none";
  $("studyFields").style.display = (state.mode==="exam") ? "none" : "block";
}

// Region bar clicks
$("regionBar").addEventListener("click", (e)=>{
  const chip = e.target.closest(".region-chip");
  if(!chip) return;
  const region = chip.dataset.region;
  const ids = REGION_MAP[region];
  if(!ids) return;

  if(region === "none"){
    state.selectedLabs = [];
  } else if(region === "all"){
    state.selectedLabs = [...REGION_MAP.all];
  } else {
    // Toggle: if all in region are selected, deselect them; otherwise select them
    const allSelected = ids.every(id => state.selectedLabs.includes(id));
    if(allSelected){
      state.selectedLabs = state.selectedLabs.filter(id => !ids.includes(id));
    } else {
      for(const id of ids){
        if(!state.selectedLabs.includes(id)) state.selectedLabs.push(id);
      }
    }
  }
  updateLabTiles();
});

// Mode card clicks
$("modeRow").addEventListener("click", (e)=>{
  const card = e.target.closest(".mode-card");
  if(!card) return;
  const mode = card.dataset.mode;
  state.mode = mode;
  updateModeCards();
  setPills();
});

function renderSettings(){
  // Lab tiles
  labsList.innerHTML = "";
  LABS.forEach((l, i)=>{
    const tile = document.createElement("div");
    tile.className = "lab-tile" + (state.selectedLabs.includes(l.id) ? " selected" : "");
    tile.dataset.labId = String(l.id);
    tile.style.animationDelay = `${i * 0.04}s`;
    tile.innerHTML = `
      <div class="tile-check">\u2713</div>
      <div class="tile-num">${String(l.id).padStart(2,"0")}</div>
      <div class="tile-name">${l.name}</div>
      <div class="tile-topic">${l.topic}</div>
    `;
    tile.addEventListener("click", ()=>{
      const id = l.id;
      if(state.selectedLabs.includes(id)){
        state.selectedLabs = state.selectedLabs.filter(x=>x!==id);
      } else {
        state.selectedLabs.push(id);
      }
      updateLabTiles();
    });
    labsList.appendChild(tile);
  });

  // Mode cards
  document.querySelectorAll(".mode-card").forEach((card, i)=>{
    card.style.animationDelay = `${0.44 + i * 0.06}s`;
  });
  updateModeCards();

  // Fields
  examCount.value = String(state.exam.n || 20);
  examTime.value = String(state.exam.timeMin || 0);
  if(state.sessionN===9999) sessionCount.value = "9999";
  else sessionCount.value = String(state.sessionN || 30);
  remember.value = state.remember ? "yes" : "no";

  updateLabTiles();
  setPills();
}

/* =========================
   Keyboard Shortcuts
========================= */
document.addEventListener("keydown", (e)=>{
  // If a modal is open, keep shortcuts minimal
  const settingsOpen = settingsModalBack.classList.contains("show");
  const helpOpen = helpModalBack.classList.contains("show");
  const resultsOpen = resultsModalBack.classList.contains("show");

  if(e.key === "Escape"){
    if(helpOpen) closeHelp();
    else if(resultsOpen) closeResults();
    else if(settingsOpen) closeSettings();
    else openSettings();
    return;
  }
  if(e.key === "?" || (e.shiftKey && e.key === "/")){
    if(!helpOpen) openHelp(); else closeHelp();
    return;
  }

  if(settingsOpen || helpOpen || resultsOpen) return;

  if(e.key === " "){
    e.preventDefault();
    flip();
    return;
  }
  if(e.key.toLowerCase() === "n"){
    nextQuestion();
    return;
  }
  if(e.key.toLowerCase() === "r"){
    revealAnswer();
    return;
  }
  if(e.key === "Enter"){
    // if already submitted in test/exam, Enter advances; otherwise submits
    if(state.mode==="exam"){
      const recorded = state.exam.answers[state.idx];
      if(recorded) nextQuestion(); else submitAnswer();
    }else if(state.mode==="test"){
      if(state.submitted) nextQuestion(); else submitAnswer();
    }else{
      // Learn: if revealed or submitted, advance; else submit
      if(state.revealed || state.submitted) nextQuestion();
      else submitAnswer();
    }
    return;
  }

  // 1–4 selects option (but does not auto-submit)
  const k = e.key;
  if(["1","2","3","4"].includes(k)){
    const idx = Number(k)-1;
    selectChoice(idx);
    return;
  }
});

/* =========================
   Touch / Swipe Gestures
========================= */
(function(){
  let startX = 0, startY = 0, startTime = 0;
  const MIN_DIST = 50;   // minimum swipe distance in px
  const MAX_TIME = 400;  // max ms for a swipe
  const cardWrap = document.querySelector(".cardWrap");
  if(!cardWrap) return;

  cardWrap.addEventListener("touchstart", function(e){
    const t = e.touches[0];
    startX = t.clientX;
    startY = t.clientY;
    startTime = Date.now();
  }, {passive: true});

  cardWrap.addEventListener("touchend", function(e){
    const t = e.changedTouches[0];
    const dx = t.clientX - startX;
    const dy = t.clientY - startY;
    const elapsed = Date.now() - startTime;
    if(elapsed > MAX_TIME) return;

    const absDx = Math.abs(dx);
    const absDy = Math.abs(dy);

    // Require one axis to dominate
    if(absDx < MIN_DIST && absDy < MIN_DIST) return;

    if(absDy > absDx){
      // Vertical swipe — swipe up to flip to question, swipe down to flip to cover
      if(dy < 0) flip(true);   // swipe up → show question
      else flip(false);         // swipe down → show cover
    }else{
      // Horizontal swipe — swipe left for next
      if(dx < 0) nextQuestion();
      // swipe right is intentionally a no-op (no "previous" feature)
    }
  }, {passive: true});
})();

/* =========================
   Init
========================= */
loadPrefs();
state.remember = true; // default; modal controls whether to persist
renderSettings();

// initial UI state
setPills();
setCoverForLab(state.selectedLabs[0] || 1);
renderCurrent();
openSettings();
</script>
</body>
</html>
