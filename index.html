<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>KIN 100 Review ‚Äî Shoulder & Arm (Flashcards + MCQ)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#fafafa; --fg:#161616; --muted:#6b6b6b; --surface:#ffffff; --border:#e6e6e6;
      --accent:#7d5cff; --accent-2:#ffd166; --ok:#2e7d32; --err:#b00020;
      --focus:2px solid #7d5cff; --radius:14px; --shadow:0 8px 24px rgba(0,0,0,.08);
      --btn-shadow:0 4px 12px rgba(125,92,255,.25);
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    /* DARK MODE */
    body.dark{
      --bg:#000; --fg:#fff; --muted:#cfcfcf; --surface:#000; --border:#333;
      --accent:#8f7bff; --accent-2:#ffd166; --ok:#2e7d32; --err:#ff5c6c;
    }

    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:var(--font);line-height:1.5}
    .skip{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
    .skip:focus{left:16px;top:16px;width:auto;height:auto;background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px}

    header{position:sticky;top:0;z-index:3;background:linear-gradient(90deg,var(--surface),#f6f3ff);border-bottom:1px solid var(--border);padding:14px 16px}
    body.dark header{background:linear-gradient(90deg,#000,#0e0b16)}
    header .title{font-weight:700;font-size:1.1rem}
    header .subtitle{color:var(--muted);font-size:.95rem}

    .container{max-width:980px;margin:16px auto;padding:0 16px}
    .bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin:12px 0 18px}

    .tabs[role="tablist"]{display:flex;gap:6px;padding:6px;background:var(--surface);border:1px solid var(--border);border-radius:999px}
    .tabs button{border:0;background:none;padding:10px 14px;border-radius:999px;cursor:pointer;color:var(--muted);font-weight:600}
    .tabs button[aria-selected="true"]{background:var(--accent);color:#fff;box-shadow:var(--btn-shadow)}

    .filters,.session{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    fieldset{border:1px dashed var(--border);border-radius:12px;padding:8px 10px}
    legend{padding:0 6px;color:var(--muted);font-size:.9rem}
    label{display:inline-flex;gap:8px;align-items:center;font-size:.95rem}
    input[type="checkbox"],input[type="radio"]{width:18px;height:18px}

    .panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
    body.dark .panel{background:#000;border-color:var(--border);color:#fff}

    /* Flashcards (flipper) */
    .flash-wrap{display:grid;gap:14px}
    .card{
      position:relative; min-height:200px; text-align:center;
      border:1px solid var(--border); border-radius:18px; background:var(--surface); box-shadow:var(--shadow);
      perspective:1000px; /* for 3D flip */
    }
    body.dark .card{background:#000;color:#fff;border-color:var(--border)}
    .card .inner{
      position:relative; width:100%; height:100%;
      transform-style:preserve-3d; transition:transform .45s ease;
      display:block;
    }
    body.reduced-motion .card .inner{transition:none}
    .card.flipped .inner{ transform:rotateY(180deg); }
    .face{
      position:absolute; inset:0; display:grid; place-items:center; padding:24px;
      font-size:1.15rem;
      backface-visibility:hidden; -webkit-backface-visibility:hidden;
    }
    .face small{display:block;color:var(--muted)}
    .face.back{ transform:rotateY(180deg); } /* prepares readable back */
    body.dark .face{color:#fff}

    .flash-actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
    .btn{border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:650;background:#f3f0ff;color:#3a2c90}
    .btn.primary{background:var(--accent);color:#fff;box-shadow:var(--btn-shadow)}
    .btn.ghost{background:#f8f8f8;color:#333}
    .btn.good{background:#e8f5e9;color:var(--ok)}
    .btn.bad{background:#ffebee;color:#b00020}
    body.dark .btn{color:#fff}
    body.dark .btn.ghost{background:#111;color:#fff}
    body.dark .btn.good, body.dark .btn.bad{color:#fff}

    .stats{display:flex;gap:12px;justify-content:center;color:var(--muted);font-size:.95rem}
    .barline{height:10px;background:#f0f0f6;border-radius:999px;overflow:hidden}
    .barline > span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent-2))}
    body.dark .barline{background:#222}

    /* MCQ */
    .q-wrap{display:grid;gap:14px}
    .choices{display:grid;gap:8px}
    .choice{
      display:flex;gap:10px;align-items:flex-start;border:1px solid var(--border);border-radius:12px;padding:10px 12px;cursor:pointer;background:#fff
    }
    .choice[data-state="correct"]{border-color:var(--ok);box-shadow:0 0 0 2px rgba(46,125,50,.2) inset}
    .choice[data-state="wrong"]{border-color:var(--err);box-shadow:0 0 0 2px rgba(176,0,32,.15) inset}
    .choice input{margin-top:3px}
    .rationale{border-left:4px solid var(--accent);padding:10px 12px;background:#fbfbff;border-radius:10px}
    .score{font-weight:700}
    body.dark .choice{background:#000;color:#fff;border-color:var(--border)}
    body.dark .rationale{background:#0a0a0a;color:#fff;border-left-color:var(--accent)}

    footer{color:var(--muted);font-size:.85rem;padding:28px 16px;text-align:center}
    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#111;color:#fff;padding:8px 12px;border-radius:999px;font-size:.9rem;opacity:0;transition:opacity .25s ease}
    .toast.show{opacity:1}

    /* Confetti (emoji) */
    .confetti{position:fixed;pointer-events:none;inset:0;overflow:hidden;z-index:1000}
    .bit{position:absolute;font-size:18px;animation:fall 900ms ease-out forwards}
    @keyframes fall{from{transform:translateY(0) rotate(0deg);opacity:1}to{transform:translateY(120vh) rotate(540deg);opacity:0}}
    body.reduced-motion .bit{animation:none;opacity:0}

    /* Shuffle animation overlay */
    .shuffle-overlay{
      position:absolute; inset:0; pointer-events:none; display:none; z-index:5;
    }
    .shuffle-overlay.show{ display:block; }
    .mini-card{
      position:absolute; width:64px; height:42px; border-radius:8px; background:#fff;
      border:1px solid var(--border); box-shadow:var(--shadow); opacity:0;
      left:50%; top:50%; transform:translate(-200%,-50%) rotate(0deg);
      animation: riffle 650ms ease-in-out forwards;
    }
    @keyframes riffle {
      0%   { transform:translate(-200%,-50%) rotate(var(--rot,0deg)); opacity:0 }
      50%  { transform:translate(-50%,-50%) rotate(calc(var(--rot,0deg) + 8deg)); opacity:1 }
      100% { transform:translate(110%,-50%) rotate(calc(var(--rot,0deg) + 18deg)); opacity:0 }
    }

    .session .btn{padding:8px 12px}
    .hidden{display:none !important}
    :focus-visible{outline:var(--focus);outline-offset:2px}
  </style>
</head>
<body>
  <a href="#main" class="skip">Skip to content</a>
  <header>
    <div class="container">
      <div class="title">KIN 100 Review ‚Äî Shoulder &amp; Arm</div>
      <div class="subtitle">Flashcards &amp; MCQ ‚Ä¢ text‚Äëonly v1 (images can be added later)</div>
    </div>
  </header>

  <div class="container" id="main">
    <div class="bar">
      <div class="tabs" role="tablist" aria-label="Mode">
        <button id="tab-flash" role="tab" aria-selected="true" aria-controls="flashcardsPanel">Flashcards</button>
        <button id="tab-mcq" role="tab" aria-selected="false" aria-controls="mcqPanel">MCQ</button>
      </div>

      <fieldset class="filters">
        <legend>Filters</legend>
        <label><input type="checkbox" data-filter="shoulder" checked> Shoulder</label>
        <label><input type="checkbox" data-filter="arm" checked> Arm</label>
        <label><input type="checkbox" data-filter="muscles" checked> Muscles</label>
        <label><input type="checkbox" data-filter="bones" checked> Bones</label>
        <label><input type="checkbox" data-filter="innervation" checked> Innervation</label>
      </fieldset>

      <div class="session">
        <label title="Dark mode"><input type="checkbox" id="darkToggle"> Dark mode</label>
        <label title="Reduce animations"><input type="checkbox" id="rmToggle"> Reduced motion</label>
      </div>
    </div>

    <!-- Flashcards -->
    <section id="flashcardsPanel" class="panel flash-wrap" role="tabpanel" aria-labelledby="tab-flash">
      <div class="bar" style="justify-content:center; gap:14px">
        <button class="btn ghost" id="flashShuffle">Shuffle</button>
        <button class="btn ghost" id="flashReset">Reset</button>
      </div>

      <div class="card" id="flashCard" aria-live="polite" aria-atomic="true">
        <div class="inner" id="flashInner">
          <div class="face front" id="flashFront">Building deck‚Ä¶</div>
          <div class="face back" id="flashBack"></div>
        </div>
        <div class="shuffle-overlay" id="shuffleOverlay" aria-hidden="true"></div>
      </div>

      <div class="flash-actions" aria-label="Flashcard actions">
        <button class="btn" id="flashFlip" title="Space to flip">Flip</button>
        <button class="btn bad" id="flashAgain" title="A key">Again</button>
        <button class="btn good" id="flashGot" title="G key">Got it</button>
      </div>

      <div class="stats">
        <div>Deck: <span id="deckCount">0</span></div>
        <div>Remaining: <span id="deckRemaining">0</span></div>
        <div>Streak: <span id="streak">0</span> üî•</div>
      </div>
      <div class="barline" aria-hidden="true"><span id="progressFill"></span></div>
    </section>

    <!-- MCQ -->
    <section id="mcqPanel" class="panel q-wrap hidden" role="tabpanel" aria-labelledby="tab-mcq">
      <div class="bar" style="justify-content:space-between">
        <div>
          <label>Mode:
            <select id="mcqMode">
              <option value="practice">Practice (endless)</option>
              <option value="quiz">Quiz</option>
            </select>
          </label>
          <label id="quizLenWrap" class=""><span style="margin-left:8px"># Q:</span>
            <input type="number" id="quizLen" min="5" max="30" step="1" value="10" style="width:72px">
          </label>
        </div>
        <div>
          <button class="btn primary" id="mcqStart">Start</button>
          <button class="btn ghost" id="mcqStop">Stop</button>
        </div>
      </div>

      <div id="mcqStatus" class="stats" aria-live="polite"></div>

      <div id="mcqQ" class="panel" style="background:#fff; border-radius:12px; border:1px solid var(--border); box-shadow:var(--shadow)">
        <div id="mcqStem" style="font-size:1.1rem; font-weight:700; margin-bottom:8px">Press Start</div>
        <div id="mcqChoices" class="choices" role="group" aria-label="Choices"></div>
        <div id="mcqRationale" class="rationale hidden"></div>
        <div class="bar" style="justify-content:space-between; margin-top:6px">
          <div><span class="score" id="mcqScore">0/0</span></div>
          <div>
            <button class="btn" id="mcqNext" title="N key">Next</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite" aria-atomic="true"></div>
  <div class="confetti" id="confetti" aria-hidden="true"></div>

  <script>
    /* =======================
       Data ‚Äî plain JS array
       ======================= */
    const BANK = [
      {type:"flash",tags:["shoulder","muscles","innervation"],front:"Deltoid ‚Äî innervation?",back:"Axillary nerve (C5‚ÄìC6)."},
      {type:"flash",tags:["shoulder","muscles"],front:"Deltoid (middle fibers) ‚Äî primary action?",back:"Shoulder abduction (~15‚Äì90¬∞)."},
      {type:"flash",tags:["shoulder","muscles","innervation"],front:"Teres minor ‚Äî action + innervation?",back:"External (lateral) rotation; axillary nerve."},
      {type:"flash",tags:["shoulder","muscles","innervation"],front:"Supraspinatus ‚Äî role + innervation?",back:"Initiates abduction (0‚Äì15¬∞); suprascapular nerve."},
      {type:"flash",tags:["shoulder","muscles","innervation"],front:"Infraspinatus ‚Äî action + innervation?",back:"External rotation; suprascapular nerve."},
      {type:"flash",tags:["shoulder","muscles","innervation"],front:"Subscapularis ‚Äî action + innervation?",back:"Internal (medial) rotation; upper & lower subscapular nerves."},
      {type:"flash",tags:["shoulder","muscles"],front:"Rotator cuff muscles (SITS)?",back:"Supraspinatus, Infraspinatus, Teres minor, Subscapularis."},
      {type:"flash",tags:["arm","muscles","innervation"],front:"Biceps brachii ‚Äî major actions + nerve?",back:"Forearm supination; elbow flexion (best when supinated); musculocutaneous nerve (C5‚ÄìC7)."},
      {type:"flash",tags:["arm","muscles","innervation"],front:"Brachialis ‚Äî action + nerve?",back:"Primary elbow flexor in all positions; musculocutaneous nerve (C5‚ÄìC6)."},
      {type:"flash",tags:["arm","muscles","innervation"],front:"Coracobrachialis ‚Äî action + nerve?",back:"Flexes & adducts shoulder; pierced by musculocutaneous nerve."},
      {type:"flash",tags:["arm","muscles","innervation"],front:"Triceps brachii ‚Äî action + nerve?",back:"Elbow extension; long head assists shoulder extension/adduction; radial nerve (C6‚ÄìC8)."},
      {type:"flash",tags:["shoulder","muscles","innervation"],front:"Serratus anterior ‚Äî nerve + key function?",back:"Long thoracic nerve (C5‚ÄìC7); protracts & upwardly rotates scapula; stabilizes against thorax."},
      {type:"flash",tags:["shoulder","muscles","innervation"],front:"Latissimus dorsi ‚Äî nerve?",back:"Thoracodorsal nerve (C6‚ÄìC8)."},
      {type:"flash",tags:["shoulder","muscles","innervation"],front:"Pectoralis major ‚Äî nerves?",back:"Medial & lateral pectoral nerves; adducts & internally rotates shoulder."},
      {type:"flash",tags:["shoulder","muscles","innervation"],front:"Pectoralis minor ‚Äî attachments + nerve?",back:"Ribs 3‚Äì5 to coracoid process; stabilizes scapula; medial pectoral nerve."},
      {type:"flash",tags:["arm","bones"],front:"Deltoid tuberosity ‚Äî what & where?",back:"Lateral humerus; insertion for deltoid."},
      {type:"flash",tags:["arm","bones","innervation"],front:"Surgical neck of humerus ‚Äî clinical relevance?",back:"Fracture risk to axillary nerve & posterior circumflex humeral artery."},
      {type:"flash",tags:["arm","bones","innervation"],front:"Midshaft humerus fracture ‚Äî key nerve risk?",back:"Radial nerve in radial groove ‚Üí wrist drop."},
      {type:"flash",tags:["shoulder","bones"],front:"Quadrangular space ‚Äî contents?",back:"Axillary nerve & posterior circumflex humeral artery."},
      {type:"flash",tags:["arm","bones"],front:"Triangular interval ‚Äî contents?",back:"Radial nerve & profunda brachii (deep brachial) artery."},
      {type:"flash",tags:["arm","bones"],front:"Intertubercular (bicipital) groove ‚Äî notable content?",back:"Tendon of long head of biceps brachii."},
      {type:"flash",tags:["shoulder","bones"],front:"Long head of biceps ‚Äî origin?",back:"Supraglenoid tubercle of scapula."},
      {type:"flash",tags:["shoulder","bones"],front:"Short head of biceps ‚Äî origin?",back:"Coracoid process of scapula."},
      {type:"flash",tags:["shoulder","bones"],front:"Long head of triceps ‚Äî origin?",back:"Infraglenoid tubercle of scapula."},
      {type:"flash",tags:["arm","innervation"],front:"Musculocutaneous nerve ‚Äî terminal sensory branch?",back:"Lateral cutaneous nerve of forearm."},
      {type:"flash",tags:["shoulder","innervation"],front:"Axillary nerve ‚Äî sensory patch?",back:"‚ÄòRegimental badge‚Äô area over lateral deltoid."},

      {type:"mcq",tags:["shoulder","innervation"],stem:"Which nerve innervates the deltoid muscle?",options:["Radial","Axillary","Musculocutaneous","Median"],answerIndex:1,rationale:"Deltoid (and teres minor) receive axillary nerve (C5‚ÄìC6)."},
      {type:"mcq",tags:["shoulder","muscles"],stem:"Which muscle initiates glenohumeral abduction (0‚Äì15¬∞)?",options:["Supraspinatus","Deltoid","Infraspinatus","Subscapularis"],answerIndex:0,rationale:"Supraspinatus initiates abduction before the deltoid becomes more effective."},
      {type:"mcq",tags:["arm","innervation"],stem:"The anterior compartment of the arm is primarily innervated by which nerve?",options:["Radial","Ulnar","Musculocutaneous","Axillary"],answerIndex:2,rationale:"Biceps brachii, brachialis (primarily), and coracobrachialis are musculocutaneous."},
      {type:"mcq",tags:["arm","innervation","bones"],stem:"A fracture of the surgical neck of the humerus endangers which nerve?",options:["Radial","Median","Axillary","Ulnar"],answerIndex:2,rationale:"Axillary nerve + posterior circumflex humeral artery wrap around the surgical neck."},
      {type:"mcq",tags:["arm","innervation","bones"],stem:"A midshaft humeral fracture classically injures which nerve?",options:["Ulnar","Radial","Musculocutaneous","Axillary"],answerIndex:1,rationale:"The radial nerve lies in the radial groove at the humeral shaft ‚Äî injury ‚Üí wrist/finger extensor weakness."},
      {type:"mcq",tags:["arm","muscles","bones"],stem:"Which muscle inserts on the deltoid tuberosity?",options:["Deltoid","Teres major","Latissimus dorsi","Pectoralis major"],answerIndex:0,rationale:"The deltoid inserts on the deltoid tuberosity (lateral humerus)."},
      {type:"mcq",tags:["shoulder","bones","innervation"],stem:"Which structure passes through the quadrangular space along with the posterior circumflex humeral artery?",options:["Radial nerve","Axillary nerve","Musculocutaneous nerve","Ulnar nerve"],answerIndex:1,rationale:"Quadrangular space: axillary nerve + PCHA."},
      {type:"mcq",tags:["shoulder","innervation","muscles"],stem:"Injury to the long thoracic nerve primarily weakens which muscle?",options:["Rhomboid major","Serratus anterior","Trapezius","Latissimus dorsi"],answerIndex:1,rationale:"Long thoracic ‚Üí serratus anterior; injury ‚Üí winged scapula with push‚Äëup motion."},
      {type:"mcq",tags:["shoulder","muscles"],stem:"Which of the following is an external (lateral) rotator of the shoulder?",options:["Subscapularis","Teres major","Infraspinatus","Pectoralis major"],answerIndex:2,rationale:"Infraspinatus (and teres minor) laterally rotate; subscapularis medially rotates."},
      {type:"mcq",tags:["shoulder","bones","muscles"],stem:"The tendon of which muscle travels in the intertubercular (bicipital) groove?",options:["Biceps brachii long head","Biceps brachii short head","Triceps long head","Brachialis"],answerIndex:0,rationale:"Long head biceps tendon runs in the groove enclosed by the transverse humeral ligament."},
      {type:"mcq",tags:["arm","innervation"],stem:"Innervation of triceps brachii?",options:["Radial","Axillary","Musculocutaneous","Median"],answerIndex:0,rationale:"All heads of triceps are innervated by the radial nerve."},
      {type:"mcq",tags:["arm","bones","innervation"],stem:"Which artery typically accompanies the radial nerve through the triangular interval?",options:["Posterior circumflex humeral","Profunda brachii (deep brachial)","Anterior circumflex humeral","Radial recurrent"],answerIndex:1,rationale:"Triangular interval: radial nerve + profunda brachii artery."},
      {type:"mcq",tags:["shoulder","muscles"],stem:"Actions of latissimus dorsi at the shoulder include all EXCEPT:",options:["Adduction","Internal rotation","Abduction","Extension"],answerIndex:2,rationale:"Lat dorsi adducts, extends, and medially rotates ‚Äî not abduction."},
      {type:"mcq",tags:["shoulder","innervation"],stem:"Cutaneous sensation over the lateral deltoid (\"regimental badge\" area) is supplied by:",options:["Radial nerve","Axillary nerve","Suprascapular nerve","Lateral pectoral nerve"],answerIndex:1,rationale:"Superior lateral cutaneous nerve of the arm is a branch of axillary."},
      {type:"mcq",tags:["shoulder","bones","innervation"],stem:"The axillary nerve is a branch of which cord of the brachial plexus?",options:["Lateral","Medial","Posterior","Superior trunk"],answerIndex:2,rationale:"Axillary and radial nerves arise from the posterior cord."},
      {type:"mcq",tags:["shoulder","bones","muscles"],stem:"Which muscle originates from the supraglenoid tubercle of the scapula?",options:["Triceps long head","Biceps long head","Biceps short head","Teres minor"],answerIndex:1,rationale:"Biceps long head from supraglenoid; triceps long head from infraglenoid."}
    ];

    /* =======================
       Helpers & state
       ======================= */
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const REGIONS = ['shoulder','arm'];
    const DOMAINS = ['muscles','bones','innervation'];
    let activeFilters = new Set([...REGIONS, ...DOMAINS]);

    const rnd = n => Math.floor(Math.random()*n);
    const shuffle = arr => { const a=[...arr]; for(let i=a.length-1;i>0;i--){const j=rnd(i+1); [a[i],a[j]]=[a[j],a[i]];} return a; };
    const intersects = (a,b) => a.some(x => b.includes(x));
    const matchesFilters = (item) => {
      const itemTags = item.tags||[];
      const selRegions = REGIONS.filter(t => activeFilters.has(t));
      const selDomains = DOMAINS.filter(t => activeFilters.has(t));
      const itemRegions = itemTags.filter(t=>REGIONS.includes(t));
      const itemDomains = itemTags.filter(t=>DOMAINS.includes(t));
      const regionOK = itemRegions.length===0 || intersects(itemRegions, selRegions);
      const domainOK = itemDomains.length===0 || intersects(itemDomains, selDomains);
      return regionOK && domainOK;
    };

    function say(msg){
      const t = $('#toast');
      t.textContent = msg;
      t.classList.add('show');
      clearTimeout(say._t);
      say._t = setTimeout(()=>t.classList.remove('show'), 1200);
    }
    function confettiBurst(){
      if(document.body.classList.contains('reduced-motion')) return;
      const ems = ['üéâ','üí™','ü¶¥','‚≠ê','üî•'];
      const c = $('#confetti');
      for(let i=0;i<22;i++){
        const b = document.createElement('span');
        b.className='bit';
        b.textContent = ems[rnd(ems.length)];
        b.style.left = (5 + Math.random()*90) + 'vw';
        b.style.top = '-10vh';
        b.style.animationDelay = (Math.random()*0.2) + 's';
        c.appendChild(b);
        setTimeout(()=>b.remove(), 1000);
      }
    }

    /* =======================
       Shuffle animation
       ======================= */
    function createMiniCard(delayMs, rotDeg){
      const el = document.createElement('div');
      el.className = 'mini-card';
      el.style.setProperty('--rot', rotDeg + 'deg');
      el.style.animationDelay = delayMs + 'ms';
      return el;
    }
    function animateShuffle(duration=700){
      return new Promise(resolve=>{
        const overlay = $('#shuffleOverlay');
        overlay.innerHTML = '';
        overlay.classList.add('show');
        for(let i=0;i<10;i++){
          const d = 40 * i;
          const r = -6 + Math.random()*12;
          overlay.appendChild(createMiniCard(d, r));
        }
        setTimeout(()=>{ overlay.classList.remove('show'); overlay.innerHTML=''; resolve(); }, duration);
      });
    }

    /* =======================
       Filters / Toggles
       ======================= */
    $$('.filters input[type="checkbox"]').forEach(cb=>{
      cb.addEventListener('change', ()=>{
        if(cb.checked) activeFilters.add(cb.dataset.filter); else activeFilters.delete(cb.dataset.filter);
        refreshFlashDeck(true);
        mcqStop();
      });
    });
    $('#darkToggle').addEventListener('change', (e)=> document.body.classList.toggle('dark', e.target.checked));
    $('#rmToggle').addEventListener('change', (e)=> document.body.classList.toggle('reduced-motion', e.target.checked));

    /* =======================
       Tabs
       ======================= */
    const tabs = {
      flash: {btn: $('#tab-flash'), panel: $('#flashcardsPanel')},
      mcq:   {btn: $('#tab-mcq'),   panel: $('#mcqPanel')}
    };
    Object.values(tabs).forEach(o=>{
      o.btn.addEventListener('click', ()=>{
        Object.values(tabs).forEach(p=>{p.btn.setAttribute('aria-selected','false'); p.panel.classList.add('hidden'); p.panel.setAttribute('hidden','');});
        o.btn.setAttribute('aria-selected','true');
        o.panel.classList.remove('hidden'); o.panel.removeAttribute('hidden');
      });
    });

    /* =======================
       Flashcards (logic)
       ======================= */
    let flashDeck = [];
    let deckIndex = 0;
    let showBack = false;
    let streak = 0;

    function currentFlash(){ return flashDeck[deckIndex] || null; }
    function updateFlashUI(announce){
      const front = $('#flashFront'), back = $('#flashBack'), card = $('#flashCard'), inner = $('#flashInner');
      $('#streak').textContent = String(streak);
      $('#deckCount').textContent = flashDeck.length;
      const remain = flashDeck.length ? (flashDeck.length - deckIndex) : 0;
      $('#deckRemaining').textContent = String(remain);
      const pct = flashDeck.length ? Math.round((deckIndex/flashDeck.length)*100) : 0;
      $('#progressFill').style.width = pct + '%';

      if(!flashDeck.length){
        front.innerHTML = "No flashcards match your filters.<br><small>Toggle filters above (Shoulder/Arm/Muscles/Bones/Innervation).</small>";
        back.textContent = "";
        $('#flashFlip').disabled = true; $('#flashAgain').disabled = true; $('#flashGot').disabled = true;
        card.classList.remove('flipped'); return;
      }
      $('#flashFlip').disabled = false; $('#flashAgain').disabled = false; $('#flashGot').disabled = false;

      const item = currentFlash();
      if(!item){
        front.textContent = "Deck complete. Shuffle or reset to go again.";
        back.textContent = "";
        card.classList.remove('flipped'); return;
      }
      front.innerHTML = item.front + '<br><small>Press Space or click card to flip</small>';
      back.textContent = item.back;
      card.classList.toggle('flipped', showBack);
      if(announce) say("Deck ready ¬∑ " + flashDeck.length + " cards");
    }
    function buildDeck(){
      const pool = BANK.filter(it => it.type==='flash' && matchesFilters(it));
      flashDeck = shuffle(pool);
      deckIndex = 0; showBack = false; streak = 0;
    }
    function refreshFlashDeck(announce){
      buildDeck(); updateFlashUI(announce);
    }
    function nextFlash(){
      deckIndex++; showBack = false;
      if(deckIndex >= flashDeck.length){
        $('#flashFront').innerHTML = "üéØ Deck complete ‚Äî smooth work.<br><small>Shuffle or reset to run it back.</small>";
        $('#flashBack').textContent = ""; $('#flashCard').classList.remove('flipped'); confettiBurst(); return;
      }
      updateFlashUI(false);
    }
    function againFlash(){
      const item = currentFlash(); if(!item) return;
      const insertAt = Math.min(flashDeck.length, deckIndex + 3 + Math.floor(Math.random()*3));
      flashDeck.splice(insertAt, 0, item); deckIndex++; streak = 0;
      say("One more rep."); updateFlashUI(false);
    }
    function gotFlash(){
      const item = currentFlash(); if(!item) return;
      flashDeck.splice(deckIndex, 1);
      streak++; if(streak>0 && streak % 5 === 0) confettiBurst();
      say("Nice rep."); updateFlashUI(false);
      if(deckIndex >= flashDeck.length){
        $('#flashFront').innerHTML = "üéØ Deck complete ‚Äî clean set.<br><small>Shuffle or reset to continue.</small>";
        $('#flashBack').textContent = ""; $('#flashCard').classList.remove('flipped');
      }
    }

    // Events
    $('#flashCard').addEventListener('click', ()=>{ showBack = !showBack; updateFlashUI(false); });
    $('#flashShuffle').addEventListener('click', async ()=>{ await animateShuffle(700); refreshFlashDeck(true); });
    $('#flashReset').addEventListener('click', async ()=>{ await animateShuffle(700); refreshFlashDeck(true); });
    $('#flashFlip').addEventListener('click', ()=>{ showBack = !showBack; updateFlashUI(false); });
    $('#flashAgain').addEventListener('click', againFlash);
    $('#flashGot').addEventListener('click', gotFlash);
    document.addEventListener('keydown', (e)=>{
      const flashActive = tabs.flash.btn.getAttribute('aria-selected') === 'true';
      if(!flashActive) return;
      if(e.key===' '){ e.preventDefault(); $('#flashFlip').click(); }
      if(e.key.toLowerCase()==='a'){ $('#flashAgain').click(); }
      if(e.key.toLowerCase()==='g'){ $('#flashGot').click(); }
      if(e.key==='ArrowRight'){ nextFlash(); }
    });

    /* =======================
       MCQ
       ======================= */
    let mcqSession = null;
    const qStem = $('#mcqStem'), qChoices = $('#mcqChoices'), qRat = $('#mcqRationale'), qScore = $('#mcqScore'), qStatus = $('#mcqStatus');

    function mcqStart(){
      const mode = $('#mcqMode').value;
      const pool = BANK.filter(it => it.type==='mcq' && matchesFilters(it));
      if(!pool.length){ qStem.textContent = "No MCQs match your filters."; qChoices.innerHTML=''; qRat.classList.add('hidden'); return; }
      let list = shuffle(pool);
      if(mode==='quiz'){
        const n = Math.max(5, Math.min(parseInt($('#quizLen').value||10,10), 30));
        if(list.length > n) list = list.slice(0, n);
      }
      mcqSession = { mode, list, idx:0, score:0, total:0, answered:false };
      say("Quiz loaded ¬∑ " + list.length + " Q");
      renderMCQ();
    }
    function mcqStop(){
      mcqSession = null; qStem.textContent = "Press Start"; qChoices.innerHTML = '';
      qRat.classList.add('hidden'); qScore.textContent = "0/0"; qStatus.textContent = "";
    }
    function renderMCQ(){
      if(!mcqSession) return;
      const {list, idx, score, total} = mcqSession;
      if(idx >= list.length){
        qStem.innerHTML = "üéâ Session complete.";
        qChoices.innerHTML = ''; qRat.classList.add('hidden'); qScore.textContent = `${score}/${total}`;
        qStatus.textContent = "Nice pace ‚Äî run another set."; confettiBurst(); return;
      }
      const item = list[idx]; mcqSession.answered = false;
      qStem.textContent = item.stem; qChoices.innerHTML = '';
      const shuffled = shuffle(item.options.map((opt,i)=>({opt, i})));
      qRat.textContent = item.rationale||""; qRat.classList.add('hidden');

      shuffled.forEach((o, k)=>{
        const id = `opt-${idx}-${k}`;
        const wrap = document.createElement('label');
        wrap.className = 'choice'; wrap.setAttribute('data-state','idle');
        wrap.innerHTML = `<input type="radio" name="mcq" id="${id}" value="${o.i}"><div><strong>${k+1}.</strong> <span>${o.opt}</span></div>`;
        wrap.addEventListener('click', ()=>{
          if(mcqSession.answered) return;
          const chosen = parseInt(wrap.querySelector('input').value,10);
          mcqSession.answered = true; const correct = chosen === item.answerIndex;
          mcqSession.total++; if(correct){ mcqSession.score++; wrap.dataset.state='correct'; say("Correct."); }
          else{ wrap.dataset.state='wrong'; say("Not quite."); }
          $$('#mcqChoices .choice').forEach(ch=>{
            const val = parseInt(ch.querySelector('input').value,10);
            if(val === item.answerIndex){ ch.dataset.state='correct'; }
            ch.querySelector('input').disabled = true;
          });
          qRat.classList.remove('hidden');
          qScore.textContent = `${mcqSession.score}/${mcqSession.total}`;
        });
        qChoices.appendChild(wrap);
      });
      qStatus.textContent = `Q ${idx+1} of ${list.length}`;
    }
    $('#mcqNext').addEventListener('click', ()=>{ if(!mcqSession) return; mcqSession.idx++; renderMCQ(); });
    $('#mcqStart').addEventListener('click', mcqStart);
    $('#mcqStop').addEventListener('click', mcqStop);
    $('#mcqMode').addEventListener('change', (e)=> $('#quizLenWrap').style.visibility = e.target.value==='quiz' ? 'visible' : 'hidden');

    /* =======================
       Init
       ======================= */
    refreshFlashDeck(true);
    $('#quizLenWrap').style.visibility = $('#mcqMode').value==='quiz' ? 'visible' : 'hidden';
  </script>

  <footer>
    Single‚Äëfile app ¬∑ Modify the <strong>BANK</strong> array in the script to add/edit items.  
    Dark mode switches to black background with white text throughout.
  </footer>
</body>
</html>
