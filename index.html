<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Anatomy Flash Cards</title>
<style>
  :root{
    --bg0:#050913;
    --bg1:#071225;
    --fg:#eaf3ff;
    --muted:#9bb6d3;
    --accent:#6ecbff;
    --accent2:#8a7dff;
    --surface:rgba(12,18,34,.78);
    --border:rgba(150,210,255,.18);
    --shadow:0 18px 50px rgba(0,0,0,.45);
    --radius:22px;
    --focus:2px solid rgba(110,203,255,.9);
    --maxw:860px;
    --cardw:min(92vw,560px);
    --cardh:min(56vh,500px);
    --font:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:var(--font);
    color:var(--fg);
    background:
      radial-gradient(1200px 800px at 20% 10%, rgba(110,203,255,.16), transparent 60%),
      radial-gradient(900px 700px at 80% 40%, rgba(138,125,255,.14), transparent 62%),
      radial-gradient(700px 700px at 55% 85%, rgba(110,203,255,.10), transparent 60%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
    overflow-x:hidden;
  }

  .stars{
    position:fixed; inset:0; pointer-events:none; z-index:0;
    background-image:
      radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,.35), transparent 2px),
      radial-gradient(1px 1px at 35% 70%, rgba(255,255,255,.25), transparent 2px),
      radial-gradient(1px 1px at 60% 30%, rgba(255,255,255,.25), transparent 2px),
      radial-gradient(1px 1px at 80% 80%, rgba(255,255,255,.18), transparent 2px),
      radial-gradient(1px 1px at 90% 40%, rgba(255,255,255,.18), transparent 2px),
      radial-gradient(1px 1px at 25% 45%, rgba(255,255,255,.20), transparent 2px);
    opacity:.9;
    filter: blur(.1px);
  }

  .wrap{
    position:relative; z-index:1;
    max-width:var(--maxw);
    margin:0 auto;
    padding:26px 16px 44px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:16px;
  }

  h1{
    margin:8px 0 0;
    font-size:clamp(28px, 4vw, 44px);
    letter-spacing:.2px;
    font-weight:900;
    text-align:center;
  }

  .progressRow{
    width:min(92vw, 760px);
    display:flex;
    flex-direction:column;
    gap:10px;
    align-items:center;
    margin-top:4px;
  }
  .bar{
    width:100%;
    height:12px;
    border-radius:999px;
    background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.10);
    overflow:hidden;
  }
  .bar > span{
    display:block;
    height:100%;
    width:0%;
    background:linear-gradient(90deg, rgba(110,203,255,.95), rgba(138,125,255,.95));
    border-radius:999px;
    transition:width .25s ease;
  }
  .counter{
    font-size:clamp(18px, 2.5vw, 30px);
    font-weight:800;
    color:rgba(110,203,255,.95);
  }

  .topControls{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:center;
    margin-top:2px;
  }
  button{
    border:0;
    cursor:pointer;
    border-radius:14px;
    padding:10px 14px;
    font-weight:900;
    color:#041018;
    background:rgba(110,203,255,.95);
    box-shadow:0 10px 22px rgba(0,0,0,.25);
    transition:transform .06s ease, filter .15s ease;
  }
  button:hover{transform:translateY(-1px); filter:brightness(1.03)}
  button:active{transform:translateY(0)}
  button.secondary{
    background:rgba(255,255,255,.10);
    color:var(--fg);
    border:1px solid rgba(255,255,255,.14);
    box-shadow:none;
  }
  button:focus-visible{outline:var(--focus); outline-offset:3px}

  /* Card flip */
  .cardStage{
    width:var(--cardw);
    height:var(--cardh);
    perspective: 1200px;
  }
  .card{
    position:relative;
    width:100%;
    height:100%;
    border-radius:var(--radius);
    transform-style:preserve-3d;
    transition: transform .6s cubic-bezier(.2,.8,.2,1);
    box-shadow: var(--shadow);
    cursor:pointer;
  }
  .card.isFlipped{ transform: rotateY(180deg); cursor:default; }

  .face{
    position:absolute;
    inset:0;
    backface-visibility:hidden;
    border-radius:var(--radius);
    overflow:hidden;
  }

  .frame{
    position:absolute;
    inset:0;
    border-radius:var(--radius);
    pointer-events:none;
    border:2px solid rgba(140,220,255,.45);
    box-shadow:
      0 0 0 6px rgba(110,203,255,.10) inset,
      0 0 24px rgba(110,203,255,.28),
      0 0 46px rgba(138,125,255,.18);
  }

  .front{
    background:rgba(10,18,32,.55);
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .front img{
    width:100%;
    height:100%;
    object-fit:cover;
    transform:scale(1.02);
    filter:contrast(1.05) saturate(1.05);
  }
  .front .overlay{
    position:absolute;
    inset:0;
    background:linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.52));
  }
  .front .hint{
    position:absolute;
    bottom:16px;
    left:0; right:0;
    text-align:center;
    font-weight:900;
    color:rgba(234,243,255,.92);
    text-shadow:0 6px 22px rgba(0,0,0,.55);
    padding:0 12px;
  }

  .back{
    transform: rotateY(180deg);
    background: var(--surface);
    border:1px solid rgba(255,255,255,.12);
    display:flex;
    flex-direction:column;
    padding:18px;
    gap:12px;
  }
  .meta{
    color:rgba(155,182,211,.9);
    font-weight:900;
    font-size:.98rem;
  }
  .q{
    font-size:clamp(18px, 2.2vw, 24px);
    font-weight:950;
    line-height:1.25;
    margin-top:2px;
  }

  .choicesWrap{
    position:relative;
    display:grid;
    gap:10px;
    margin-top:6px;
  }

  .choiceBtn{
    width:100%;
    text-align:left;
    padding:12px 12px;
    border-radius:14px;
    background:rgba(255,255,255,.08);
    color:rgba(234,243,255,.96);
    border:1px solid rgba(255,255,255,.14);
    box-shadow:none;
    font-weight:900;
    display:flex;
    gap:10px;
    align-items:flex-start;
  }
  .choiceBtn:hover{filter:brightness(1.04)}
  .choiceBtn[disabled]{opacity:.72; cursor:not-allowed}
  .badge{
    min-width:28px;
    height:28px;
    border-radius:10px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-weight:950;
    background:rgba(110,203,255,.18);
    border:1px solid rgba(110,203,255,.30);
    color:rgba(234,243,255,.96);
    margin-top:1px;
  }
  .choiceText{line-height:1.25}

  .choiceBtn.correct{
    border-color:rgba(34,197,94,.55);
    background:rgba(34,197,94,.14);
  }
  .choiceBtn.wrong{
    border-color:rgba(239,68,68,.55);
    background:rgba(239,68,68,.12);
  }
  .choiceBtn.correct .badge{background:rgba(34,197,94,.18); border-color:rgba(34,197,94,.35)}
  .choiceBtn.wrong .badge{background:rgba(239,68,68,.16); border-color:rgba(239,68,68,.35)}

  .reveal{
    display:none;
    border-left:3px solid rgba(110,203,255,.75);
    background:rgba(110,203,255,.08);
    padding:10px 12px;
    border-radius:12px;
    color:rgba(234,243,255,.95);
    font-weight:900;
    line-height:1.35;
    margin-top:4px;
  }
  .reveal.show{display:block}

  .bottomRow{
    width:var(--cardw);
    display:flex;
    justify-content:center;
    gap:10px;
    flex-wrap:wrap;
  }

  .statusLine{
    color:rgba(155,182,211,.9);
    font-size:.95rem;
    text-align:center;
    max-width:72ch;
    line-height:1.4;
  }

  .toast{
    position:fixed;
    bottom:18px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(8,18,32,.92);
    border:1px solid rgba(255,255,255,.10);
    color:rgba(234,243,255,.95);
    padding:10px 14px;
    border-radius:999px;
    font-weight:950;
    opacity:0;
    transition:opacity .2s ease;
    z-index:50;
  }
  .toast.show{opacity:1}

  /* Confetti localized around choices */
  .confettiLayer{
    position:absolute;
    inset:-10px -10px -10px -10px;
    pointer-events:none;
    overflow:visible;
  }
  .confettiBit{
    position:absolute;
    width:8px;
    height:12px;
    border-radius:2px;
    opacity:0;
    transform:translateY(0) rotate(0deg);
    animation:confettiPop 900ms ease-out forwards;
    box-shadow:0 4px 14px rgba(0,0,0,.2);
  }
  @keyframes confettiPop{
    0%{opacity:1; transform:translateY(0) rotate(0deg)}
    100%{opacity:0; transform:translateY(100px) rotate(540deg)}
  }

  /* Modal */
  .modal{
    position:fixed; inset:0;
    display:none;
    place-items:center;
    background:rgba(0,0,0,.40);
    z-index:1000;
    backdrop-filter: blur(10px) saturate(1.05);
  }
  .modal.show{display:grid}
  .modal .box{
    width:min(740px, 92vw);
    background:rgba(12,18,34,.92);
    border:1px solid rgba(255,255,255,.12);
    border-radius:18px;
    box-shadow:0 18px 44px rgba(0,0,0,.45);
    padding:18px 16px 14px;
  }
  .modal h2{
    margin:6px 0 10px;
    font-size:1.25rem;
  }
  .row{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin:10px 0;
  }
  .chip{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:9px 12px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.06);
    color:rgba(234,243,255,.95);
    font-weight:950;
    cursor:pointer;
    user-select:none;
  }
  .chip input{width:18px; height:18px}
  .modal .actions{
    display:flex;
    gap:10px;
    justify-content:flex-end;
    margin-top:14px;
    flex-wrap:wrap;
  }
  .modal .sub{
    color:rgba(155,182,211,.9);
    font-weight:900;
    margin:8px 0 0;
  }

  @media (prefers-reduced-motion: reduce){
    .card{transition:none}
    .bar > span{transition:none}
    .confettiBit{animation:none; opacity:0}
  }
</style>
</head>

<body>
<div class="stars" aria-hidden="true"></div>

<div class="wrap" id="appRoot">
  <h1>Anatomy Flash Cards</h1>

  <div class="progressRow" aria-label="Progress">
    <div class="bar" aria-hidden="true"><span id="barFill"></span></div>
    <div class="counter" id="counter">0 / 0</div>
    <div class="topControls">
      <button class="secondary" id="changeBtn" type="button">Change labs/topics</button>
      <button class="secondary" id="shuffleBtn" type="button">Shuffle</button>
      <button class="secondary" id="resetBtn" type="button">Reset</button>
    </div>
  </div>

  <div class="cardStage" aria-label="Flashcard">
    <div class="card" id="card" role="button" tabindex="0" aria-label="Flashcard. Click to flip.">
      <!-- FRONT: image (card back) -->
      <div class="face front">
        <img id="cardImg" alt="Flashcard back image" />
        <div class="overlay" aria-hidden="true"></div>
        <div class="hint" id="frontHint">Click to flip</div>
        <div class="frame" aria-hidden="true"></div>
      </div>

      <!-- BACK: MCQ -->
      <div class="face back">
        <div class="meta" id="metaLine">Pick labs/topics to begin</div>
        <div class="q" id="question">—</div>

        <div class="choicesWrap" id="choicesWrap" aria-label="Choices">
          <div class="confettiLayer" id="confettiLayer" aria-hidden="true"></div>
          <!-- choices injected here -->
        </div>

        <div class="reveal" id="revealBox" aria-live="polite"></div>

        <div class="frame" aria-hidden="true"></div>
      </div>
    </div>
  </div>

  <div class="bottomRow">
    <button class="secondary" id="revealBtn" type="button">Reveal</button>
    <button id="nextBtn" type="button">Next</button>
  </div>

  <div class="statusLine" id="statusLine"></div>
</div>

<div class="toast" id="toast" role="status" aria-live="polite" aria-atomic="true"></div>

<!-- Modal -->
<div class="modal" id="pickerModal" role="dialog" aria-modal="true" aria-labelledby="pickerTitle">
  <div class="box">
    <h2 id="pickerTitle">Choose what to study</h2>

    <div id="stepLabs">
      <div class="sub">Step 1 — Labs (pick one or more)</div>
      <div class="row" id="labChips"></div>
      <div class="actions">
        <button class="secondary" id="labsSelectAll" type="button">Select all</button>
        <button id="toTopics" type="button">Next</button>
      </div>
    </div>

    <div id="stepTopics" style="display:none">
      <div class="sub">Step 2 — Topics (pick one or more)</div>
      <div class="row" id="topicChips"></div>
      <div class="actions">
        <button class="secondary" id="backToLabs" type="button">Back</button>
        <button class="secondary" id="topicsSelectAll" type="button">Select all</button>
        <button id="startBtn" type="button">Start</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   CONFIG: images
   ========================= */
const IMAGE_DIR = "./Anatomy/images/";
const MANIFEST_URL = IMAGE_DIR + "manifest.json";

/* =========================
   DATA MODEL for MCQ
   =========================
   {
     lab: 1..11,
     topics: ["bones","muscles",...],
     stem: "Question...",
     options: ["A","B","C","D"],
     answerIndex: 0-based index into options,
     explanation: "Optional"
   }
*/
const CARD_BANK = [
  // SAMPLE ONLY — replace with your Labs 1–11 content
  { lab: 1, topics:["muscles","innervation"], stem:"Deltoid — innervation?", options:["Radial nerve","Axillary nerve","Musculocutaneous nerve","Median nerve"], answerIndex:1, explanation:"Deltoid is innervated by the axillary nerve (C5–C6)." },
  { lab: 1, topics:["muscles"], stem:"Which muscle initiates shoulder abduction (0–15°)?", options:["Deltoid","Supraspinatus","Infraspinatus","Subscapularis"], answerIndex:1 },
  { lab: 2, topics:["bones","innervation"], stem:"A midshaft humeral fracture classically injures which nerve?", options:["Ulnar","Radial","Axillary","Median"], answerIndex:1, explanation:"Radial nerve in the radial groove → wrist/finger extensor weakness." },
  { lab: 2, topics:["blood"], stem:"Artery accompanying the radial nerve through the triangular interval:", options:["Posterior circumflex humeral","Profunda brachii (deep brachial)","Anterior circumflex humeral","Radial recurrent"], answerIndex:1 }
];

/* =========================
   Helpers
   ========================= */
const $ = s => document.querySelector(s);

function say(msg){
  const t=$("#toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(say._t);
  say._t = setTimeout(()=>t.classList.remove("show"), 1400);
}
function shuffle(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function unique(arr){ return [...new Set(arr)]; }

/* =========================
   Image manifest loading
   ========================= */
let images = [];
let lastImage = null;

async function loadManifest(){
  try{
    const res = await fetch(MANIFEST_URL, { cache:"no-store" });
    if(!res.ok) throw new Error("Manifest not found");
    const data = await res.json();
    const list = Array.isArray(data) ? data : (data.images || []);
    images = list.filter(Boolean);
    if(!images.length){
      $("#statusLine").textContent =
        "Manifest loaded but contains no images. Add filenames to Anatomy/images/manifest.json.";
    }
  }catch(e){
    images = [];
    $("#statusLine").textContent =
      "Could not load Anatomy/images/manifest.json yet. Add it to enable random card-back images.";
  }
}
function pickRandomImage(){
  if(!images.length) return null;
  if(images.length === 1) return images[0];
  let pick = images[Math.floor(Math.random()*images.length)];
  let tries=0;
  while(pick === lastImage && tries < 6){
    pick = images[Math.floor(Math.random()*images.length)];
    tries++;
  }
  lastImage = pick;
  return pick;
}
function setCardBackImage(){
  const imgEl = $("#cardImg");
  const hint = $("#frontHint");

  const filename = pickRandomImage();
  if(!filename){
    imgEl.removeAttribute("src");
    imgEl.style.display="none";
    $("#card .front").style.background =
      "radial-gradient(800px 600px at 30% 25%, rgba(110,203,255,.22), transparent 55%)," +
      "radial-gradient(700px 600px at 70% 70%, rgba(138,125,255,.18), transparent 60%)," +
      "linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02))";
    hint.textContent = "Add manifest.json to enable random images";
    return;
  }

  imgEl.style.display="block";
  hint.textContent = "Click to flip";
  const url = IMAGE_DIR + encodeURIComponent(filename);
  imgEl.src = url;
  imgEl.onerror = () => {
    imgEl.style.display="none";
    hint.textContent = "Image not found — check manifest filenames";
  };
}

/* =========================
   Labs/topics selection
   ========================= */
const ALL_LABS = Array.from({length:11}, (_,i)=>i+1);
let selectedLabs = new Set([1]);
let selectedTopics = new Set();

function topicsInLabs(labsSet){
  const labs = [...labsSet];
  const topics = CARD_BANK
    .filter(c => labs.includes(c.lab))
    .flatMap(c => c.topics || []);
  return unique(topics).sort((a,b)=>a.localeCompare(b));
}
function buildDeck(){
  const labs = [...selectedLabs];
  const topics = [...selectedTopics];

  const pool = CARD_BANK.filter(c => {
    const inLab = labs.includes(c.lab);
    const inTopic = topics.length ? (c.topics || []).some(t => selectedTopics.has(t)) : true;
    return inLab && inTopic;
  });
  return shuffle(pool);
}

/* =========================
   UI state
   ========================= */
let deck = [];
let idx = 0;
let flipped = false;
let answered = false;
let lastChoiceIndex = null;

function currentCard(){ return deck[idx] || null; }

function updateProgress(){
  $("#counter").textContent = deck.length ? `${idx+1} / ${deck.length}` : `0 / 0`;
  $("#barFill").style.width = deck.length ? `${Math.round(((idx+1)/deck.length)*100)}%` : "0%";
}

function clearConfetti(){
  $("#confettiLayer").innerHTML = "";
}
function confettiAroundChoices(){
  if(window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches) return;

  const layer = $("#confettiLayer");
  layer.innerHTML = "";

  const colors = ["#6ecbff","#8a7dff","#22c55e","#f59e0b","#ef4444","#ffffff"];
  const W = layer.clientWidth || 520;
  const H = layer.clientHeight || 220;

  const n = 26;
  for(let i=0;i<n;i++){
    const bit = document.createElement("span");
    bit.className = "confettiBit";
    bit.style.left = (Math.random()*W) + "px";
    bit.style.top  = (Math.random()*H*0.25) + "px";
    bit.style.background = colors[Math.floor(Math.random()*colors.length)];
    bit.style.animationDelay = (Math.random()*0.08) + "s";
    layer.appendChild(bit);
  }
  setTimeout(()=>layer.innerHTML="", 1000);
}

function renderChoices(cardObj){
  const wrap = $("#choicesWrap");
  // remove old choice buttons (keep confetti layer)
  [...wrap.querySelectorAll(".choiceBtn")].forEach(x=>x.remove());

  const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
  (cardObj.options || []).forEach((opt, i) => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "choiceBtn";
    btn.setAttribute("data-index", String(i));
    btn.innerHTML = `<span class="badge">${letters[i] || (i+1)}</span><span class="choiceText">${opt}</span>`;
    btn.addEventListener("click", () => chooseAnswer(i));
    wrap.appendChild(btn);
  });
}

function lockChoices(lock=true){
  const btns = [...$("#choicesWrap").querySelectorAll(".choiceBtn")];
  btns.forEach(b => b.disabled = lock);
}

function markChoices(cardObj, chosenIndex, revealOnly=false){
  const btns = [...$("#choicesWrap").querySelectorAll(".choiceBtn")];
  btns.forEach((b, i) => {
    b.classList.remove("correct","wrong");
    if(i === cardObj.answerIndex) b.classList.add("correct");
    if(!revealOnly && chosenIndex === i && chosenIndex !== cardObj.answerIndex) b.classList.add("wrong");
  });
}

function setQuestionUI(){
  const c = currentCard();
  if(!c){
    $("#metaLine").textContent = "No cards match your selection";
    $("#question").textContent = "Change labs/topics to begin.";
    $("#revealBox").classList.remove("show");
    $("#revealBox").textContent = "";
    // clear choices
    [...$("#choicesWrap").querySelectorAll(".choiceBtn")].forEach(x=>x.remove());
    return;
  }

  $("#metaLine").textContent = `Lab ${c.lab} • ${(c.topics||[]).join(" • ")}`;
  $("#question").textContent = c.stem;

  $("#revealBox").classList.remove("show");
  $("#revealBox").textContent = "";

  answered = false;
  lastChoiceIndex = null;
  clearConfetti();

  renderChoices(c);
  lockChoices(!flipped); // only clickable when flipped
}

function renderCard(){
  updateProgress();
  setCardBackImage();
  setQuestionUI();

  $("#card").classList.toggle("isFlipped", flipped);
}

/* =========================
   Answer handling
   ========================= */
function ensureFlipped(){
  if(!deck.length){ say("Pick labs/topics first."); return false; }
  if(!flipped){ say("Flip the card first."); return false; }
  return true;
}

function chooseAnswer(choiceIndex){
  const c = currentCard();
  if(!c) return;
  if(!ensureFlipped()) return;
  if(answered) return;

  answered = true;
  lastChoiceIndex = choiceIndex;

  const correct = choiceIndex === c.answerIndex;

  if(correct){
    say("Correct.");
    markChoices(c, choiceIndex, false);
    confettiAroundChoices();
  }else{
    say("Not quite.");
    markChoices(c, choiceIndex, false);
  }

  lockChoices(true);
}

function revealAnswer(){
  const c = currentCard();
  if(!c) return;
  if(!ensureFlipped()) return;

  // show correct highlighting
  markChoices(c, lastChoiceIndex, true);
  lockChoices(true);

  const expl = c.explanation ? `<div style="margin-top:6px; opacity:.95">${c.explanation}</div>` : "";
  $("#revealBox").innerHTML = `<strong>Correct answer:</strong> ${c.options[c.answerIndex] || "—"}${expl}`;
  $("#revealBox").classList.add("show");
}

function nextCard(){
  if(!deck.length) return;
  idx = (idx + 1) % deck.length;

  // new card => new random image, start on image side
  flipped = false;
  answered = false;
  lastChoiceIndex = null;
  renderCard();
  say("Next");
}

/* =========================
   Modal (labs/topics picker)
   ========================= */
const modal = $("#pickerModal");

function openModal(step="labs"){
  modal.classList.add("show");
  $("#stepLabs").style.display = (step==="labs") ? "block" : "none";
  $("#stepTopics").style.display = (step==="topics") ? "block" : "none";
}
function closeModal(){ modal.classList.remove("show"); }

function renderLabChips(){
  const host = $("#labChips");
  host.innerHTML = "";
  ALL_LABS.forEach(n=>{
    const label = document.createElement("label");
    label.className = "chip";
    label.innerHTML = `<input type="checkbox" value="${n}">Lab ${n}`;
    const cb = label.querySelector("input");
    cb.checked = selectedLabs.has(n);
    host.appendChild(label);
  });
}

function renderTopicChips(){
  const host = $("#topicChips");
  host.innerHTML = "";

  const topics = topicsInLabs(selectedLabs);
  if(!topics.length){
    const p=document.createElement("div");
    p.style.color="rgba(155,182,211,.9)";
    p.style.fontWeight="900";
    p.textContent = "No topics found for those labs (check CARD_BANK topics).";
    host.appendChild(p);
    return;
  }

  // default: select all topics for those labs
  if(selectedTopics.size === 0){
    topics.forEach(t=>selectedTopics.add(t));
  }

  topics.forEach(t=>{
    const label = document.createElement("label");
    label.className = "chip";
    label.innerHTML = `<input type="checkbox" value="${t}">${t}`;
    label.querySelector("input").checked = selectedTopics.has(t);
    host.appendChild(label);
  });
}

function applyLabsFromModal(){
  const cbs = [...$("#labChips").querySelectorAll("input[type=checkbox]:checked")];
  const labs = cbs.map(cb=>parseInt(cb.value,10)).filter(n=>Number.isFinite(n));
  if(!labs.length){ say("Pick at least one lab."); return false; }
  selectedLabs = new Set(labs);
  selectedTopics = new Set(); // rebuild topic set for chosen labs
  return true;
}

function applyTopicsFromModal(){
  const cbs = [...$("#topicChips").querySelectorAll("input[type=checkbox]:checked")];
  const topics = cbs.map(cb=>cb.value).filter(Boolean);
  if(!topics.length){ say("Pick at least one topic (or Select all)."); return false; }
  selectedTopics = new Set(topics);
  return true;
}

function startWithSelections(){
  deck = buildDeck();
  idx = 0;
  flipped = false;
  answered = false;
  lastChoiceIndex = null;

  renderCard();

  if(deck.length){
    const labsTxt = [...selectedLabs].sort((a,b)=>a-b).join(", ");
    const topicsTxt = [...selectedTopics].sort((a,b)=>a.localeCompare(b)).join(", ");
    $("#statusLine").textContent = `Studying labs: ${labsTxt}. Topics: ${topicsTxt}.`;
    say(`Loaded ${deck.length} cards.`);
  }else{
    $("#statusLine").textContent = "No cards match that selection. Add MCQs for those labs/topics in CARD_BANK.";
    say("No matching cards.");
  }
}

/* =========================
   Events
   ========================= */
$("#changeBtn").addEventListener("click", ()=>{ renderLabChips(); openModal("labs"); });

$("#shuffleBtn").addEventListener("click", ()=>{
  if(!deck.length){ say("Pick labs/topics first."); return; }
  deck = shuffle(deck);
  idx = 0;
  flipped = false;
  answered = false;
  lastChoiceIndex = null;
  renderCard();
  say("Shuffled");
});

$("#resetBtn").addEventListener("click", ()=>{
  if(!deck.length){ say("Pick labs/topics first."); return; }
  idx = 0;
  flipped = false;
  answered = false;
  lastChoiceIndex = null;
  renderCard();
  say("Reset");
});

$("#card").addEventListener("click", ()=>{
  if(!deck.length){ say("Pick labs/topics first."); return; }
  if(flipped) return; // prevent accidental flip back once on MCQ side
  flipped = true;
  // enable choices now that flipped
  renderCard();
  // unlock choices (renderCard locks if not flipped)
  lockChoices(false);
});

$("#card").addEventListener("keydown", (e)=>{
  // Space toggles flip (useful for keyboard users)
  if(e.key === " "){
    e.preventDefault();
    if(!deck.length){ say("Pick labs/topics first."); return; }
    flipped = !flipped;
    answered = false;
    lastChoiceIndex = null;
    renderCard();
    lockChoices(!flipped);
  }

  // 1-6 choose option when flipped
  const n = parseInt(e.key,10);
  if(Number.isFinite(n) && n >= 1 && n <= 6){
    if(flipped){
      const c=currentCard(); if(!c) return;
      if(n-1 < (c.options||[]).length) chooseAnswer(n-1);
    }
  }

  // R reveal, -> next
  if(e.key.toLowerCase() === "r"){ e.preventDefault(); revealAnswer(); }
  if(e.key === "ArrowRight"){ e.preventDefault(); nextCard(); }
});

$("#revealBtn").addEventListener("click", revealAnswer);
$("#nextBtn").addEventListener("click", nextCard);

/* Modal buttons */
$("#labsSelectAll").addEventListener("click", ()=>{
  const allSelected = ALL_LABS.every(n=>$("#labChips input[value='"+n+"']").checked);
  ALL_LABS.forEach(n=>{ $("#labChips input[value='"+n+"']").checked = !allSelected; });
});

$("#toTopics").addEventListener("click", ()=>{
  if(!applyLabsFromModal()) return;
  renderTopicChips();
  openModal("topics");
});

$("#backToLabs").addEventListener("click", ()=>openModal("labs"));

$("#topicsSelectAll").addEventListener("click", ()=>{
  const inputs = [...$("#topicChips").querySelectorAll("input[type=checkbox]")];
  const allSelected = inputs.length && inputs.every(x=>x.checked);
  inputs.forEach(x=>x.checked = !allSelected);
});

$("#startBtn").addEventListener("click", ()=>{
  if(!applyTopicsFromModal()) return;
  closeModal();
  startWithSelections();
});

/* =========================
   Init
   ========================= */
(async function init(){
  $("#statusLine").textContent = "Loading images…";
  await loadManifest();
  renderLabChips();
  openModal("labs");

  deck = [];
  idx = 0;
  flipped = false;
  renderCard();
})();
</script>
</body>
</html>
